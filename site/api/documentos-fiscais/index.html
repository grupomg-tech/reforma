<html lang="pt-br"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="5irda87WcbzR0TEIV1m63ofqSNhAPSZ0OYR0KhsWtLKWTkwO8NAUUODbsaoVgiFB">
    <link rel="icon" type="image/x-icon" href="/static/images/favicon.ico">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <style>
        :root {
            --primary-color: #8C40F0;
            --secondary-color: #FF8C40;
            --dark-color: #000000;
        }

        body {
            background-color: #f8f9fa;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
        }

        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            background: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            z-index: 1050;
            width: 250px;
        }

        .sidebar.collapsed {
            width: 70px;
        }

        .sidebar-header {
            padding: 1rem;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 70px;
        }

        .sidebar-header .app-version {
            font-size: 0.75rem;
            color: #aaa;
            margin-left: 8px;
            font-weight: 500;
        }

        .sidebar.collapsed .app-version {
            display: none;
        }
        .sidebar:not(.collapsed) .app-version {
            display: inline;
        }

        .logo-full {
            height: 75px;
            transition: opacity 0.3s ease;
        }

        .logo-mini {
            width: 30px;
            height: 30px;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .sidebar.collapsed .logo-full {
            display: none;
        }

        .sidebar.collapsed .logo-mini {
            display: flex;
        }

        .toggle-btn {
            background: none;
            border: none;
            color: var(--primary-color);
            font-size: 18px;
            padding: 2px;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .toggle-btn:hover {
            background-color: #f8f9fa;
        }

        .sidebar-menu {
            padding: 1rem 0;
            height: calc(100vh - 140px);
            overflow-y: auto;
        }

        .menu-item {
            margin-bottom: 4px;
            font-size: 0.9rem;
        }

        .menu-link {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            color: #374151;
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
            position: relative;
        }

        .menu-link:hover {
            background-color: #f8f9fa;
            color: var(--primary-color);
        }

        .menu-link.active {
            background-color: rgba(140, 64, 240, 0.1);
            color: var(--primary-color);
            border-left-color: var(--primary-color);
        }

        .menu-icon {
            font-size: 18px;
            width: 24px;
            text-align: center;
        }

        .menu-text {
            margin-left: 12px;
            font-weight: 500;
            transition: opacity 0.3s ease;
        }

        .menu-arrow {
            margin-left: auto;
            transition: transform 0.3s ease;
        }

        .menu-arrow.rotated {
            transform: rotate(180deg);
        }

        .sidebar.collapsed .menu-text,
        .sidebar.collapsed .menu-arrow {
            opacity: 0;
            width: 0;
            margin: 0;
        }

        .submenu {
            background-color: #f8f9fa;
            border-left: 2px solid var(--primary-color);
            margin-left: 20px;
            display: none;
        }

        .submenu.show {
            display: block;
        }

        .sidebar.collapsed .submenu {
            display: none !important;
        }

        .submenu-link {
            display: flex;
            align-items: center;
            padding: 8px 24px;
            color: #6b7280;
            text-decoration: none;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .submenu-link:hover {
            background-color: white;
            color: #374151;
        }

        .submenu-icon {
            font-size: 14px;
            width: 16px;
            margin-right: 8px;
        }

        .user-section {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            border-top: 1px solid #dee2e6;
            background: white;
        }

        .user-profile {
            display: flex;
            align-items: center;
            padding: 16px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .user-profile:hover {
            background-color: #f8f9fa;
        }

        .user-initial {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: white;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
            border: 1px solid var(--primary-color);
        }

        .user-info {
            margin-left: 12px;
            flex: 1;
            transition: opacity 0.3s ease;
        }

        .user-name {
            font-weight: 600;
            color: #374151;
            font-size: 14px;
            margin: 0;
        }

        .user-email {
            color: #6b7280;
            font-size: 12px;
            margin: 0;
        }

        .sidebar.collapsed .user-info {
            display: none;
        }

        .user-menu {
            position: absolute;
            bottom: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px 8px 0 0;
            box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
            display: none;
        }

        .user-menu.show {
            display: block;
        }

        .user-menu-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            color: #374151;
            text-decoration: none;
            transition: background-color 0.3s ease;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }

        .user-menu-item:hover {
            background-color: #f8f9fa;
        }

        .user-menu-item.danger {
            color: #dc3545;
        }

        .user-menu-item i {
            margin-right: 8px;
            width: 16px;
        }

        .main-content {
            margin-left: 250px;
            transition: margin-left 0.3s ease;
            min-height: 50vh;
        }

        .main-content.expanded {
            margin-left: 70px;
        }

        .content-wrapper {
            padding: 0.5rem;
        }

        .stats-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .stats-card:hover {
            transform: translateY(-2px);
        }

        .stats-card.purple {
            background: linear-gradient(135deg, var(--primary-color), #7C3AED);
            color: white;
        }

        .stats-card.orange {
            background: linear-gradient(135deg, var(--secondary-color), #F97316);
            color: white;
        }

        .stats-card.dark {
            background: linear-gradient(135deg, #374151, var(--dark-color));
            color: white;
        }

        .stats-icon {
            font-size: 48px;
            opacity: 0.8;
        }

        .stats-number {
            font-size: 32px;
            font-weight: bold;
            margin: 8px 0;
        }

        .stats-label {
            font-size: 16px;
            opacity: 0.9;
        }

        .btn-secondary-custom {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
            color: white;
        }

        .btn-secondary-custom:hover {
            background-color: #F97316;
            border-color: #F97316;
        }

        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(140, 64, 240, 0.25);
        }

        .password-toggle {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #6b7280;
            cursor: pointer;
        }

        .password-field {
            position: relative;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.show {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .mobile-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                z-index: 1040;
                display: none;
            }
            
            .mobile-overlay.show {
                display: block;
            }
        }

        /* Scrollbar customization */
        .sidebar-menu::-webkit-scrollbar {
            width: 4px;
        }

        .sidebar-menu::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .sidebar-menu::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 2px;
        }
    </style>
    
</head>
<body class="bg-light">
    <!-- Mobile Overlay -->
    <div class="mobile-overlay" id="mobileOverlay"></div>

    <!-- Sidebar -->
    <nav class="sidebar" id="sidebar">
        <!-- Header -->
        <div class="sidebar-header">
            <div class="d-flex align-items-center">
                <img src="/static/images/logo_completa.png" class="logo-full">
                <img src="/static/images/logo.png" class="logo-mini">
                <span class="app-version ms-2">v1.0.0</span>
            </div>
            <button class="toggle-btn" id="toggleSidebar">
                <i class="bi bi-chevron-left" id="toggleIcon"></i>
            </button>
        </div>

        <!-- Menu -->
        <div class="sidebar-menu">
            <!-- Dashboards -->
            <div class="menu-item">
                <a href="#" class="menu-link active" data-toggle="dashboards">
                    <i class="bi bi-speedometer2 menu-icon"></i>
                    <span class="menu-text">Dashboards</span>
                    <i class="bi bi-chevron-down menu-arrow"></i>
                </a>
                <div class="submenu" id="dashboards-submenu">
                    <a href="/dashboards/" class="submenu-link">
                        <i class="bi bi-house submenu-icon"></i>
                        Dashboard Principal
                    </a>
                </div>
            </div>

            <!-- Arquivos SPEDs -->
            <div class="menu-item">
                <a href="#" class="menu-link" data-toggle="speds">
                    <i class="bi bi-file-earmark-code menu-icon"></i>
                    <span class="menu-text">SPEDs</span>
                    <i class="bi bi-chevron-down menu-arrow"></i>
                </a>
                <div class="submenu" id="speds-submenu">
                    <a href="/importar-sped/" class="submenu-link">
                        <i class="bi bi-upload submenu-icon"></i>
                        Importar SPED
                    </a>
                    <a href="/exportar-sped/" class="submenu-link">
                        <i class="bi bi-download submenu-icon"></i>
                        Gerar SPED
                    </a>
                    <a href="/excluir-sped/" class="submenu-link">
                        <i class="bi bi-trash submenu-icon"></i>
                        Excluir SPED
                    </a>
                    <a href="/importar-xmls/" class="submenu-link">
                        <i class="bi bi-filetype-xml submenu-icon"></i>
                        Importar XMLs
                    </a>
                </div>
            </div>

            <!-- Notas Fiscais -->
            <div class="menu-item">
                <a href="#" class="menu-link" data-toggle="notas">
                    <i class="bi bi-receipt menu-icon"></i>
                    <span class="menu-text">Notas Fiscais</span>
                    <i class="bi bi-chevron-down menu-arrow"></i>
                </a>
                <div class="submenu" id="notas-submenu">
                    <a href="/api/documentos-fiscais/" class="submenu-link">
                        <i class="bi bi-search submenu-icon"></i>
                        Gerenciamento de Documentos
                    </a>
                </div>
            </div>

            <!-- Reforma Tributária -->
            <div class="menu-item">
                <a href="#" class="menu-link" data-toggle="reforma">
                    <i class="bi bi-shield-fill-check menu-icon"></i>
                    <span class="menu-text">Reforma Tributária</span>
                    <i class="bi bi-chevron-down menu-arrow"></i>
                </a>
                <div class="submenu" id="reforma-submenu">
                    <a href="/reforma-tributaria/consulta-gtin/" class="submenu-link">
                        <i class="bi bi-clipboard2-check-fill submenu-icon"></i>
                        GTIN X NCM
                    </a>
                    <a href="/em-desenvolvimento/" class="submenu-link">
                        <i class="bi bi-robot submenu-icon"></i>
                        NCM Inteligente
                    </a>
                    <a href="/reforma-tributaria/consulta/" class="submenu-link">
                        <i class="bi bi-card-checklist submenu-icon"></i>
                        NCM X cClassTrib
                    </a>
                    <a href="/dashboards/relatorio-fiscal/" class="submenu-link">
                        <i class="bi bi-speedometer2 submenu-icon"></i>
                        Relatórios
                    </a>
                </div>
            </div>

            <!-- Configurações -->
            <div class="menu-item">
                <a href="#" class="menu-link" data-toggle="config">
                    <i class="bi bi-gear menu-icon"></i>
                    <span class="menu-text">Configurações</span>
                    <i class="bi bi-chevron-down menu-arrow"></i>
                </a>
                <div class="submenu" id="config-submenu">
                    <a href="/empresa/" class="submenu-link">
                        <i class="bi bi-building submenu-icon"></i>
                        Empresas
                    </a>
                    <a href="/accounts/" class="submenu-link">
                        <i class="bi bi-people submenu-icon"></i>
                        Usuários
                    </a>
                    <a href="/utilitarios/" class="submenu-link">
                        <i class="bi bi-sliders submenu-icon"></i>
                        Logs
                    </a>
                </div>
            </div>

            <!-- Suporte -->
            <div class="menu-item">
                <a href="#" class="menu-link" data-toggle="suporte">
                    <i class="bi bi-headset menu-icon"></i>
                    <span class="menu-text">Suporte</span>
                    <i class="bi bi-chevron-down menu-arrow"></i>
                </a>
                <div class="submenu" id="suporte-submenu">
                    <a href="https://wa.link/6bqejl" class="submenu-link" target="_blank" rel="noopener noreferrer">
                        <i class="bi bi-telephone submenu-icon"></i>
                        WhatsApp
                    </a>
                </div>
            </div>
        </div>

        <!-- User Section -->
        <div class="user-section">
            <div class="user-menu" id="userMenu">
                <button class="user-menu-item" data-bs-toggle="modal" data-bs-target="#profileModal">
                    <i class="bi bi-person-gear"></i>
                    Editar Perfil
                </button>
                <form method="POST" action="/accounts/logout/" style="margin: 0;">
                    <input type="hidden" name="csrfmiddlewaretoken" value="5irda87WcbzR0TEIV1m63ofqSNhAPSZ0OYR0KhsWtLKWTkwO8NAUUODbsaoVgiFB">
                    <button type="submit" class="user-menu-item danger" onclick="return confirm('Tem certeza que deseja sair?')">
                        <i class="bi bi-box-arrow-right"></i>
                        Sair
                    </button>
                </form>
            </div>
            <div class="user-profile" id="userProfile">
                <div class="user-initial">P</div>
                <div class="user-info">
                    <p class="user-name">Planejamento </p>
                    <p class="user-email">planejamentotributario@grupomgbr.com</p>
                </div>
                <i class="bi bi-three-dots-vertical text-muted"></i>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content" id="mainContent">
        <div class="content-wrapper">
            <!-- Messages -->
            <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1100">
                
            </div>

            <!-- Content Block -->
            



    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ContPRO - Documentos</title>
    <style>
        /* Estilos anteriores mantidos */
        .table-container {
            overflow-x: auto !important;
            overflow-y: auto !important;
            max-width: 100%;
            min-height: 65vh;
            max-height: 65vh;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            white-space: nowrap;
        }

        .table-container table {
            min-width: 100% !important;
            width: auto !important;
            table-layout: auto !important;
            margin-bottom: 0 !important;
        }

        .table th {
            white-space: nowrap !important;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 0.25rem 0.5rem; /* Reduzido de 0.5rem 0.75rem */
            vertical-align: middle;
            font-size: 0.9rem; /* Reduzido de 0.8rem */
            height: 40px !important; /* Adiciona altura fixa */
            line-height: 1.2; /* Adiciona controle de altura da linha */
            border-right: 1px solid #ffffff;
            position: sticky;
            top: 0; /* Fixa no topo */
            z-index: 2; /* Garante que o cabeçalho fique acima do conteúdo */
        }

        .table td {
            white-space: nowrap !important;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 0.25rem 0.5rem; /* Reduzido de 0.5rem 0.75rem */
            vertical-align: middle;
            font-size: 0.75rem; /* Reduzido de 0.8rem */
            max-height: 25px !important; /* Alterado de 35px */
            height: 25px !important; /* Adiciona altura fixa */
            line-height: 1.2; /* Adiciona controle de altura da linha */
            border-right: 1px solid #dee2e6;
        }

        /* Remove a borda da última coluna para não ficar duplicada */
        .table th:last-child, .table td:last-child {
            border-right: none;
        }

        .form-label {
            font-size: 0.9rem !important;
        }
        
        .table th.col-checkbox, 
        .table td.col-checkbox {
            min-width: 40px !important;
            max-width: 40px !important;
            text-align: center;
            position: sticky;
            left: 0;
            background-color: inherit;
            z-index: 10;
        }

        .table thead th.col-checkbox {
            background-color: #495057;
            z-index: 30 !important;
        }
        
        .table th.col-chave, .table td.col-chave {
            max-width: 310px !important;
            text-align: center;
        }
        
        .table th.col-numero, .table td.col-numero {
            min-width: 50px !important;
            max-width: 150px !important;
            text-align: center;
        }
        
        .table th.col-data, .table td.col-data {
            min-width: 110px !important;
            max-width: 110px !important;
            text-align: center;
        }
        
        .table th.col-nome, .table td.col-nome {
            min-width: 80px !important;
            max-width: 200px !important;
            text-align: center;
        }

        .table th.col-conferencia, .table td.col-conferencia {
            min-width: 80px !important;
            max-width: 200px !important;
            text-align: center;
        }
        
        .table th.col-valor, .table td.col-valor {
            min-width: 120px !important;
            max-width: 140px !important;
            text-align: center;
        }
        
        .table th.col-uf, .table td.col-uf {
            min-width: 60px !important;
            max-width: 60px !important;
            text-align: center;
        }
        
        .table th.col-status, .table td.col-status {
            min-width: 100px !important;
            max-width: 100px !important;
            text-align: center;
        }

        /* Permitir que a célula de ações tenha overflow visível */
        .table td.col-acoes {
            overflow: visible !important;
        }

        /* Estilos ajustados para a coluna de ações com dropdown */
        .table th.col-acoes, .table td.col-acoes {
            min-width: 50px !important;
            max-width: 50px !important;
            text-align: center;
            position: sticky;
            right: 0;
            background-color: inherit;
            padding: 0.25rem !important;
        }

        /* Estilos do dropdown de ações */
        .dropdown-acoes {
            display: inline-block;
        }

        .btn-acoes-dropdown {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            border-radius: 0.25rem;
            background: linear-gradient(135deg, #8C40F0 0%, #FF8C40 100%);
            border: none;
            color: white;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            white-space: nowrap;
        }

        .btn-acoes-dropdown:hover {
            background: linear-gradient(135deg, #7a38d8 0%, #e67a38 100%);
            color: white;
        }

        .btn-acoes-dropdown:focus {
            box-shadow: 0 0 0 0.2rem rgba(140, 64, 240, 0.3);
        }

        .dropdown-menu-acoes {
            min-width: 180px;
            font-size: 0.875rem;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .dropdown-item-acoes {
            padding: 0.5rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }

        .dropdown-item-acoes:hover {
            background-color: #f8f9fa;
            transform: translateX(3px);
        }

        .dropdown-item-acoes i {
            width: 16px;
            text-align: center;
        }

        .dropdown-item-acoes.text-success:hover {
            background-color: #d5f4e6;
        }

        .dropdown-item-acoes.text-danger:hover {
            background-color: #fadbd8;
        }

        .dropdown-item-acoes.text-primary:hover {
            background-color: #e3f2fd;
        }

        .dropdown-item-acoes.text-info:hover {
            background-color: #d1ecf1;
        }

        .dropdown-divider {
            margin: 0.25rem 0;
        }

        .table-container::after {
            position: absolute;
            bottom: -25px;
            right: 10px;
            font-size: 0.75rem;
            color: #6c757d;
            font-style: italic;
            opacity: 0.7;
        }

        @media (max-width: 768px) {
           .table-container {
                margin: 0 -15px;
                border-radius: 0;
            }
            
            .table th, .table td {
                font-size: 0.7rem; /* Reduzido de 0.8rem */
                padding: 0.2rem 0.4rem; /* Reduzido de 0.4rem 0.5rem */
                height: 30px !important;
            }

            .table-container table {
                min-width: 800px !important;
            }
        }

        .badge { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 500; }
        .badge.success { background: #d5f4e6; color: #27ae60; }
        .badge.danger { background: #fadbd8; color: #e74c3c; }
        .badge.warning { background: #fff3cd; color: #856404; }
        .badge.info { background: #d1ecf1; color: #0c5460; }
        .badge.secondary { background: #e9ecef; color: #495057; }
        
        .card-header {
            background: linear-gradient(135deg, #8C40F0 0%, #FF8C40 100%);
            color: white;
        }
        
        .btn-details {
            padding: 0.25rem 0.5rem;
            font-size: 0.7rem;
            background-color: #ffffff;
            color: #8C40F0;
            border: 1px solid #6c757d;
        }

        .btn-primary {
            background: linear-gradient(135deg, #8C40F0 0%, #FF8C40 100%);
            color: white;
            border: #c5c5c5 1px solid;
        }

        .btn-secondary {
            background-color: #ffffff;
            border: #c5c5c5 1px solid;
            color: rgb(0, 0, 0);
        }

        .btn-danger {
            background-color: white;
            color: red;
            border: red 1px solid;
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
        }
        
        .filters-card {
            margin-bottom: 1rem;
        }
        
        .btn-config {
            position: relative;
        }
        
        .config-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #dc3545;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .column-config-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .form-check {
            margin-bottom: 0.5rem;
        }
        
        .cell-tooltip {
            cursor: help;
        }

        .nav-tabs .nav-link {
            background-color: #ffffff;
            color: #b9b9b9;
            border-color: #ebebeb;
        }

        .nav-tabs .nav-link.active {
            background: linear-gradient(150deg, #8C40F0 0%, #FF8C40 100%);
            color: #ffffff;
            border-color: #ebebeb;
        }

         .nav-tabs .nav-link:disabled {
            background-color: #ffffff;
            color: #b9b9b9;
            border-color: #ebebeb;
        }

        .column-config {
            max-height: 300px;
            overflow-y: auto;
        }

        .table thead th {
            background-color: #ffffff !important;
            color: rgb(0, 0, 0) !important;
            border-color: #ebebeb !important;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .table-striped > tbody > tr:nth-of-type(odd) > td {
            background-color: rgba(255, 255, 255, 0.02);
        }

        .table-hover > tbody > tr:hover > td {
            background-color: rgba(140, 64, 240, 0.1);
        }

        /* Estilos para seleção em lote */
        .selection-toolbar {
            background-color: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 0.375rem;
            padding: 0.75rem;
            margin-bottom: 1rem;
            display: none;
        }

        .selection-toolbar.show {
            display: block;
        }

        .btn-xml-lote {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            border: none;
            color: white;
        }

        .btn-xml-lote:hover {
            background: linear-gradient(135deg, #45a049 0%, #3d8b40 100%);
            color: white;
        }

        .btn-danfe-lote {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            border: none;
            color: white;
        }

        .btn-danfe-lote:hover {
            background: linear-gradient(135deg, #45a049 0%, #3d8b40 100%);
            color: white;
        }

        #modalManifestacao .modal-header {
            background: linear-gradient(135deg, #8C40F0 0%, #FF8C40 100%) !important;
            max-height: 50px !important;
            color: white;
        }
        
        #modalManifestacao .form-label {
            color: #495057;
            margin-bottom: 0.5rem;
        }
        
        #modalManifestacao .form-select:focus,
        #modalManifestacao .form-control:focus {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
        }
        
        #justificativaContainer.show {
            animation: slideDown 0.3s ease-in-out;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .alert-info {
            background-color: #e7f3ff;
            border-color: #b6d4fe;
            color: #084298;
        }

        /* LOGS DE CONSULTAS */
        /* Container da tabela com altura fixa e scroll */
        .table-scroll-container {
            max-height: 450px; /* Ajuste conforme necessário */
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
        }

        /* Fixa o cabeçalho no topo durante o scroll */
        .table-scroll-container thead {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: #212529;
        }

        /* Garante que as células do thead fiquem alinhadas */
        .table-scroll-container thead th {
            border-bottom: 2px solid #dee2e6;
        }

        /* Remove a borda superior da primeira linha do tbody */
        .table-scroll-container tbody tr:first-child td {
            border-top: none;
        }

        /* DETALHES DA NOTA */
        .modal-body-scroll {
            max-height: 70vh; /* 70% da altura da viewport */
            overflow-y: auto;
            overflow-x: hidden;
        }

        /* Scroll bar customizada (opcional) */
        .modal-body-scroll::-webkit-scrollbar {
            width: 8px;
        }

        .modal-body-scroll::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .modal-body-scroll::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }

        .modal-body-scroll::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Ajustes para tabelas dentro do modal */
        .modal-body-scroll .table-responsive {
            max-height: 300px;
            overflow-y: auto;
        }

        .modal-body-scroll .table-responsive::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        /* Header do modal com fundo escuro */
        .modal-header {
            background: linear-gradient(135deg, #8C40F0 0%, #FF8C40 100%) !important;
            max-height: 50px !important;
            color: white;
        }

        .modal-header .modal-title {
            color: white;
        }

        /* Padding interno do conteúdo */
        #modalDetalhesContent {
            padding: 1rem;
        }

        #modalImportarXML .modal-body {
        max-height: 75vh;
        overflow-y: auto;
        }
        #modalImportarXML .form-label {
        font-weight: 500;
        }
        #modalImportarXML .border.rounded {
        background-color: #fff;
        }
        .btn-loading {
        position: relative;
        pointer-events: none;
        }
        .btn-loading::after {
        content: "";
        position: absolute;
        width: 16px;
        height: 16px;
        top: 50%;
        left: 50%;
        margin-left: -8px;
        margin-top: -8px;
        border: 2px solid #fff;
        border-radius: 50%;
        border-top-color: transparent;
        animation: spin 1s linear infinite;
        }
        @keyframes spin {
        to { transform: rotate(360deg); }
        }
        .btn-loading .btn-text {
        opacity: 0;
        }

        /* Estilo para o textarea de chaves */
        #chavesAcesso {
            font-size: 0.85rem;
            line-height: 1.5;
        }

        #chavesAcesso::placeholder {
            font-size: 0.8rem;
            color: #999;
        }

        /* Contador de chaves */
        #contagemChaves {
            font-weight: 500;
            color: #0d6efd;
        }

        /* Botão consultar por chave quando desabilitado */
        #btnConsultarChave:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Estilo para o botão de busca manual */
        #btnBuscaManual:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        #btnBuscaManual .fa-spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Animação para o contador regressivo */
        #tempoRestanteDisplay {
            transition: all 0.3s ease;
        }

        /* Card de tempo restante */
        .modal-body .card.bg-success {
            animation: pulse 0.5s ease-in-out;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

    </style>


    <div class="container-fluid py-0">
        <div class="row">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-header">
                        <div class="row align-items-center">
                            <div class="col">
                                <h4 class="mb-0">
                                    <i class="fas fa-file-invoice me-2"></i>
                                    Documentos Fiscais Eletrônicos
                                </h4>
                            </div>
                            <div class="col-auto">
                                <button class="btn btn-light btn-sm" title="Configurar Colunas" onclick="abrirConfigColunas()">
                                    <i class="fas fa-cog"></i>
                                </button>
                                <button class="btn btn-light btn-sm" title="Log de Consultas" onclick="abrirModalLogs()">
                                    <i class="fas fa-info-circle"></i>
                                </button>
                                <button type="button" class="btn btn-success btn-sm" id="btnBuscaManual" onclick="verificarEIniciarBuscaManual()" disabled="" title="Selecione uma empresa primeiro">
                                    <i class="fas fa-sync-alt me-1"></i>
                                    Busca Manual
                                </button>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-light btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="fas fa-file-excel me-1"></i> Exportar
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end">
                                        <li>
                                            <a class="dropdown-item" href="#" onclick="exportarExcel('page'); return false;">
                                                <i class="fas fa-file-excel me-2"></i> Página Atual
                                            </a>
                                        </li>
                                        <li>
                                            <a class="dropdown-item" href="#" onclick="exportarExcel('all'); return false;">
                                                <i class="fas fa-file-export me-2"></i>Todos os Registros
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                                <button type="button" class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#modalImportarXML">
                                    <i class="fas fa-cloud-upload me-1"></i> Importar XML
                                </button>
                                <button class="btn btn-light btn-sm" onclick="refreshTable()">
                                    <i class="fas fa-sync-alt me-1"></i>
                                    Atualizar
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-body p-0">
                        <!-- Barra de ferramentas para seleção em lote -->
                        <div class="selection-toolbar" id="selectionToolbar">
                            <div class="row align-items-center">
                                <div class="col">
                                    <span class="fw-bold">
                                        <i class="fas fa-check-square me-2"></i>
                                        <span id="contadorSelecionados">0</span> documento(s) selecionado(s)
                                    </span>
                                </div>
                                <div class="col-auto">
                                    <button class="btn btn-xml-lote btn-sm" id="btnXMLLote" onclick="baixarXMLLote()">
                                        <i class="fas fa-download me-1"></i>
                                        Baixar XMLs
                                    </button>
                                    <button id="btnDANFELote" onclick="baixarDANFELote()" class="btn btn-danfe-lote btn-sm">
                                        <i class="fas fa-file-pdf me-1"></i> 
                                        Baixar Docs
                                    </button>
                                    <button class="btn btn-outline-success btn-sm" id="btnConferirLote" onclick="marcarConferenciaLote('Conferida')">
                                        <i class="fas fa-check-circle me-1"></i> Marcar Conferido
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm" id="btnDesconferirLote" onclick="marcarConferenciaLote('Não Conferida')">
                                        <i class="fas fa-times-circle me-1"></i> Marcar Não Conferido
                                    </button>
                                     <button class="btn btn-outline-danger btn-sm" id="btnExcluirLote" onclick="abrirModalExclusaoLote()">
                                        <i class="fas fa-trash-alt me-1"></i>
                                        Excluir
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm" title="Limpar Seleção" onclick="limparSelecoes()">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Abas NF-e e CT-e -->
                        <div class="px-0 pt-1"> 
                            <ul class="nav nav-tabs" id="documentTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="nfe-tab" data-bs-toggle="tab" data-bs-target="#nfe" type="button" role="tab" aria-selected="true" tabindex="-1" onclick="trocarTipoDocumento('nfe')">
                                        <i class="fas fa-file-invoice me-2"></i>NF-e/NFC-e
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="cte-tab" data-bs-toggle="tab" data-bs-target="#cte" type="button" role="tab" onclick="trocarTipoDocumento('cte')" aria-selected="false" tabindex="-1">
                                        <i class="fas fa-truck me-2"></i>CT-e
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="nfse-tab" data-bs-toggle="tab" data-bs-target="#nfse" type="button" role="tab" disabled="" aria-selected="false" tabindex="-1">
                                        <i class="fas fa-times me-2"></i>NFS-e
                                    </button>
                                </li>
                                 <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="nfse-tab" data-bs-toggle="tab" data-bs-target="#nfse" type="button" role="tab" disabled="" aria-selected="false" tabindex="-1">
                                        <i class="fas fa-times me-2"></i>MDF-e
                                    </button>
                                </li>
                            </ul>
                        </div>

                        <div class="tab-content" id="documentTabContent">
                            <!-- Aba NF-e -->
                            <div class="tab-pane fade show active" id="nfe" role="tabpanel" aria-labelledby="nfe-tab">
                                <!-- Filtros NF-e -->
                                <div class="p-3 bg-light border-bottom">
                                    <div class="row g-1">
                                         <!-- Filtros fixos -->
                                        <div class="col-md-3">
                                            <label class="form-label">Empresa</label>
                                            <select class="form-select form-select-sm" id="empresaSelecao">
                        <option value="" selected="" disabled="">Selecione uma empresa</option>
                        <option value="todas">Todas</option>
                    <option value="1">00.749.616/0001-60 - RENACOR COMERCIO DE TINTAS LTDA.</option><option value="2">00.749.616/0002-40 - RENACOR COMERCIO DE TINTAS LTDA.</option><option value="3">00.749.616/0004-02 - RENACOR COMERCIO DE TINTAS LTDA.</option><option value="4">00.749.616/0005-93 - RENACOR COMERCIO DE TINTAS LTDA.</option><option value="5">00.749.616/0006-74 - RENACOR COMERCIO DE TINTAS LTDA.</option><option value="6">00.749.616/0007-55 - RENACOR COMERCIO DE TINTAS LTDA.</option><option value="7">00.749.616/0008-36 - RENACOR COMERCIO DE TINTAS LTDA.</option><option value="8">00.749.616/0009-17 - RENACOR COMERCIO DE TINTAS LTDA.</option><option value="9">00.749.616/0010-50 - RENACOR COMERCIO DE TINTAS LTDA.</option><option value="10">00.749.616/0011-31 - RENACOR COMERCIO DE TINTAS LTDA.</option></select>
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label">Data Inicial</label>
                                            <input type="date" class="form-control form-control-sm" id="dataInicial">
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label">Data Final</label>
                                            <input type="date" class="form-control form-control-sm" id="dataFinal">
                                        </div>
                                        <!-- Dropdown de filtros adicionais -->
                                        <div class="col-md-3">
                                            <label class="form-label">Filtros Adicionais</label>
                                            <select id="filtroSelectorNfe" class="form-select form-select-sm">
                <option value="">+ Adicionar Filtro</option>
                <option value="chaveNota">Chave de Acesso</option>
                <option value="emitente">Emitente</option>
                <option value="cnpjEmitente">CNPJ Emitente</option>
                <option value="numeroNota">Número da Nota</option>
                <option value="status">Status</option>
                <option value="modelo">Modelo</option>
                <option value="conferencia">Conferência</option>
                <option value="manifestacao">Manifestação</option>
                <option value="dataRecebimentoSistema">Recebimento no Sistema</option>
            </select>
                                        </div>

                                        <div class="col-md-2">
                                            <label class="form-label">Ações</label>
                                            <div>
                                                <button class="btn btn-primary btn-sm" title="Filtrar" onclick="aplicarFiltros()">
                                                    <i class="fas fa-search"></i>
                                                </button>
                                                <button class="btn btn-secondary btn-sm" title="Limpar" onclick="limparFiltros()">
                                                    <i class="fas fa-eraser"></i>
                                                </button>      
                                                
                                                <!-- NOVO: Botão de consulta por chave -->
                                                <button type="button" class="btn btn-primary btn-sm" id="btnConsultarChave" onclick="abrirModalConsultaChave()" disabled="" title="Selecione uma empresa primeiro">
                                                    <i class="fas fa-key me-1"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Área dos filtros ativos -->
                                    <div id="filtrosAtivosNfe" class="row g-2 mt-2"></div>
                                </div>

                                <div id="alert-area-nfe"></div>
                                
                                <!-- Tabela NF-e -->
                                <div class="position-relative">
                                    <div class="table-container">
                                        <table class="table table-hover table-striped mb-0" id="tabelaNfe">
                                            <thead>
                                                <tr id="headerNfe">
                                                    <!-- Cabeçalhos serão gerados dinamicamente -->
                                                </tr>
                                            </thead>
                                            <tbody id="tabelaNotasNfe">
                <tr>
                    <td colspan="20" class="text-center py-4 text-muted">
                        <i class="fas fa-info-circle fa-2x mb-2"></i><br>
                        Selecione uma empresa para visualizar os documentos.
                    </td>
                </tr>
            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <!-- Aba CT-e -->
                            <div class="tab-pane fade" id="cte" role="tabpanel" aria-labelledby="cte-tab">
                                <!-- Filtros CT-e -->
                                <div class="p-3 bg-light border-bottom">
                                    <div class="row g-1">
                                        <!-- Filtros fixos -->
                                        <div class="col-md-3">
                                            <label class="form-label">Empresa</label>
                                            <select class="form-select form-select-sm" id="empresaSelecaoCte">
                        <option value="" selected="" disabled="">Selecione uma empresa</option>
                        <option value="todas">Todas</option>
                    <option value="1">00.749.616/0001-60 - RENACOR COMERCIO DE TINTAS LTDA.</option><option value="2">00.749.616/0002-40 - RENACOR COMERCIO DE TINTAS LTDA.</option><option value="3">00.749.616/0004-02 - RENACOR COMERCIO DE TINTAS LTDA.</option><option value="4">00.749.616/0005-93 - RENACOR COMERCIO DE TINTAS LTDA.</option><option value="5">00.749.616/0006-74 - RENACOR COMERCIO DE TINTAS LTDA.</option><option value="6">00.749.616/0007-55 - RENACOR COMERCIO DE TINTAS LTDA.</option><option value="7">00.749.616/0008-36 - RENACOR COMERCIO DE TINTAS LTDA.</option><option value="8">00.749.616/0009-17 - RENACOR COMERCIO DE TINTAS LTDA.</option><option value="9">00.749.616/0010-50 - RENACOR COMERCIO DE TINTAS LTDA.</option><option value="10">00.749.616/0011-31 - RENACOR COMERCIO DE TINTAS LTDA.</option></select>
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label">Data Inicial</label>
                                            <input type="date" class="form-control form-control-sm" id="dataInicialCte">
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label">Data Final</label>
                                            <input type="date" class="form-control form-control-sm" id="dataFinalCte">
                                        </div>
                                        <!-- Dropdown de filtros adicionais -->
                                        <div class="col-md-3">
                                            <label class="form-label">Filtros Adicionais</label>
                                            <select id="filtroSelectorCte" class="form-select form-select-sm">
                                                <option value="">+ Adicionar Filtro</option>

                                            </select>
                                        </div>

                                        <div class="col-md-2">
                                            <label class="form-label">Ações</label>
                                            <div>
                                                <button class="btn btn-primary btn-sm" title="Filtrar" onclick="aplicarFiltrosCte()">
                                                    <i class="fas fa-search"></i>
                                                </button>
                                                <button class="btn btn-secondary btn-sm" title="Limpar" onclick="limparFiltrosCte()">
                                                    <i class="fas fa-eraser"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Área dos filtros ativos -->
                                    <div id="filtrosAtivosCte" class="row g-2 mt-2"></div>
                                </div>

                                <div id="alert-area-cte"></div>
                                
                                <!-- Tabela CT-e -->
                                <div class="position-relative">
                                    <div class="table-container">
                                        <table class="table table-hover table-striped mb-0" id="tabelaCte">
                                            <thead>
                                                <tr id="headerCte">
                                                    <!-- Cabeçalhos serão gerados dinamicamente -->
                                                </tr>
                                            </thead>
                                            <tbody id="tabelaNotasCte">
                                                <tr>
                                                    <td colspan="20" class="loading">
                                                        <div class="spinner-border text-primary" role="status">
                                                            <span class="visually-hidden">Carregando...</span>
                                                        </div>
                                                        <p class="mt-2 mb-0">Carregando dados...</p>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Paginação -->
                        <div class="p-3 bg-light border-top">
                            <div class="row align-items-center">
                                <div class="col">
                                    <small class="text-muted">
                                        Mostrando <span id="registrosInfo">0 - 0 de 0</span> registros
                                    </small>
                                </div>
                                <div class="col-auto">
                                    <nav>
                                        <ul class="pagination pagination-sm mb-0" id="paginacao">
                                            <!-- Paginação será gerada dinamicamente -->
                                        </ul>
                                    </nav>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Configuração de Colunas -->
    <div class="modal fade" id="modalConfigColunas" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-cog me-2"></i>
                        Configurar Colunas
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-6">
                            <h6>NF-e</h6>
                            <div class="column-config" id="configColunasNfe">
                                <!-- Checkboxes das colunas NF-e -->
                            </div>
                        </div>
                        <div class="col-6">
                            <h6>CT-e</h6>
                            <div class="column-config" id="configColunasCte">
                                <!-- Checkboxes das colunas CT-e -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="salvarConfigColunas()">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Logs de Consultas -->
    <div class="modal fade" id="modalLogs" tabindex="-1" aria-labelledby="modalLogsLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalLogsLabel">
                        <i class="fas fa-clipboard-list me-2"></i>
                        Logs de Consultas
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                
                <div class="modal-body">
                    <!-- Filtros -->
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <label class="form-label">Empresa/Certificado</label>
                                    <select class="form-select form-select-sm" id="filtroEmpresaLog">
                        <option value="" selected="" disabled="">Selecione uma empresa</option>
                        <option value="todas">Todas</option>
                    <option value="1">00.749.616/0001-60 - RENACOR COMERCIO DE TINTAS LTDA.</option><option value="2">00.749.616/0002-40 - RENACOR COMERCIO DE TINTAS LTDA.</option><option value="3">00.749.616/0004-02 - RENACOR COMERCIO DE TINTAS LTDA.</option><option value="4">00.749.616/0005-93 - RENACOR COMERCIO DE TINTAS LTDA.</option><option value="5">00.749.616/0006-74 - RENACOR COMERCIO DE TINTAS LTDA.</option><option value="6">00.749.616/0007-55 - RENACOR COMERCIO DE TINTAS LTDA.</option><option value="7">00.749.616/0008-36 - RENACOR COMERCIO DE TINTAS LTDA.</option><option value="8">00.749.616/0009-17 - RENACOR COMERCIO DE TINTAS LTDA.</option><option value="9">00.749.616/0010-50 - RENACOR COMERCIO DE TINTAS LTDA.</option><option value="10">00.749.616/0011-31 - RENACOR COMERCIO DE TINTAS LTDA.</option></select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Tipo Nota</label>
                                    <select class="form-select form-select-sm" id="filtroTipoNotaLog">
                                        <option value="">Todos</option>
                                        <option value="1">NF-e</option>
                                        <option value="3">CT-e</option>
                                    </select>
                                </div>
                                <!-- <div class="col-md-2">
                                    <label class="form-label">Tipo Busca</label>
                                    <select class="form-select form-select-sm" id="filtroTipoBuscaLog">
                                        <option value="">Todos</option>
                                    </select>
                                </div> -->
                                <div class="col-md-2">
                                    <label class="form-label">Status</label>
                                    <select class="form-select form-select-sm" id="filtroStatusLog">
                                        <option value="">Todos</option>
                                        <option value="2">Sucesso</option>
                                        <option value="3">Erro</option>
                                        <option value="1">Informação</option>
                                        <option value="4">Advertência</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Data Inicial</label>
                                    <input type="date" class="form-control form-control-sm" id="filtroDataInicialLog">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Data Final</label>
                                    <input type="date" class="form-control form-control-sm" id="filtroDataFinalLog">
                                </div>
                                <div class="col-md-1 d-flex align-items-end">
                                    <button class="btn btn-primary btn-sm me-1" title="Filtrar" onclick="aplicarFiltrosLogs()">
                                        <i class="fas fa-search"></i>
                                    </button>
                                    <button class="btn btn-secondary btn-sm" title="Limpar Filtros" onclick="limparFiltrosLogs()">
                                        <i class="fas fa-eraser"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tabela de Logs -->
                    <div class="table-scroll-container">
                        <table class="table table-hover table-striped mb-0">
                            <thead class="table-dark">
                                <tr>
                                    <th style="width: 200px;" class="text-center">Empresa</th>
                                    <th style="width: 100px;" class="text-center">Tipo Nota</th>
                                    <th style="width: 120px;" class="text-center">Tipo Busca</th>
                                    <th style="width: 150px;" class="text-center">Data Retorno</th>
                                    <th style="width: 100px;" class="text-center">Status</th>
                                    <th style="width: 200px;">Retorno</th>
                                    <th style="width: 150px;" class="text-center">Próxima Consulta</th>
                                </tr>
                            </thead>
                            <tbody id="tabelaLogs">
                                <tr>
                                    <td colspan="7" class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Carregando...</span>
                                        </div>
                                        <p class="mt-2 mb-0">Carregando logs...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Paginação -->
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <small class="text-muted">
                            Mostrando <span id="registrosInfoLog">0 - 0 de 0</span> registros
                        </small>
                        <nav>
                            <ul class="pagination pagination-sm mb-0" id="paginacaoLogs">
                            </ul>
                        </nav>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Detalhes -->
    <div class="modal fade" id="modalDetalhes" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-info-circle me-2"></i>
                        Detalhes da Nota Fiscal
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body modal-body-scroll" id="modalDetalhesContent">
                    <!-- Conteúdo será carregado aqui -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Manifestação -->
    <div class="modal fade" id="modalManifestacao" tabindex="-1" aria-labelledby="modalManifestacaoLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <!-- Cabeçalho do Modal -->
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalManifestacaoLabel">
                        <i class="fas fa-file-invoice me-2"></i>Manifestação de NF-e
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <!-- Formulário -->
                <form id="formManifestacao" method="POST" action="/manifestar-nfe/">
                    <input type="hidden" name="csrfmiddlewaretoken" value="5irda87WcbzR0TEIV1m63ofqSNhAPSZ0OYR0KhsWtLKWTkwO8NAUUODbsaoVgiFB">
                    <input type="hidden" name="chave_nfe" id="chaveNfe" value="">
                    
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="chaveDisplay" class="form-label fw-bold">Chave</label>
                            <input type="text" class="form-control bg-light" id="chaveDisplay" readonly="">
                        </div>

                        <div class="mb-3">
                            <label for="operacao" class="form-label fw-bold">
                                Tipo de Manifestação <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="operacao" name="operacao" required="">
                                <!-- Opções de manifestação -->
                            </select>
                            <div class="form-text">
                                <small>
                                    <i class="fas fa-info-circle"></i> Selecione o tipo de manifestação do destinatário
                                </small>
                            </div>
                        </div>

                        <div class="mb-3" id="justificativaContainer" style="display: none;">
                            <label for="justificativa" class="form-label fw-bold">
                                Justificativa <span class="text-danger">*</span>
                            </label>
                            <textarea class="form-control" id="justificativa" name="justificativa" rows="4" maxlength="255" placeholder="Informe a justificativa (mínimo 15 caracteres)"></textarea>
                            <div class="form-text">
                                <small>
                                    <i class="fas fa-exclamation-triangle text-warning"></i> 
                                    Obrigatório para "Operação não Realizada" (mínimo 15 caracteres)
                                </small>
                            </div>
                            <div id="justificativaCounter" class="text-end mt-1">
                                <small class="text-muted">0/255 caracteres</small>
                            </div>
                        </div>

                        <!-- <div class="alert alert-info d-flex align-items-start" role="alert">
                            <i class="fas fa-lightbulb me-2 mt-1"></i>
                            <div>
                                <strong>Importante:</strong> A manifestação do destinatário é um procedimento da SEFAZ 
                                que permite confirmar ou recusar o conhecimento sobre uma NF-e/CT-e emitida em seu CNPJ.
                            </div>
                        </div> -->
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i>Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary" id="btnManifestar">
                            <i class="fas fa-paper-plane me-1"></i>Manifestar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Modal de Histórico de Manifestação/Conferencia -->
    <div class="modal fade" id="modalLogManifesto" tabindex="-1" aria-labelledby="modalLogManifestoLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered"> <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalLogManifestoLabel">
                        <i class="fas fa-history me-2"></i>Logs
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Data Evento</th>
                                    <th>Usuário</th>
                                    <th>Tipo</th>
                                    <th>Evento</th>
                                    <th>Status</th>
                                    <th>Motivo</th>
                                </tr>
                            </thead>
                            <tbody id="tabelaLogManifesto">
                                <tr>
                                    <td colspan="6" class="text-center py-4">
                                        <div class="spinner-border spinner-border-sm" role="status">
                                            <span class="visually-hidden">Carregando...</span>
                                        </div>
                                        <span class="ms-2">Buscando histórico...</span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmação de Exclusão -->
    <div class="modal fade" id="modalConfirmarExclusao" tabindex="-1" aria-labelledby="modalConfirmarExclusaoLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <form id="formConfirmarExclusao">
                    <input type="hidden" name="csrfmiddlewaretoken" value="5irda87WcbzR0TEIV1m63ofqSNhAPSZ0OYR0KhsWtLKWTkwO8NAUUODbsaoVgiFB">
                    <input type="hidden" name="chaves_para_excluir" id="chavesParaExcluir">
                    <input type="hidden" name="tipo_para_excluir" id="tipoParaExcluir">

                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title" id="modalConfirmarExclusaoLabel">
                            <i class="fas fa-exclamation-triangle me-2"></i> Confirmar Exclusão
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
                    </div>
                    <div class="modal-body">
                        <p>Você está prestes a excluir <strong id="contagemExclusao">documento(s)</strong>. Esta ação <strong>não pode ser desfeita</strong>.</p>
                        <p>Para confirmar, por favor, digite a senha do usuário <strong>Administrador</strong>.</p>
                        <div class="mb-3">
                            <label for="senhaConfirmacaoExclusao" class="form-label">Senha</label>
                            <input type="password" class="form-control" id="senhaConfirmacaoExclusao" name="password" required="">
                        </div>
                        <div id="errorExclusao" class="alert alert-danger d-none mt-3" role="alert"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-danger" id="btnConfirmarExclusaoSubmit">
                            <i class="fas fa-trash-alt me-1"></i> Confirmar Exclusão
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: Importar XML -->
    <div class="modal fade" id="modalImportarXML" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <!-- Cabeçalho -->
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-cloud-upload me-1"></i> Importação de XMLs
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>

                <!-- Corpo -->
                <div class="modal-body bg-light" id="modalImportarXMLContent">
                    <div class="text-center p-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                        <p class="mt-2">Carregando formulário...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal secundário de carregamento -->
    <div class="modal fade" id="modalImportando" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content text-center p-4">
                <div class="modal-body">
                    <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;"></div>
                    <h5 class="fw-bold">Importando XMLs...</h5>
                    <p class="text-muted">Aguarde enquanto processamos seus arquivos.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Consulta por Chave de Acesso -->
    <div class="modal fade" id="modalConsultaChave" tabindex="-1" aria-labelledby="modalConsultaChaveLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalConsultaChaveLabel">
                        <i class="fas fa-key me-2"></i>
                        Consultar Notas por Chave de Acesso
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info mb-3">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Instruções:</strong>
                        <ul class="mb-0 mt-2">
                            <li>Digite ou cole as chaves de acesso das notas fiscais</li>
                            <li>Separe múltiplas chaves usando ponto e vírgula (<strong>;</strong>)</li>
                            <li>Cada chave deve ter exatamente 44 dígitos</li>
                            <li>A consulta será realizada para a empresa: <strong id="empresaSelecionadaNome">-</strong></li>
                        </ul>
                    </div>

                    <form id="formConsultaChave">
                        <div class="mb-3">
                            <label for="chavesAcesso" class="form-label">
                                <i class="fas fa-barcode me-1"></i>
                                Chaves de Acesso
                            </label>
                            <textarea class="form-control font-monospace" id="chavesAcesso" rows="8" placeholder="Exemplo:
                                35240112345678901234550010000123451234567890
                                35240112345678901234550010000123461234567891;35240112345678901234550010000123471234567892" required=""></textarea>
                            <div class="form-text">
                                <i class="fas fa-lightbulb me-1"></i>
                                Você pode colar várias chaves de uma vez, separadas por ponto e vírgula (;)
                            </div>
                        </div>

                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <small class="text-muted" id="contagemChaves">0 chave(s) detectada(s)</small>
                            </div>
                            <div>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="fas fa-times me-1"></i>
                                    Cancelar
                                </button>
                                <button type="submit" class="btn btn-primary" id="btnIniciarConsulta">
                                    <i class="fas fa-search me-1"></i>
                                    Iniciar Consulta
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Busca Manual -->
    <div class="modal fade" id="modalBuscaManual" tabindex="-1" aria-labelledby="modalBuscaManualLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="modalBuscaManualLabel">
                        <i class="fas fa-sync-alt me-2"></i>
                        Busca Manual de Notas Fiscais
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body" id="modalBuscaManualBody">
                    <!-- Conteúdo será preenchido dinamicamente -->
                    <div class="text-center py-3">
                        <div class="spinner-border text-success" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                        <p class="mt-3">Verificando condições...</p>
                    </div>
                </div>
                <div class="modal-footer" id="modalBuscaManualFooter">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>
                        Fechar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        // Variáveis globais
        let tipoDocumentoAtual = 'nfe';
        let paginaAtual = 1;
        let totalPaginas = 1;

        //=============================================================================================================
        //============================================ Funções Utilitárias ============================================
        //=============================================================================================================

        function formatarCPFCNPJ(valor) {
            const digitos = String(valor).replace(/\D/g, ''); // Remove tudo que não é dígito

            if (digitos.length === 11) {
                // Formato CPF: 000.000.000-00
                return digitos.replace(/^(\d{3})(\d{3})(\d{3})(\d{2})$/, '$1.$2.$3-$4');
            } 
            
            if (digitos.length === 14) {
                // Formato CNPJ: 00.000.000/0000-00
                return digitos.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})$/, '$1.$2.$3/$4-$5');
            }

            // Retorna o valor original se não for nem CPF nem CNPJ
            return valor;
        }

        function formatarMoeda(valor) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(valor);
        }

        function formatarData(data) {
            return new Date(data).toLocaleDateString('pt-BR');
        }

        function getStatusBadge(status) {
            const badges = {
                'Autorizada': 'success',
                'Cancelada': 'danger',
                'Rejeitada': 'warning',
                'Pendente': 'info'
            };
            const tipo = badges[status] || 'secondary';
            return `<span class="badge ${tipo} status-badge">${status}</span>`;
        }

        //=============================================================================================================
        //====================================== Função para Exibir Relatório de Importação ===========================
        //=============================================================================================================

        /**
         * Exibe o relatório de importação dentro do modal de importação.
         * @param {Array} relatorio - Lista de itens do relatório (ex: [status, mensagem, contexto])
         * @param {number} sucessos - Contagem de sucessos
         * @param {number} erros - Contagem de erros
         */
        function exibirRelatorioImportacao(sucessos, erros) {
            console.log("Iniciando exibirRelatorioImportacao (versão Resumo)..."); // Log
            const container = document.getElementById('import-relatorio-container');
            const spanSucessos = document.getElementById('relatorio-sucessos');
            const spanErros = document.getElementById('relatorio-erros');
            const btnExportar = document.getElementById('btn-exportar-relatorio'); // Novo elemento

            console.log("Elemento container encontrado:", container);
            console.log("Elemento spanSucessos encontrado:", spanSucessos);
            console.log("Elemento spanErros encontrado:", spanErros);
            console.log("Elemento btnExportar encontrado:", btnExportar); // Log do novo botão

            if (!container || !spanSucessos || !spanErros || !btnExportar) {
                console.error('Elementos do container de relatório ou botão de exportação não encontrados!');
                const contentArea = document.getElementById('modalImportarXMLContent');
                if (contentArea) {
                    contentArea.innerHTML += '<div class="alert alert-warning mt-3">Erro ao exibir o resumo do relatório.</div>';
                }
                return;
            }

            // Preenche os contadores
            spanSucessos.textContent = sucessos;
            spanErros.textContent = erros;

            // Torna o container principal e o botão de exportação visíveis
            container.classList.remove('d-none');
            btnExportar.classList.remove('d-none'); // Mostra o botão!

            console.log("exibirRelatorioImportacao (Resumo) concluído."); // Log
        }

        // Função para trocar tipo de documento
        function trocarTipoDocumento(tipo) {
            tipoDocumentoAtual = tipo;
            paginaAtual = 1;
            atualizarFiltrosDisponiveis();
            carregarDados();
        }

        // Quando trocar de aba, atualizar filtros disponíveis
        document.addEventListener('DOMContentLoaded', function() {
            const tabButtons = document.querySelectorAll('[data-bs-toggle="tab"]');
            
            tabButtons.forEach(tab => {
                tab.addEventListener('shown.bs.tab', function(e) {
                    const targetTab = e.target.getAttribute('data-bs-target');
                    
                    // Atualizar tipo de documento
                    if (targetTab === '#nfe') {
                        tipoDocumentoAtual = 'nfe';
                    } else if (targetTab === '#cte') {
                        tipoDocumentoAtual = 'cte';
                    }
                    
                    // Limpar filtros ativos ao trocar de aba
                    const filtrosAtivosNfe = document.getElementById('filtrosAtivosNfe');
                    const filtrosAtivosCte = document.getElementById('filtrosAtivosCte');
                    if (filtrosAtivosNfe) filtrosAtivosNfe.innerHTML = '';
                    if (filtrosAtivosCte) filtrosAtivosCte.innerHTML = '';
                    
                    // Atualizar filtros disponíveis (templates E opções do select)
                    atualizarFiltrosDisponiveis();
                    
                    // Recarregar dados
                    paginaAtual = 1;
                    carregarDados();
                });
            });
            
            // Inicializar na primeira carga
            atualizarFiltrosDisponiveis();
            configurarEventosFiltros();
        });

        // Função para gerar cabeçalho da tabela
        function gerarCabecalho(tipo) {
            const colunas = tipo === 'nfe' ? colunasNfe : colunasCte;
            const headerId = tipo === 'nfe' ? 'headerNfe' : 'headerCte';
            const header = document.getElementById(headerId);
            
            let html = '';
            for (const [key, config] of Object.entries(colunas)) {
                console.log('Key:', key, 'Config:', config);
                if (config.visible) {
                    const className = config.className || '';
                    html += `<th class="${config.class}" width="${config.width}">${config.label}</th>`;
                }
            }
            html += '<th class="col-acoes" width="100px">:</th>';
            
            header.innerHTML = html;
        }

        // Função para renderizar tabela com checkboxes
        function renderizarTabela(dados) {
            const tbody = document.getElementById(tipoDocumentoAtual === 'nfe' ? 'tabelaNotasNfe' : 'tabelaNotasCte');
            
            if (dados.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="20" class="p-0">
                            <div class="d-flex flex-column justify-content-center align-items-center bg-light" style="height: 250px;">
                                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">Nenhum documento encontrado</h5>
                                <p class="text-muted mb-0">Verifique os filtros, as configurações do certificado e posteriormente os logs de consulta.</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            const colunas = tipoDocumentoAtual === 'nfe' ? colunasNfe : colunasCte;
            
            const linhas = dados.map(item => {
                const chave = tipoDocumentoAtual === 'nfe' ? (item.chave_nota || item.chv_nota || '') : (item.chave_cte || item.chv_cte || '');
                const conferenciaAtual = item.conferencia || 'Não Conferida';
                const manifestacaoAtual = item.manifestacao || 'Sem Manifestação';
                const tipoXML = item.tipo || 'Resumo';
                let html = `<tr data-chave="${chave}">`;
                
                for (const [key, config] of Object.entries(colunas)) {
                    if (config.visible) {
                        let valor = item[key] || '';
                        let tdClass = config.class || '';
                        
                        // Checkbox especial
                        if (key === 'checkbox') {
                            const chave = item.chave_nota || item.chave_cte;
                            valor = `<input type="checkbox" class="checkbox-nota" value="${chave}" onchange="atualizarContadorSelecionados()">`;
                        }
                        // Formatação especial para outros campos
                        else if (key.includes('data_')) {
                            valor = valor ? formatarData(valor) : '';
                        } else if (key.includes('valor_') || key === 'icms' || key === 'ipi' || key === 'pis' || key === 'cofins' || key === 'ibs' || key === 'cbs' || key === 'total_dfe') {
                            valor = `<span class="valor-monetario">${formatarMoeda(parseFloat(valor) || 0)}</span>`;
                        } else if (key === 'status') {
                            valor = getStatusBadge(valor);
                        } else if (key.includes('emitente') || key.includes('destinatario') || key.includes('remetente') || key.includes('transportadora') || key.includes('natureza_operacao') || key.includes('expedidor') || key.includes('recebedor') || key.includes('tomador')) {
                            valor = `<span class="info-${key} cell-tooltip" title="${valor}">${valor.length > 25 ? valor.substring(0, 25) + '...' : valor}</span>`;
                        } else if (key.includes('origem')) {
                            valor = `<span class="info-${key} cell-tooltip" title="${valor}">${valor.length > 14 ? valor.substring(0, 14) + '...' : valor}</span>`;
                        } else if (key === 'manifestacao') {
                            valor = `<span class="badge info text-dark">${manifestacaoAtual}</span>`;
                        }

                        if (key === 'conferencia') {
                        // Define o texto e a classe do badge
                        let badgeClass = 'bg-warning'; // Cinza por padrão (Não Conferida)
                        let statusTexto = conferenciaAtual; // Usa o valor que já temos

                        if (conferenciaAtual === 'Conferida') {
                            badgeClass = 'bg-success'; // Verde para Conferida
                        }

                        // Cria o HTML do badge
                        valor = `<span class="badge ${badgeClass}">${statusTexto}</span>`;

                        // Remove a lógica anterior que adicionava 'table-success' à célula inteira
                        // tdClass = config.class || ''; // Resetamos tdClass para apenas a classe original da coluna
                        }
                        // =======================================================
                        else { // <<< Adiciona um else para garantir que tdClass não seja resetado para outras colunas
                            tdClass = config.class || ''; // Mantém a classe original para outras colunas
                        }
                            
                        html += `<td class="${tdClass}">${valor}</td>`;

                    }
                }
                
                // Coluna de ações atualizada com XML
                const baseUrlNfe = "/danfe/CHAVE_PLACEHOLDER/";
                const baseUrlCte = "/dacte/CHAVE_PLACEHOLDER/";
                let urlPdf = '#';
                let titlePdf = tipoDocumentoAtual === 'nfe' ? 'Gerar DANFE' : 'Gerar DACTE';
                let targetPdf = '';

                if (tipoXML === 'Completo') {
                    urlPdf = baseUrlNfe.replace('CHAVE_PLACEHOLDER', chave);
                    targetPdf = '_blank';
                }

                if (tipoDocumentoAtual === 'cte') {
                    urlPdf = baseUrlCte.replace('CHAVE_PLACEHOLDER', chave);
                    targetPdf = '_blank';
                }
                // Define o texto do botão e o próximo status
                const ehConferida = conferenciaAtual === 'Conferida';
                const proximoStatus = ehConferida ? 'Não Conferida' : 'Conferida';
                const textoBotaoConferencia = ehConferida ? 'Desmarcar Conferência' : 'Marcar como Conferida';
                const iconeBotaoConferencia = ehConferida ? 'fa-times-circle' : 'fa-check-circle';
                //const corTextoBotaoConferencia = ehConferida ? 'text-warning' : 'text-success';

                html += `
                    <td class="col-acoes">
                        <div class="dropstart dropdown-acoes">
                            <button class="btn btn-acoes-dropdown dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-ellipsis-v"></i>
                                <span class="d-none d-md-inline"></span>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-acoes dropdown-menu-end">
                                <li>
                                    <a class="dropdown-item dropdown-item-acoes" href="#" onclick="baixarXML('${chave}'); return false;">
                                        <i class="fas fa-code"></i>
                                        <span>Baixar XML</span>
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item dropdown-item-acoes" href="${urlPdf}" target="${targetPdf}">
                                        <i class="fas fa-file-pdf"></i> ${titlePdf} </a>
                                </li>
                                <li>
                                    <a class="dropdown-item dropdown-item-acoes {corTextoBotaoConferencia}" href="#" onclick="toggleConferenciaStatus(['${chave}'], '${proximoStatus}', this); return false;">
                                        <i class="fas ${iconeBotaoConferencia}"></i>
                                        <span>${textoBotaoConferencia}</span>
                                    </a>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <a class="dropdown-item dropdown-item-acoes" href="#" onclick="abrirModalManifestacao('${chave}', '${tipoDocumentoAtual}'); return false;">
                                        <i class="fas fa-file-signature"></i>
                                        <span>Manifestar</span>
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item dropdown-item-acoes" href="#" onclick="abrirModalLogManifesto('${chave}', '${tipoDocumentoAtual}'); return false;">
                                        <i class="fas fa-history"></i>
                                        <span>Ver Log</span>
                                    </a>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <a class="dropdown-item dropdown-item-acoes" href="#" onclick="verDetalhes('${chave}', '${tipoDocumentoAtual}'); return false;">
                                        <i class="fas fa-eye"></i>
                                        <span>Ver Detalhes</span>
                                    </a>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <a class="dropdown-item dropdown-item-acoes text-danger" href="#" onclick="abrirModalExclusao('${chave}', '${tipoDocumentoAtual}'); return false;">
                                        <i class="fas fa-trash-alt"></i>
                                        <span>Excluir</span>
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </td>
                `;
                
                html += '</tr>';
                return html;
            }).join('');

            tbody.innerHTML = linhas;
        }


        //=============================================================================================================
        //============================================= Detalhes da Nota ==============================================
        //=============================================================================================================
      
        function verDetalhes(chaveNota, tipo) {
            // Mostrar loading no modal
            const modalContent = document.getElementById('modalDetalhesContent');
            modalContent.innerHTML = `
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <p class="mt-2 mb-0">Carregando detalhes...</p>
                </div>
            `;
            
            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById('modalDetalhes'));
            modal.show();
            
            // Fazer requisição para API de detalhes
            fetch(`/api/notas/${chaveNota}/?tipo=${tipo}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        renderizarDetalhes(data.data, tipo);
                    } else {
                        throw new Error(data.error || 'Erro ao carregar detalhes');
                    }
                })
                .catch(error => {
                    console.error('Erro ao carregar detalhes:', error);
                    modalContent.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Erro ao carregar detalhes: ${error.message}
                        </div>
                    `;
                });
        }
        
        function renderizarDetalhes(data, tipo) {
            if (tipo === 'nfe') {
                renderizarDetalhesNFe(data); // Chame a função que você já tem
            } else {
                renderizarDetalhesCTe(data); // Você precisará criar esta função
            }
        }
            
        function renderizarDetalhesNFe(nota) {
            const modalContent = document.getElementById('modalDetalhesContent');
            const conteudo = `
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-info-circle me-2"></i>Informações Gerais</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Chave:</strong></td><td class="font-monospace small">${nota.cabecalho.chave_nota}</td></tr>
                            <tr><td><strong>Número:</strong></td><td>${nota.cabecalho.numero}</td></tr>
                            <tr><td><strong>Série:</strong></td><td>${nota.cabecalho.serie || 'N/A'}</td></tr>
                            <tr><td><strong>Modelo:</strong></td><td>${nota.cabecalho.modelo || 'N/A'}</td></tr>
                            <tr><td><strong>Situação:</strong></td><td>${nota.cabecalho.sit_nfe}</td></tr>
                            <tr><td><strong>Data Emissão:</strong></td><td>${formatarData(nota.cabecalho.data_emissao)}</td></tr>
                            <tr><td><strong>Data Saída:</strong></td><td>${formatarData(nota.cabecalho.data_saida)}</td></tr>
                            <tr><td><strong>UF:</strong></td><td>${nota.cabecalho.uf}</td></tr>
                            <tr><td><strong>Tipo:</strong></td><td>${nota.cabecalho.tipo_nota}</td></tr>
                            <tr><td><strong>Natureza:</strong></td><td>${nota.cabecalho.natureza_operacao || 'N/A'}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-calculator me-2"></i>Valores Tributários</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Valor Produtos:</strong></td><td>${formatarMoeda(nota.totais?.produtos || 0)}</td></tr>
                            <tr><td><strong>Desconto:</strong></td><td>${formatarMoeda(nota.totais?.desconto || 0)}</td></tr>
                            <tr><td><strong>Frete:</strong></td><td>${formatarMoeda(nota.totais?.frete || 0)}</td></tr>
                            <tr><td><strong>Seguro:</strong></td><td>${formatarMoeda(nota.totais?.seguro || 0)}</td></tr>
                            <tr><td><strong>ICMS:</strong></td><td>${formatarMoeda(nota.totais?.icms || 0)}</td></tr>
                            <tr><td><strong>IPI:</strong></td><td>${formatarMoeda(nota.totais?.ipi || 0)}</td></tr>
                            <tr><td><strong>PIS:</strong></td><td>${formatarMoeda(nota.totais?.pis || 0)}</td></tr>
                            <tr><td><strong>COFINS:</strong></td><td>${formatarMoeda(nota.totais?.cofins || 0)}</td></tr>
                            <tr><td><strong>IBS:</strong></td><td>${formatarMoeda(nota.totais?.valor_ibs || 0)}</td></tr>
                            <tr><td><strong>CBS:</strong></td><td>${formatarMoeda(nota.totais?.valor_cbs || 0)}</td></tr>
                            <tr><td><strong>Total NFe:</strong></td><td><strong>${formatarMoeda(nota.totais?.total_nfe || 0)}</strong></td></tr>
                        </table>
                    </div>
                    <div class="col-12 mt-3">
                        <h6><i class="fas fa-building me-2"></i>Emitente</h6>
                        <div class="card bg-light">
                            <div class="card-body p-3">
                                <p class="mb-2"><strong>${nota.emitente?.nome || 'N/A'}</strong></p>
                                <p class="mb-1 small">CNPJ: ${nota.emitente?.cnpj_cpf || 'N/A'}</p>
                                ${nota.emitente?.nome_fantasia ? `<p class="mb-1 small">Nome Fantasia: ${nota.emitente.nome_fantasia}</p>` : ''}
                                ${nota.emitente?.ie ? `<p class="mb-1 small">IE: ${nota.emitente.ie}</p>` : ''}
                                ${nota.emitente?.endereco?.logradouro ? `
                                    <p class="mb-0 small">
                                        ${nota.emitente.endereco.logradouro}, ${nota.emitente.endereco.numero || 'S/N'} - 
                                        ${nota.emitente.endereco.bairro || ''} - ${nota.emitente.endereco.uf || ''}
                                        ${nota.emitente.endereco.cep ? ` - CEP: ${nota.emitente.endereco.cep}` : ''}
                                    </p>
                                ` : ''}
                            </div>
                        </div>
                        
                        <h6 class="mt-3"><i class="fas fa-user me-2"></i>Destinatário</h6>
                        <div class="card bg-light">
                            <div class="card-body p-3">
                                <p class="mb-2"><strong>${nota.destinatario?.nome || 'N/A'}</strong></p>
                                <p class="mb-1 small">CNPJ/CPF: ${nota.destinatario?.cnpj_cpf || 'N/A'}</p>
                                ${nota.destinatario?.nome_fantasia ? `<p class="mb-1 small">Nome Fantasia: ${nota.destinatario.nome_fantasia}</p>` : ''}
                                ${nota.destinatario?.ie ? `<p class="mb-1 small">IE: ${nota.destinatario.ie}</p>` : ''}
                                ${nota.destinatario?.endereco?.logradouro ? `
                                    <p class="mb-0 small">
                                        ${nota.destinatario.endereco.logradouro}, ${nota.destinatario.endereco.numero || 'S/N'} - 
                                        ${nota.destinatario.endereco.bairro || ''} - ${nota.destinatario.endereco.uf || ''}
                                        ${nota.destinatario.endereco.cep ? ` - CEP: ${nota.destinatario.endereco.cep}` : ''}
                                    </p>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                    
                    ${nota.produtos && nota.produtos.length > 0 ? `
                        <div class="col-12 mt-3">
                            <h6><i class="fas fa-boxes me-2"></i>Produtos (${nota.produtos.length} itens)</h6>
                            <div class="table-responsive" style="max-height: 300px;">
                                <table class="table table-sm table-striped">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Item</th>
                                            <th>Código</th>
                                            <th>Descrição</th>
                                            <th>NCM</th>
                                            <th>Qtd</th>
                                            <th>Unid</th>
                                            <th>Vl Unit</th>
                                            <th>Vl Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${nota.produtos.map(produto => `
                                            <tr>
                                                <td>${produto.numero_item}</td>
                                                <td><small>${produto.codigo}</small></td>
                                                <td><small title="${produto.descricao}">${produto.descricao.length > 30 ? produto.descricao.substring(0, 30) + '...' : produto.descricao}</small></td>
                                                <td><small>${produto.ncm || 'N/A'}</small></td>
                                                <td>${produto.quantidade}</td>
                                                <td>${produto.unidade || 'UN'}</td>
                                                <td>${formatarMoeda(produto.valor_unitario)}</td>
                                                <td>${formatarMoeda(produto.valor_total)}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    ` : ''}
                    
                    ${nota.outros?.informacoes_complementares ? `
                        <div class="col-12 mt-3">
                            <h6><i class="fas fa-comment me-2"></i>Informações Complementares</h6>
                            <div class="alert alert-info">
                                <small>${nota.outros.informacoes_complementares}</small>
                            </div>
                        </div>
                    ` : ''}
                    
                    ${nota.outros?.protocolo ? `
                        <div class="col-12 mt-3">
                            <h6><i class="fas fa-check-circle me-2"></i>Informações de Protocolo</h6>
                            <div class="alert alert-info">
                            <div class="row">
                                <div class="col-md-6">
                                    <p class="mb-1"><strong>Protocolo:</strong> ${nota.outros.protocolo}</p>
                                </div>
                                <div class="col-md-6">
                                    <p class="mb-1"><strong>Data Recebimento:</strong> ${formatarData(nota.outros.data_recebimento)}</p>
                                </div>
                                ${nota.outros.status_codigo ? `
                                    <div class="col-md-6">
                                        <p class="mb-1"><strong>Status:</strong> ${nota.outros.status_codigo}</p>
                                    </div>
                                ` : ''}
                                ${nota.outros.motivo ? `
                                    <div class="col-md-6">
                                        <p class="mb-1"><strong>Motivo:</strong> ${nota.outros.motivo}</p>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
            
            modalContent.innerHTML = conteudo;
        }

        function renderizarDetalhesCTe(cte) {
            const modalContent = document.getElementById('modalDetalhesContent');
            const conteudo = `
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-info-circle me-2"></i>Informações Gerais</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Chave:</strong></td><td class="font-monospace small">${cte.cabecalho.chave_cte}</td></tr>
                            <tr><td><strong>Número:</strong></td><td>${cte.cabecalho.numero}</td></tr>
                            <tr><td><strong>Série:</strong></td><td>${cte.cabecalho.serie || 'N/A'}</td></tr>
                            <tr><td><strong>Modelo:</strong></td><td>${cte.cabecalho.modelo || 'N/A'}</td></tr>
                            <tr><td><strong>Situação CT-e:</strong></td><td>${cte.cabecalho.sit_cte}</td></tr>
                            <tr><td><strong>Data Emissão:</strong></td><td>${formatarData(cte.cabecalho.data_emissao)}</td></tr>
                            <tr><td><strong>UF Inicial:</strong></td><td>${cte.cabecalho.uf_inicial}</td></tr>
                            <tr><td><strong>UF Final:</strong></td><td>${cte.cabecalho.uf_final}</td></tr>
                            <tr><td><strong>Tipo Serviço:</strong></td><td>${cte.cabecalho.tipo_servico}</td></tr>
                            <tr><td><strong>Modal:</strong></td><td>${cte.cabecalho.modal || 'N/A'}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-calculator me-2"></i>Valores</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Valor Total da Prestação:</strong></td><td>${formatarMoeda(cte.valores?.valor_total_prestacao || 0)}</td></tr>
                            <tr><td><strong>Valor a Receber:</strong></td><td>${formatarMoeda(cte.valores?.valor_receber || 0)}</td></tr>
                            <tr><td><strong>ICMS:</strong></td><td>${formatarMoeda(cte.impostos?.icms || 0)}</td></tr>
                            <tr><td><strong>PIS:</strong></td><td>${formatarMoeda(cte.impostos?.pis || 0)}</td></tr>
                            <tr><td><strong>COFINS:</strong></td><td>${formatarMoeda(cte.impostos?.cofins || 0)}</td></tr>
                            <tr><td><strong>IBS/CBS:</strong></td><td>${formatarMoeda(cte.impostos?.ibs_cbs || 0)}</td></tr>
                            <tr><td><strong>Valor Tributado:</strong></td><td>${formatarMoeda(cte.impostos?.valor_tributado || 0)}</td></tr>
                            <tr><td><strong>Total do Documento:</strong></td><td>${formatarMoeda(cte.impostos?.valor_total_documento || 0)}</td></tr>
                        </table>
                    </div>
                    <div class="col-12 mt-3">
                        <h6><i class="fas fa-building me-2"></i>Emitente</h6>
                        <div class="card bg-light">
                            <div class="card-body p-3">
                                <p class="mb-2"><strong>${cte.emitente?.nome || 'N/A'}</strong></p>
                                <p class="mb-1 small">CNPJ: ${cte.emitente?.cnpj_cpf || 'N/A'}</p>
                                ${cte.emitente?.nome_fantasia ? `<p class="mb-1 small">Nome Fantasia: ${cte.emitente.nome_fantasia}</p>` : ''}
                                ${cte.emitente?.ie ? `<p class="mb-1 small">IE: ${cte.emitente.ie}</p>` : ''}
                                ${cte.emitente?.endereco?.logradouro ? `
                                    <p class="mb-0 small">
                                        ${cte.emitente.endereco.logradouro}, ${cte.emitente.endereco.numero || 'S/N'} - 
                                        ${cte.emitente.endereco.bairro || ''} - ${cte.emitente.endereco.uf || ''}
                                        ${cte.emitente.endereco.cep ? ` - CEP: ${cte.emitente.endereco.cep}` : ''}
                                        ${cte.emitente.endereco.codigo_municipio ? ` - ${cte.emitente.endereco.codigo_municipio}` : ''}
                                    </p>
                                ` : ''}
                            </div>
                        </div>

                        <h6><i class="fas fa-user me-2"></i>Remetente</h6>
                        <div class="card bg-light">
                            <div class="card-body p-3">
                                <p class="mb-2"><strong>${cte.remetente?.nome || 'N/A'}</strong></p>
                                <p class="mb-1 small">CNPJ: ${cte.remetente?.cnpj_cpf || 'N/A'}</p>
                                ${cte.remetente?.nome_fantasia ? `<p class="mb-1 small">Nome Fantasia: ${cte.remetente.nome_fantasia}</p>` : ''}
                                ${cte.remetente?.ie ? `<p class="mb-1 small">IE: ${cte.remetente.ie}</p>` : ''}
                                ${cte.remetente?.endereco?.logradouro ? `
                                    <p class="mb-0 small">
                                        ${cte.remetente.endereco.logradouro}, ${cte.remetente.endereco.numero || 'S/N'} - 
                                        ${cte.remetente.endereco.bairro || ''} - ${cte.remetente.endereco.uf || ''}
                                        ${cte.remetente.endereco.cep ? ` - CEP: ${cte.remetente.endereco.cep}` : ''}
                                        ${cte.remetente.endereco.codigo_municipio ? ` - ${cte.remetente.endereco.codigo_municipio}` : ''}
                                    </p>
                                ` : ''}
                            </div>
                        </div>
                        
                        <h6 class="mt-3"><i class="fas fa-user me-2"></i>Destinatário</h6>
                        <div class="card bg-light">
                            <div class="card-body p-3">
                                <p class="mb-2"><strong>${cte.destinatario?.nome || 'N/A'}</strong></p>
                                <p class="mb-1 small">CNPJ/CPF: ${cte.destinatario?.cnpj_cpf || 'N/A'}</p>
                                ${cte.destinatario?.nome_fantasia ? `<p class="mb-1 small">Nome Fantasia: ${cte.destinatario.nome_fantasia}</p>` : ''}
                                ${cte.destinatario?.ie ? `<p class="mb-1 small">IE: ${cte.destinatario.ie}</p>` : ''}
                                ${cte.destinatario?.endereco?.logradouro ? `
                                    <p class="mb-0 small">
                                        ${cte.destinatario.endereco.logradouro}, ${cte.destinatario.endereco.numero || 'S/N'} - 
                                        ${cte.destinatario.endereco.bairro || ''} - ${cte.destinatario.endereco.uf || ''}
                                        ${cte.destinatario.endereco.cep ? ` - CEP: ${cte.destinatario.endereco.cep}` : ''}
                                        ${cte.destinatario.endereco.codigo_municipio ? ` - ${cte.destinatario.endereco.codigo_municipio}` : ''}
                                    </p>
                                ` : ''}
                            </div>
                        </div>

                        <h6 class="mt-3"><i class="fas fa-user me-2"></i>Tomador</h6>
                        <div class="card bg-light">
                            <div class="card-body p-3">
                                <p class="mb-2"><strong>${cte.tomador?.nome || 'N/A'}</strong></p>
                                <p class="mb-1 small">CNPJ/CPF: ${cte.tomador?.cnpj_cpf || 'N/A'}</p>
                                ${cte.tomador?.nome_fantasia ? `<p class="mb-1 small">Nome Fantasia: ${cte.tomador.nome_fantasia}</p>` : ''}
                                ${cte.tomador?.ie ? `<p class="mb-1 small">IE: ${cte.tomador.ie}</p>` : ''}
                                ${cte.tomador?.endereco?.logradouro ? `
                                    <p class="mb-0 small">
                                        ${cte.tomador.endereco.logradouro}, ${cte.tomador.endereco.numero || 'S/N'} - 
                                        ${cte.tomador.endereco.bairro || ''} - ${cte.tomador.endereco.uf || ''}
                                        ${cte.tomador.endereco.cep ? ` - CEP: ${cte.tomador.endereco.cep}` : ''}
                                        ${cte.tomador.endereco.codigo_municipio ? ` - ${cte.tomador.endereco.codigo_municipio}` : ''}
                                    </p>
                                ` : ''}
                            </div>
                        </div>

                        <h6 class="mt-3"><i class="fas fa-user me-2"></i>Expedidor</h6>
                        <div class="card bg-light">
                            <div class="card-body p-3">
                                <p class="mb-2"><strong>${cte.expedidor?.nome || 'N/A'}</strong></p>
                                <p class="mb-1 small">CNPJ/CPF: ${cte.expedidor?.cnpj_cpf || 'N/A'}</p>
                                ${cte.expedidor?.nome_fantasia ? `<p class="mb-1 small">Nome Fantasia: ${cte.expedidor.nome_fantasia}</p>` : ''}
                                ${cte.expedidor?.ie ? `<p class="mb-1 small">IE: ${cte.expedidor.ie}</p>` : ''}
                                ${cte.expedidor?.endereco?.logradouro ? `
                                    <p class="mb-0 small">
                                        ${cte.expedidor.endereco.logradouro}, ${cte.expedidor.endereco.numero || 'S/N'} - 
                                        ${cte.expedidor.endereco.bairro || ''} - ${cte.expedidor.endereco.uf || ''}
                                        ${cte.expedidor.endereco.cep ? ` - CEP: ${cte.expedidor.endereco.cep}` : ''}
                                        ${cte.expedidor.endereco.codigo_municipio ? ` - ${cte.expedidor.endereco.codigo_municipio}` : ''}
                                    </p>
                                ` : ''}
                            </div>
                        </div>

                        <h6 class="mt-3"><i class="fas fa-user me-2"></i>Recebedor</h6>
                        <div class="card bg-light">
                            <div class="card-body p-3">
                                <p class="mb-2"><strong>${cte.recebedor?.nome || 'N/A'}</strong></p>
                                <p class="mb-1 small">CNPJ/CPF: ${cte.recebedor?.cnpj_cpf || 'N/A'}</p>
                                ${cte.recebedor?.nome_fantasia ? `<p class="mb-1 small">Nome Fantasia: ${cte.recebedor.nome_fantasia}</p>` : ''}
                                ${cte.recebedor?.ie ? `<p class="mb-1 small">IE: ${cte.recebedor.ie}</p>` : ''}
                                ${cte.recebedor?.endereco?.logradouro ? `
                                    <p class="mb-0 small">
                                        ${cte.recebedor.endereco.logradouro}, ${cte.recebedor.endereco.numero || 'S/N'} - 
                                        ${cte.recebedor.endereco.bairro || ''} - ${cte.recebedor.endereco.uf || ''}
                                        ${cte.recebedor.endereco.cep ? ` - CEP: ${cte.recebedor.endereco.cep}` : ''}
                                        ${cte.recebedor.endereco.codigo_municipio ? ` - ${cte.recebedor.endereco.codigo_municipio}` : ''}
                                    </p>
                                ` : ''}
                            </div>
                        </div>

                    </div>
                    
                    ${cte.outros?.protocolo ? `
                        <div class="col-12 mt-3">
                            <h6><i class="fas fa-check-circle me-2"></i>Informações de Protocolo</h6>
                            <div class="alert alert-info">
                            <div class="row">
                                <div class="col-md-6">
                                    <p class="mb-1"><strong>Protocolo:</strong> ${cte.outros.protocolo}</p>
                                </div>
                                <div class="col-md-6">
                                    <p class="mb-1"><strong>Data Recebimento:</strong> ${formatarData(cte.outros.data_recebimento)}</p>
                                </div>
                                ${cte.outros.status_codigo ? `
                                    <div class="col-md-6">
                                        <p class="mb-1"><strong>Status:</strong> ${cte.outros.status_codigo}</p>
                                    </div>
                                ` : ''}
                                ${cte.outros.motivo ? `
                                    <div class="col-md-6">
                                        <p class="mb-1"><strong>Motivo:</strong> ${cte.outros.motivo}</p>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
            
            modalContent.innerHTML = conteudo;
        }


        //=============================================================================================================
        //================================================ Baixar XMLs ================================================
        //=============================================================================================================

        // Funções de XML
        function baixarXML(chave) {
            const tipo = tipoDocumentoAtual;
            const url = tipo === 'nfe' ? `/xml/nfe/${chave}/` : `/xml/cte/${chave}/`;
            
            // Criar link temporário para download
            const link = document.createElement('a');
            link.href = url;
            link.download = `${tipo.toUpperCase()}_${chave}.xml`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function baixarXMLLote() {
            const checkboxes = document.querySelectorAll('.checkbox-nota:checked');
            
            if (checkboxes.length === 0) {
                alert('Selecione pelo menos uma nota para baixar os XMLs.');
                return;
            }
            
            const chaves = Array.from(checkboxes).map(cb => cb.value);
            
            // Mostrar loading
            const btnLote = document.getElementById('btnXMLLote');
            const textoOriginal = btnLote.innerHTML;
            btnLote.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Gerando...';
            btnLote.disabled = true;
            
            // Fazer requisição para gerar ZIP
            fetch('/xml/lote/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    chaves: chaves,
                    tipo: tipoDocumentoAtual
                })
            })
            .then(response => {
                if (response.ok) {
                    return response.blob();
                }
                throw new Error('Erro ao gerar XMLs em lote');
            })
            .then(blob => {
                // Criar download do ZIP
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `XMLs_${tipoDocumentoAtual.toUpperCase()}_${new Date().toISOString().slice(0,10)}.zip`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
                
                // Limpar seleções
                limparSelecoes();
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao gerar XMLs em lote: ' + error.message);
            })
            .finally(() => {
                // Restaurar botão
                btnLote.innerHTML = textoOriginal;
                btnLote.disabled = false;
            });
        }

        //=============================================================================================================
        //============================================ Baixar DANFE/DACTE =============================================
        //=============================================================================================================

        function baixarDANFELote() {
            const checkboxes = document.querySelectorAll('.checkbox-nota:checked');
            
            if (checkboxes.length === 0) {
                // Mensagem específica para DANFE
                alert('Selecione pelo menos uma nota para baixar os DANFEs.');
                return;
            }
            
            const chaves = Array.from(checkboxes).map(cb => cb.value);
            
            // Alvo: um novo botão com id="btnDANFELote"
            const btnLote = document.getElementById('btnDANFELote'); 
            const textoOriginal = btnLote.innerHTML;
            btnLote.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Gerando...';
            btnLote.disabled = true;
            
            // A URL do endpoint é a mesma, pois a view no backend já sabe lidar com tipos diferentes
            fetch('/xml/lote/', { // Assumindo que a URL da sua view é essa
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    chaves: chaves,
                    tipo: tipoDocumentoAtual === 'nfe' ? 'danfe' : 'dacte' // <-- MUDANÇA PRINCIPAL: enviamos o tipo 'danfe'
                })
            })
            .then(response => {
                if (response.ok) {
                    return response.blob();
                }
                // Mensagem de erro específica
                throw new Error('Erro ao gerar DANFEs em lote');
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                // Nome do arquivo de download específico para DANFE
                link.download = tipoDocumentoAtual === 'nfe' ? `DANFEs_${new Date().toISOString().slice(0,10)}.zip` : `DACTEs_${new Date().toISOString().slice(0,10)}.zip`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
                
                limparSelecoes(); // Reutiliza sua função de limpar checkboxes
            })
            .catch(error => {
                console.error('Erro:', error);
                // Mensagem de erro específica
                alert('Erro ao gerar DANFEs em lote: ' + error.message);
            })
            .finally(() => {
                btnLote.innerHTML = textoOriginal;
                btnLote.disabled = false;
            });
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Função para carregar dados via API
        async function carregarDados() {
            const tbody = document.getElementById(
                tipoDocumentoAtual === 'nfe' ? 'tabelaNotasNfe' : 'tabelaNotasCte'
            );

            const empresaSelecionada = tipoDocumentoAtual === 'nfe' 
                ? document.getElementById('empresaSelecao')?.value
                : document.getElementById('empresaSelecaoCte')?.value;

            // Nenhuma empresa selecionada → não busca nada
            if (!empresaSelecionada) {
                limparTabela();
                const alertArea = tipoDocumentoAtual === 'nfe' 
                    ? document.getElementById('alert-area-nfe')
                    : document.getElementById('alert-area-cte');
                if (alertArea) alertArea.innerHTML = '';
                return;
            }

            tbody.innerHTML = `
                <tr>
                    <td colspan="20" class="loading text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                        <p class="mt-2 mb-0 text-muted">Buscando documentos...</p>
                    </td>
                </tr>
            `;

            try {
                const filtros = obterFiltrosDocumento();
                filtros.empresa_id = empresaSelecionada; // Inclui empresa no filtro

                const params = new URLSearchParams({
                    tipo: tipoDocumentoAtual,
                    page: paginaAtual,
                    per_page: 100,
                    ...filtros
                });

                const response = await fetch(`/api/documentos-fiscais/?${params}`, {headers: { "X-Requested-With": "XMLHttpRequest" }});
                const data = await response.json();

                if (!response.ok) throw new Error(data.error || 'Erro ao buscar documentos');

                const alertArea = tipoDocumentoAtual === 'nfe' 
                    ? document.getElementById('alert-area-nfe')
                    : document.getElementById('alert-area-cte');
                if (alertArea) alertArea.innerHTML = '';

                // Alerta caso limite aplicado (opção "todas")
                if (data.limite_aplicado && alertArea) {
                    const alerta = document.createElement('div');
                    alerta.className = 'alert alert-warning alert-dismissible fade show';
                    alerta.role = 'alert';
                    alerta.innerHTML = `
                        <strong>Atenção!</strong> Como você selecionou "Todas as empresas",
                        o sistema exibiu apenas <strong>100 notas por empresa</strong>.
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
                    `;
                    alertArea.appendChild(alerta);
                }

                gerarCabecalho(tipoDocumentoAtual);
                renderizarTabela(data.dados);
                atualizarPaginacao(data);

            } catch (error) {
                console.error('Erro:', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="20" class="text-center py-4">
                            <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                            <p class="text-muted">Erro ao carregar dados: ${error.message}</p>
                        </td>
                    </tr>
                `;
            }
        }

        function limparTabela() {
            const isNfe = tipoDocumentoAtual === 'nfe';
            const tbody = document.getElementById(isNfe ? 'tabelaNotasNfe' : 'tabelaNotasCte');
            tbody.innerHTML = `
                <tr>
                    <td colspan="20" class="text-center py-4 text-muted">
                        <i class="fas fa-info-circle fa-2x mb-2"></i><br>
                        Selecione uma empresa para visualizar os documentos.
                    </td>
                </tr>
            `;
            const alertArea = isNfe 
                ? document.getElementById('alert-area-nfe')
                : document.getElementById('alert-area-cte');
            if (alertArea) alertArea.innerHTML = '';
        }

        //=============================================================================================================
        //================================================== Filtros ==================================================
        //=============================================================================================================

        function obterFiltros() {
            const filtros = {};
            
            if (tipoDocumentoAtual === 'nfe') {
                const empresaSelecao = document.getElementById('empresaSelecao').value;
                const dataInicial = document.getElementById('dataInicial').value;
                const dataFinal = document.getElementById('dataFinal').value;
                const emitente = document.getElementById('filtroEmitente').value;
                const chaveNota = document.getElementById('chaveNota').value;
                
                if (empresaSelecao) filtros.empresa_id = empresaSelecao; // ✅ Envia empresa_id
                if (dataInicial) filtros.data_inicial = dataInicial;
                if (dataFinal) filtros.data_final = dataFinal;
                if (emitente) filtros.emitente = emitente;
                if (chaveNota) filtros.chave_nota = chaveNota;

            } else {
                const empresaSelecao = document.getElementById('empresaSelecao').value;
                const dataInicial = document.getElementById('dataInicialCte').value;
                const dataFinal = document.getElementById('dataFinalCte').value;
                const chaveCte = document.getElementById('chaveNotaCte').value;
                const transportadora = document.getElementById('filtroTransportadora').value;
                
                if (empresaSelecao) filtros.empresa_id = empresaSelecao;
                if (dataInicial) filtros.data_inicial = dataInicial;
                if (dataFinal) filtros.data_final = dataFinal;
                if (transportadora) filtros.emitente = transportadora;
                if (chaveCte) filtros.chave_nota = chaveCte;
            }
            
            return filtros;
        }

        function aplicarFiltros() {
            paginaAtual = 1;
            carregarDados();
        }

        function aplicarFiltrosCte() {
            paginaAtual = 1;
            carregarDados();
        }

        function limparFiltros() {
            if (tipoDocumentoAtual === 'nfe') {
                document.getElementById('dataInicial').value = '';
                document.getElementById('dataFinal').value = '';
                const filtrosAtivosNfe = document.getElementById('filtrosAtivosNfe');
                if (filtrosAtivosNfe) filtrosAtivosNfe.innerHTML = '';
            } else {
                document.getElementById('dataInicialCte').value = '';
                document.getElementById('dataFinalCte').value = '';
                const filtrosAtivosCte = document.getElementById('filtrosAtivosCte');
                if (filtrosAtivosCte) filtrosAtivosCte.innerHTML = '';
            }
            
            paginaAtual = 1;
            carregarDados();
        }

        function limparFiltrosCte() {
            limparFiltros(); // Usa a mesma função
        }

        // Referências aos elementos (serão atualizadas dinamicamente)
        let filtrosAtivos = null;
        let filtroSelector = null;

        // Declarar filtrosDisponiveis no escopo global para ambos os tipos
        let filtrosDisponiveis = {};

        // Definição das opções do select para cada tipo
        const opcoesSelectFiltros = {
            nfe: `
                <option value="">+ Adicionar Filtro</option>
                <option value="chaveNota">Chave de Acesso</option>
                <option value="emitente">Emitente</option>
                <option value="cnpjEmitente">CNPJ Emitente</option>
                <option value="numeroNota">Número da Nota</option>
                <option value="status">Status</option>
                <option value="modelo">Modelo</option>
                <option value="conferencia">Conferência</option>
                <option value="manifestacao">Manifestação</option>
                <option value="dataRecebimentoSistema">Recebimento no Sistema</option>
            `,
            cte: `
                <option value="">+ Adicionar Filtro</option>
                <option value="chaveCte">Chave de Acesso</option>
                <option value="transportadoraCte">Transportadora</option>
                <option value="numeroCte">Número do CT-e</option>
                <option value="destinatarioCte">Destinatário</option>
                <option value="expedidorCte">Expedidor</option>
                <option value="recebedorCte">Recebedor</option>
                <option value="tomadorCte">Tomador</option>
                <option value="statusCte">Situação</option>
                <option value="cfopCte">CFOP</option>
                <option value="conferenciaCte">Conferência</option>
                <option value="manifestacaoCte">Manifestação</option>
                <option value="dataRecebimentoSistemaCte">Recebimento no Sistema</option>
            `
        };

        // Função para obter os elementos corretos baseado na aba ativa
        function obterElementosAbaAtiva() {
            if (tipoDocumentoAtual === 'nfe') {
                filtrosAtivos = document.getElementById('filtrosAtivosNfe');
                filtroSelector = document.getElementById('filtroSelectorNfe');
            } else {
                filtrosAtivos = document.getElementById('filtrosAtivosCte');
                filtroSelector = document.getElementById('filtroSelectorCte');
            }
        }

        // Função para atualizar filtros disponíveis baseado no tipo de documento
        function atualizarFiltrosDisponiveis() {
            obterElementosAbaAtiva();

            if (filtroSelector) {
                filtroSelector.innerHTML = opcoesSelectFiltros[tipoDocumentoAtual] || opcoesSelectFiltros.nfe;
            }

            if (tipoDocumentoAtual === 'nfe') {
                filtrosDisponiveis = {
                    chaveNota: `
                        <div class="col-md-3 filtro-item" data-filtro="chaveNota">
                            <label class="form-label">Chave de Acesso</label>
                            <div class="input-group input-group-sm">
                                <input type="text" class="form-control" id="chaveNota" placeholder="Utilize ',' ou ';' para separar as chaves">
                                <button class="btn btn-outline-danger remover-filtro" type="button">&times;</button>
                            </div>
                        </div>
                    `,
                    emitente: `
                        <div class="col-md-3 filtro-item" data-filtro="emitente">
                            <label class="form-label">Emitente</label>
                            <div class="input-group input-group-sm">
                                <input type="text" class="form-control" id="filtroEmitente" placeholder="Nome do emitente">
                                <button class="btn btn-outline-danger remover-filtro" type="button">&times;</button>
                            </div>
                        </div>
                    `,
                    cnpjEmitente: `
                        <div class="col-md-3 filtro-item" data-filtro="cnpjEmitente">
                            <label class="form-label">CNPJ Emitente</label>
                            <div class="input-group input-group-sm">
                                <input type="text" class="form-control" id="filtroCnpjEmitente" placeholder="CNPJ do emitente">
                                <button class="btn btn-outline-danger remover-filtro" type="button">&times;</button>
                            </div>
                        </div>
                    `,
                    numeroNota: `
                        <div class="col-md-2 filtro-item" data-filtro="numeroNota">
                            <label class="form-label">Número da Nota</label>
                            <div class="input-group input-group-sm">
                                <input type="text" class="form-control" id="filtroNumeroNota" placeholder="Utilize ',' ou ';' para separar os numeros">
                                <button class="btn btn-outline-danger remover-filtro" type="button">&times;</button>
                            </div>
                        </div>
                    `,
                    status: `
                        <div class="col-md-2 filtro-item" data-filtro="status">
                            <label class="form-label">Status</label>
                            <div class="input-group input-group-sm">
                                <select class="form-select form-select-sm" id="filtroStatus">
                                    <option value="">Todos</option>
                                    <option value="100">Autorizada</option>
                                    <option value="101">Cancelada</option>
                                    <option value="110">Rejeitada</option>
                                    <option value="Pendente">Pendente</option>
                                </select>
                                <button class="btn btn-outline-danger remover-filtro" type="button">&times;</button>
                            </div>
                        </div>
                    `,
                    modelo: `
                        <div class="col-md-2 filtro-item" data-filtro="modelo">
                            <label class="form-label">Modelo</label>
                            <div class="input-group input-group-sm">
                                <select class="form-select form-select-sm" id="filtroModelo">
                                    <option value="">Todos</option>
                                    <option value="55">55</option>
                                    <option value="65">65</option>
                                </select>
                                <button class="btn btn-outline-danger remover-filtro" type="button">&times;</button>
                            </div>
                        </div>
                    `,
                    conferencia: `
                        <div class="col-md-2 filtro-item" data-filtro="conferencia">
                            <label class="form-label">Conferência</label>
                            <div class="input-group input-group-sm">
                                <select class="form-select form-select-sm" id="filtroConferencia">
                                    <option value="">Todos</option>
                                    <option value="Não Conferida">Não Conferida</option>
                                    <option value="Conferida">Conferida</option>
                                </select>
                                <button class="btn btn-outline-danger remover-filtro" type="button">&times;</button>
                            </div>
                        </div>
                    `,
                    manifestacao: `
                        <div class="col-md-2 filtro-item" data-filtro="manifestacao">
                            <label class="form-label">Manifestação</label>
                            <div class="input-group input-group-sm">
                                <select class="form-select form-select-sm" id="filtroManifestacao">
                                    <option value="">Todos</option>
                                    <option value="Sem Manifestação">Sem Manifestação</option>
                                    <option value="Ciência da Emissão">Ciência da Emissão</option>
                                    <option value="Confirmação da Operação">Confirmação da Operação</option>
                                    <option value="Operação não Realizada">Operação não Realizada</option>
                                    <option value="Desconhecimento da Operação">Desconhecimento da Operação</option>
                                </select>
                                <button class="btn btn-outline-danger remover-filtro" type="button">&times;</button>
                            </div>
                        </div>
                    `,
                    dataRecebimentoSistema: `
                        <div class="col-md-2 filtro-item" data-filtro="dataRecebimentoSistemaIni">
                            <label class="form-label">Recebimento no Sistema Inicial</label>
                            <div class="input-group input-group-sm">
                                <input type="date" class="form-control form-control-sm" id="filtroRecebimentoSistemaIni">
                                <button class="btn btn-outline-danger remover-filtro" type="button">&times;</button>
                            </div>
                        </div>
                        <div class="col-md-2 filtro-item" data-filtro="dataRecebimentoSistemaFim">
                            <label class="form-label">Recebimento no Sistema Final</label>
                            <div class="input-group input-group-sm">
                                <input type="date" class="form-control form-control-sm" id="filtroRecebimentoSistemaFim">
                                <button class="btn btn-outline-danger remover-filtro" type="button">&times;</button>
                            </div>
                        </div>
                    `,
                };
            } else {
                filtrosDisponiveis = {
                    chaveCte: `
                        <div class="col-md-3 filtro-item" data-filtro="chaveCte">
                            <label class="form-label">Chave de Acesso</label>
                            <div class="input-group input-group-sm">
                                <input type="text" class="form-control" id="filtrochaveNotaCte" placeholder="Utilize ',' ou ';' para separar as chaves">
                                <button class="btn btn-outline-danger remover-filtro" type="button">&times;</button>
                            </div>
                        </div>
                    `,
                    transportadoraCte: `
                        <div class="col-md-3 filtro-item" data-filtro="transportadoraCte">
                            <label class="form-label">Transportadora</label>
                            <div class="input-group input-group-sm">
                                <input type="text" class="form-control" id="filtroTransportadoraCte" placeholder="Nome da transportadora">
                                <button class="btn btn-outline-danger remover-filtro" type="button">&times;</button>
                            </div>
                        </div>
                    `,
                    numeroCte: `
                        <div class="col-md-2 filtro-item" data-filtro="numeroCte">
                            <label class="form-label">Número do CT-e</label>
                            <div class="input-group input-group-sm">
                                <input type="text" class="form-control" id="filtroNumeroCte" placeholder="Utilize ',' ou ';' para separar os numeros">
                                <button class="btn btn-outline-danger remover-filtro" type="button">&times;</button>
                            </div>
                        </div>
                    `,
                    statusCte: `
                        <div class="col-md-2 filtro-item" data-filtro="statusCte">
                            <label class="form-label">Status</label>
                            <div class="input-group input-group-sm">
                                <select class="form-select form-select-sm" id="filtroStatusCte">
                                    <option value="">Todos</option>
                                    <option value="100">Autorizada</option>
                                    <option value="101">Cancelada</option>
                                    <option value="110">Rejeitada</option>
                                    <option value="Pedente">Pendente</option>
                                </select>
                                <button class="btn btn-outline-danger remover-filtro" type="button">&times;</button>
                            </div>
                        </div>
                    `,
                    modeloCte: `
                        <div class="col-md-2 filtro-item" data-filtro="modeloCte">
                            <label class="form-label">Modelo</label>
                            <div class="input-group input-group-sm">
                                <select class="form-select form-select-sm" id="filtroModeloCte">
                                    <option value="">Todos</option>
                                    <option value="57">57</option>
                                    <option value="67">67</option>
                                </select>
                                <button class="btn btn-outline-danger remover-filtro" type="button">&times;</button>
                            </div>
                        </div>
                    `,
                    conferenciaCte: `
                        <div class="col-md-2 filtro-item" data-filtro="conferenciaCte">
                            <label class="form-label">Conferência</label>
                            <div class="input-group input-group-sm">
                                <select class="form-select form-select-sm" id="filtroConferenciaCte">
                                    <option value="">Todos</option>
                                    <option value="NConferida">Não Conferida</option>
                                    <option value="Conferida">Conferida</option>
                                </select>
                                <button class="btn btn-outline-danger remover-filtro" type="button">&times;</button>
                            </div>
                        </div>
                    `,
                    manifestacaoCte: `
                        <div class="col-md-2 filtro-item" data-filtro="manifestacaoCte">
                            <label class="form-label">Manifestação</label>
                            <div class="input-group input-group-sm">
                                <select class="form-select form-select-sm" id="filtroManifestacaoCte">
                                    <option value="">Todos</option>
                                    <option value="Sem Manifestação">Sem Manifestação</option>
                                    <option value="Serviço em Desacordo">Serviço em Desacordo</option>
                                    <option value="Cancelamento do Desacordo">Cancelamento do Desacordo</option>
                                </select>
                                <button class="btn btn-outline-danger remover-filtro" type="button">&times;</button>
                            </div>
                        </div>
                    `,
                    dataRecebimentoSistemaCte: `
                        <div class="col-md-2 filtro-item" data-filtro="dataRecebimentoSistemaCteIni">
                            <label class="form-label">Recebimento no Sistema Inicial</label>
                            <div class="input-group input-group-sm">
                                <input type="date" class="form-control form-control-sm flex-grow-1" id="filtroRecebimentoSistemaCteIni">
                                <button class="btn btn-outline-danger btn-sm remover-filtro" type="button">&times;</button>
                            </div>
                        </div>
                        <div class="col-md-2 filtro-item" data-filtro="dataRecebimentoSistemaCteFim">
                            <label class="form-label">Recebimento no Sistema Final</label>
                            <div class="input-group input-group-sm">
                                <input type="date" class="form-control form-control-sm" id="filtroRecebimentoSistemaCteFim">
                                <button class="btn btn-outline-danger remover-filtro" type="button">&times;</button>
                            </div>
                        </div>
                    `,
                    remetenteCte: `
                        <div class="col-md-3 filtro-item" data-filtro="remetenteCte">
                            <label class="form-label">Remetente</label>
                            <div class="input-group input-group-sm">
                                <input type="text" class="form-control" id="filtroRemetenCte" placeholder="Nome do Remetente">
                                <button class="btn btn-outline-danger remover-filtro" type="button">&times;</button>
                            </div>
                        </div>
                    `,
                    destinatarioCte: `
                        <div class="col-md-3 filtro-item" data-filtro="destinatarioCte">
                            <label class="form-label">Transportadora</label>
                            <div class="input-group input-group-sm">
                                <input type="text" class="form-control" id="filtroDestinatarioCte" placeholder="Nome do Destinatário">
                                <button class="btn btn-outline-danger remover-filtro" type="button">&times;</button>
                            </div>
                        </div>
                    `,
                    expedidorCte: `
                        <div class="col-md-3 filtro-item" data-filtro="expedidorCte">
                            <label class="form-label">Expedidor</label>
                            <div class="input-group input-group-sm">
                                <input type="text" class="form-control" id="filtroExpedidorCte" placeholder="Nome do Expedidor">
                                <button class="btn btn-outline-danger remover-filtro" type="button">&times;</button>
                            </div>
                        </div>
                    `,
                    recebedorCte: `
                        <div class="col-md-3 filtro-item" data-filtro="recebedoraCte">
                            <label class="form-label">Recebedor</label>
                            <div class="input-group input-group-sm">
                                <input type="text" class="form-control" id="filtroRecebedorCte" placeholder="Nome do Recebedor">
                                <button class="btn btn-outline-danger remover-filtro" type="button">&times;</button>
                            </div>
                        </div>
                    `,
                    tomadorCte: `
                        <div class="col-md-3 filtro-item" data-filtro="tomadorCte">
                            <label class="form-label">Tomador</label>
                            <div class="input-group input-group-sm">
                                <input type="text" class="form-control" id="filtroTomadorCte" placeholder="Nome do Tomador">
                                <button class="btn btn-outline-danger remover-filtro" type="button">&times;</button>
                            </div>
                        </div>
                    `,
                    cfopCte: `
                        <div class="col-md-3 filtro-item" data-filtro="cfopCte">
                            <label class="form-label">CFOP</label>
                            <div class="input-group input-group-sm">
                                <input type="text" class="form-control" id="filtroCfopCte" placeholder="CFOP">
                                <button class="btn btn-outline-danger remover-filtro" type="button">&times;</button>
                            </div>
                        </div>
                    `
                };
            }
        }

        // Função para configurar eventos dos filtros
        function configurarEventosFiltros() {
            obterElementosAbaAtiva();
            
            // Remover listeners antigos se existirem
            const selectorNfe = document.getElementById('filtroSelectorNfe');
            const selectorCte = document.getElementById('filtroSelectorCte');
            
            // Configurar evento de adição de filtro para NF-e
            if (selectorNfe) {
                selectorNfe.replaceWith(selectorNfe.cloneNode(true)); // Remove listeners antigos
                const novoSelectorNfe = document.getElementById('filtroSelectorNfe');
                novoSelectorNfe.addEventListener('change', function() {
                    if (tipoDocumentoAtual !== 'nfe') return;
                    const filtro = this.value;
                    const filtrosAtivosNfe = document.getElementById('filtrosAtivosNfe');
                    if (filtro && !filtrosAtivosNfe.querySelector(`[data-filtro="${filtro}"]`)) {
                        filtrosAtivosNfe.insertAdjacentHTML('beforeend', filtrosDisponiveis[filtro]);
                    }
                    this.value = "";
                });
            }
            
            // Configurar evento de adição de filtro para CT-e
            if (selectorCte) {
                selectorCte.replaceWith(selectorCte.cloneNode(true)); // Remove listeners antigos
                const novoSelectorCte = document.getElementById('filtroSelectorCte');
                novoSelectorCte.addEventListener('change', function() {
                    if (tipoDocumentoAtual !== 'cte') return;
                    const filtro = this.value;
                    const filtrosAtivosCte = document.getElementById('filtrosAtivosCte');
                    if (filtro && !filtrosAtivosCte.querySelector(`[data-filtro="${filtro}"]`)) {
                        filtrosAtivosCte.insertAdjacentHTML('beforeend', filtrosDisponiveis[filtro]);
                    }
                    this.value = "";
                });
            }
            
            // Configurar remoção de filtros para ambas as abas
            const filtrosAtivosNfe = document.getElementById('filtrosAtivosNfe');
            const filtrosAtivosCte = document.getElementById('filtrosAtivosCte');
            
            [filtrosAtivosNfe, filtrosAtivosCte].forEach(container => {
                if (container) {
                    container.addEventListener('click', function(e) {
                        if (e.target.classList.contains('remover-filtro')) {
                            e.target.closest('.filtro-item').remove();
                        }
                    });
                }
            });
        }

        // 🔍 Atualiza sua função obterFiltros() para coletar também os dinâmicos:
        function obterFiltrosDocumento() {
            const filtros = {};

            if (tipoDocumentoAtual === 'nfe') {
                // Campos fixos de datas NF-e
                const empresaSelecao = document.getElementById('empresaSelecao')?.value;
                const dataInicial = document.getElementById('dataInicial')?.value;
                const dataFinal = document.getElementById('dataFinal')?.value;

                if (empresaSelecao) filtros.empresa_id = empresaSelecao;
                if (dataInicial) filtros.data_inicial = dataInicial;
                if (dataFinal) filtros.data_final = dataFinal;

                // Filtros dinâmicos NF-e
                const chaveNota = document.getElementById('chaveNota')?.value;
                const emitente = document.getElementById('filtroEmitente')?.value;
                const cnpjEmitente = document.getElementById('filtroCnpjEmitente')?.value;
                const numeroNota = document.getElementById('filtroNumeroNota')?.value;
                const status = document.getElementById('filtroStatus')?.value;
                const modelo = document.getElementById('filtroModelo')?.value;
                const conferencia = document.getElementById('filtroConferencia')?.value;
                const dataRecebimentoSistemaIni = document.getElementById('filtroRecebimentoSistemaIni')?.value;
                const dataRecebimentoSistemaFim = document.getElementById('filtroRecebimentoSistemaFim')?.value;
                const manifestacao = document.getElementById('filtroManifestacao')?.value;

                if (chaveNota) filtros.chave_nota = chaveNota;
                if (emitente) filtros.emitente = emitente;
                if (cnpjEmitente) filtros.cnpj_emitente = cnpjEmitente;
                if (numeroNota) filtros.numero_nota = numeroNota;
                if (status) filtros.status = status;
                if (modelo) filtros.modelo = modelo;
                if (conferencia) filtros.conferencia = conferencia;
                if (dataRecebimentoSistemaIni) filtros.data_recebimento_sistema_ini = dataRecebimentoSistemaIni;
                if (dataRecebimentoSistemaFim) filtros.data_recebimento_sistema_fim = dataRecebimentoSistemaFim;
                if (manifestacao) filtros.manifestacao = manifestacao;

            } else if (tipoDocumentoAtual === 'cte') {
                // Campos fixos de datas CT-e
                const empresaSelecao = document.getElementById('empresaSelecaoCte')?.value;
                const dataInicial = document.getElementById('dataInicialCte')?.value;
                const dataFinal = document.getElementById('dataFinalCte')?.value;

                if (empresaSelecao) filtros.empresa_id = empresaSelecao;
                if (dataInicial) filtros.data_inicial = dataInicial;
                if (dataFinal) filtros.data_final = dataFinal;

                // Filtros dinâmicos CT-e
                const chaveCte = document.getElementById('filtrochaveNotaCte')?.value;
                const transportadora = document.getElementById('filtroTransportadoraCte')?.value;
                const numeroNota = document.getElementById('filtroNumeroCte')?.value;
                const status = document.getElementById('filtroStatusCte')?.value;
                const modelo = document.getElementById('filtroModeloCte')?.value;
                const conferencia = document.getElementById('filtroConferenciaCte')?.value;
                const dataRecebimentoSistemaIni = document.getElementById('filtroRecebimentoSistemaCteIni')?.value;
                const dataRecebimentoSistemaFim = document.getElementById('filtroRecebimentoSistemaCteFim')?.value;
                const remetente = document.getElementById('filtroRemetenteCte')?.value;
                const destinatarioCte = document.getElementById('filtroDestinatarioCte')?.value;
                const expedidor = document.getElementById('filtroExpedidorCte')?.value;
                const recebedor = document.getElementById('filtroRecebedorCte')?.value;
                const tomador = document.getElementById('filtroTomadorCte')?.value;
                const cfopCte = document.getElementById('filtroCfopCte')?.value;
                const tipoCte = document.getElementById('filtroTipoCte')?.value;
                const manifestacao = document.getElementById('filtroManifestacaoCte')?.value;

                if (expedidor) filtros.expedidor = expedidor;
                if (recebedor) filtros.recebedor = recebedor;
                if (tomador) filtros.tomador = tomador;
                if (cfopCte) filtros.cfop = cfopCte;
                if (tipoCte) filtros.tipo = tipoCte;
                if (remetente) filtros.remetente = remetente;
                if (destinatarioCte) filtros.destinatario = destinatarioCte;
                if (chaveCte) filtros.chave_cte = chaveCte;
                if (transportadora) filtros.transportadora = transportadora;
                if (numeroNota) filtros.numero = numeroNota;
                if (status) filtros.status = status;
                if (modelo) filtros.modelo = modelo;
                if (conferencia) filtros.conferencia = conferencia;
                if (dataRecebimentoSistemaIni) filtros.data_recebimento_sistema_ini = dataRecebimentoSistemaIni;
                if (dataRecebimentoSistemaFim) filtros.data_recebimento_sistema_fim = dataRecebimentoSistemaFim;
                if (manifestacao) filtros.manifestacao = manifestacao;
            }

            return filtros;
        }

        //=============================================================================================================
        //================================================= Paginação =================================================
        //=============================================================================================================

        function atualizarPaginacao(data) {
            totalPaginas = data.total_pages;
            
            document.getElementById('registrosInfo').textContent = 
                `${((data.page - 1) * data.per_page) + 1} - ${Math.min(data.page * data.per_page, data.total)} de ${data.total}`;
            
            const paginacao = document.getElementById('paginacao');
            let html = '';
            
            if (data.page > 1) {
                html += `<li class="page-item"><a class="page-link" href="#" onclick="irParaPagina(${data.page - 1})">Anterior</a></li>`;
            } else {
                html += `<li class="page-item disabled"><span class="page-link">Anterior</span></li>`;
            }
            
            const inicio = Math.max(1, data.page - 2);
            const fim = Math.min(data.total_pages, data.page + 2);
            
            for (let i = inicio; i <= fim; i++) {
                if (i === data.page) {
                    html += `<li class="page-item active"><span class="page-link">${i}</span></li>`;
                } else {
                    html += `<li class="page-item"><a class="page-link" href="#" onclick="irParaPagina(${i})">${i}</a></li>`;
                }
            }
            
            if (data.page < data.total_pages) {
                html += `<li class="page-item"><a class="page-link" href="#" onclick="irParaPagina(${data.page + 1})">Próximo</a></li>`;
            } else {
                html += `<li class="page-item disabled"><span class="page-link">Próximo</span></li>`;
            }
            
            paginacao.innerHTML = html;
        }

        function irParaPagina(pagina) {
            paginaAtual = pagina;
            carregarDados();
        }

        //=============================================================================================================
        //============================================= Recarregar Tabela =============================================
        //=============================================================================================================

        function refreshTable() {
            carregarDados();
        }

        //=============================================================================================================
        //========================================== Configuração de colunas ==========================================
        //=============================================================================================================

        const colunasNfe = {
            'checkbox': { label: '<input type="checkbox" onchange="selecionarTodas(this)">', width: '30px', visible: true, class: 'col-checkbox' },
            'empresa': { label: 'Empresa', width: '150px', visible: true, class: 'col-nome' },
            'tipo': { label: 'Tipo XML', width: '90px', visible: true, class: 'col-nome' },
            'tp_nf': { label: 'Operação', width: '90px', visible: true, class: 'col-nome' },
            'tp_emissor': { label: 'Emissão', width: '90px', visible: true, class: 'col-nome' },
            'chave_nota': { label: 'Chave NFe', width: '400px', visible: true, class: 'col-chave' },
            'data_emissao': { label: 'Data Emissão', width: '110px', visible: true, class: 'col-data' },
            'numero': { label: 'Número', width: '90px', visible: true, class: 'col-numero' },
            'modelo': { label: 'Modelo', width: '90px', visible: true, class: 'col-numero' },
            'serie': { label: 'Série', width: '90px', visible: true, class: 'col-numero' },
            'status': { label: 'Situação', width: '100px', visible: true, class: 'col-status' },
            'conferencia': { label: 'Conferência', width: '90px', visible: true, class: 'col-conferencia' },
            'manifestacao': { label: 'Manifestação', width: '180px', visible: true, class: 'col-manifestacao text-center' },
            'emitente': { label: 'Emitente', width: '180px', visible: true, class: 'col-nome' },
            'valor_nfe': { label: 'Valor Nota', width: '120px', visible: true, class: 'col-valor' },
            'destinatario': { label: 'Destinatário', width: '180px', visible: false, class: 'col-nome' },
            'origem': { label: 'Origem', width: '120px', visible: false, class: 'col-nome' },
            'icms': { label: 'ICMS', width: '120px', visible: false, class: 'col-valor' },
            'ipi': { label: 'IPI', width: '120px', visible: false, class: 'col-valor' },
            'pis': { label: 'PIS', width: '120px', visible: false, class: 'col-valor' },
            'cofins': { label: 'COFINS', width: '120px', visible: false, class: 'col-valor' },
            'valor_ibs': { label: 'IBS', width: '120px', visible: false, class: 'col-valor' },
            'valor_cbs': { label: 'CBS', width: '120px', visible: false, class: 'col-valor' },
            'natureza_operacao': { label: 'Natureza Operação', width: '200px', visible: false, class: 'col-nome' },
            'protocolo': { label: 'Protocolo', width: '180px', visible: false, class: 'col-numero' },
            'data_recebimento': { label: 'Data Receb.', width: '120px', visible: false, class: 'col-data' },
            'data_recebimento_sis': { label: 'Receb. Sistema', width: '120px', visible: false, class: 'col-data' },
            'nfe_referenciada': { label: 'NF-e Referenciada', width: '400px', visible: false, class: 'col-chave' },
            'cte_referenciada': { label: 'CT-e Referenciada', width: '400px', visible: false, class: 'col-chave' },
        };

        const colunasCte = {
            'checkbox': { label: '<input type="checkbox" onchange="selecionarTodas(this)">', width: '30px', visible: true, class: 'col-checkbox' },
            'empresa': { label: 'Empresa', width: '150px', visible: true, class: 'col-nome' },
            'chave_cte': { label: 'Chave CTe', visible: true, class: 'col-chave', width: '400px' },
            'data_emissao': { label: 'Data Emissão', width: '110px', visible: true, class: 'col-data' },
            'numero': { label: 'Número', width: '90px', visible: true, class: 'col-numero' },
            'modelo': { label: 'Modelo', width: '90px', visible: true, class: 'col-numero' },
            'serie': { label: 'Série', width: '90px', visible: true, class: 'col-numero' },
            'status': { label: 'Situação', width: '100px', visible: true, class: 'col-status' },
            'conferencia': { label: 'Conferência', width: '90px', visible: true, class: 'col-conferencia' },
            'manifestacao': { label: 'Manifestação', width: '180px', visible: true, class: 'col-manifestacao text-center' },
            'cfop': { label: 'CFOP', width: '90px', visible: true, class: 'col-numero' },
            'valor_frete': { label: 'Valor Frete', width: '120px', visible: true, class: 'col-valor' },
            'data_recebimento_sistema': { label: 'Receb. Sistema', width: '120px', visible: true, class: 'col-data' },
            'transportadora': { label: 'Transportadora', width: '200px', visible: true, class: 'col-nome' },
            'remetente': { label: 'Remetente', width: '200px', visible: false, class: 'col-nome' },
            'destinatario': { label: 'Destinatário', width: '200px', visible: false, class: 'col-nome' },
            'expedidor': { label: 'Expedidor', width: '200px', visible: false, class: 'col-nome' },
            'recebedor': { label: 'Recebedor', width: '200px', visible: false, class: 'col-nome' },
            'tomador': { label: 'Tomador', width: '200px', visible: true, class: 'col-nome' },
            'uf_origem': { label: 'UF Origem', width: '60px', visible: false, class: 'col-uf' },
            'uf_destino': { label: 'UF Destino', width: '60px', visible: false, class: 'col-uf' },
            'icms': { label: 'ICMS', width: '120px', visible: false, class: 'col-valor' },
            'pis': { label: 'PIS', width: '120px', visible: false, class: 'col-valor' },
            'cofins': { label: 'COFINS', width: '120px', visible: false, class: 'col-valor' },
            'total_dfe': { label: 'Total DFe', width: '120px', visible: false, class: 'col-valor' },
            'protocolo': { label: 'Protocolo', width: '180px', visible: false, class: 'col-nome' },
            'natureza_operacao': { label: 'Natureza Operação', width: '200px', visible: false, class: 'col-nome' },
        };


        function abrirConfigColunas() {
            gerarConfigColunas();
            new bootstrap.Modal(document.getElementById('modalConfigColunas')).show();
        }

        function gerarConfigColunas() {
            // NF-e (excluir checkbox da configuração)
            const configNfe = document.getElementById('configColunasNfe');
            let htmlNfe = '';
            for (const [key, config] of Object.entries(colunasNfe)) {
                if (key !== 'checkbox') {
                    htmlNfe += `
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="nfe_${key}" ${config.visible ? 'checked' : ''}>
                            <label class="form-check-label" for="nfe_${key}">
                                ${config.label}
                            </label>
                        </div>
                    `;
                }
            }
            configNfe.innerHTML = htmlNfe;

            // CT-e (excluir checkbox da configuração)
            const configCte = document.getElementById('configColunasCte');
            let htmlCte = '';
            for (const [key, config] of Object.entries(colunasCte)) {
                if (key !== 'checkbox') {
                    htmlCte += `
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="cte_${key}" ${config.visible ? 'checked' : ''}>
                            <label class="form-check-label" for="cte_${key}">
                                ${config.label}
                            </label>
                        </div>
                    `;
                }
            }
            configCte.innerHTML = htmlCte;
        }

        function salvarConfigColunas() {
            // Salvar configuração NF-e
            const configNfeParaSalvar = {};
            for (const key of Object.keys(colunasNfe)) {
                if (key !== 'checkbox') {
                    const checkbox = document.getElementById(`nfe_${key}`);
                    if (checkbox) {
                        colunasNfe[key].visible = checkbox.checked;
                        configNfeParaSalvar[key] = { visible: checkbox.checked };
                    }
                }
            }

            // Salvar configuração CT-e
            const configCteParaSalvar = {};
            for (const key of Object.keys(colunasCte)) {
                if (key !== 'checkbox') {
                    const checkbox = document.getElementById(`cte_${key}`);
                    if (checkbox) {
                        colunasCte[key].visible = checkbox.checked;
                        configCteParaSalvar[key] = { visible: checkbox.checked };
                    }
                }
            }

            localStorage.setItem('configColunasNfe', JSON.stringify(configNfeParaSalvar));
            localStorage.setItem('configColunasCte', JSON.stringify(configCteParaSalvar));

            bootstrap.Modal.getInstance(document.getElementById('modalConfigColunas')).hide();
            carregarDados();
        }

        function carregarConfigSalva() {
            const configNfe = localStorage.getItem('configColunasNfe');
            if (configNfe) {
                const savedConfig = JSON.parse(configNfe);
                // Mesclar apenas a propriedade 'visible'
                for (const key in savedConfig) {
                    if (colunasNfe[key]) {
                        colunasNfe[key].visible = savedConfig[key].visible;
                    }
                }
            }

            const configCte = localStorage.getItem('configColunasCte');
            if (configCte) {
                const savedConfig = JSON.parse(configCte);
                // Mesclar apenas a propriedade 'visible'
                for (const key in savedConfig) {
                    if (colunasCte[key]) {
                        colunasCte[key].visible = savedConfig[key].visible;
                    }
                }
            }
        }

        //=============================================================================================================
        //=============================================== Inicialização ===============================================
        //=============================================================================================================

        if (!window.modalImportSetupDone) { 
            window.modalImportSetupDone = true; 
            console.log("Executando setup inicial do modal de importação (uma vez).");

            document.addEventListener('DOMContentLoaded', function() {
                console.log("DOMContentLoaded disparado."); // Log
                carregarConfigSalva();
                carregarDados();
                limparTabela();
                carregarEmpresas();
                atualizarFiltrosDisponiveis(); 

                const modalImportarXML = document.getElementById('modalImportarXML');
                const modalImportandoElement = document.getElementById('modalImportando');

                if (modalImportarXML && modalImportandoElement) {
                    console.log("Elementos dos modais encontrados, anexando listeners..."); // Log
                    const modalImportando = new bootstrap.Modal(modalImportandoElement, { keyboard: false, backdrop: 'static' });
                    const modalImportarXMLContent = document.getElementById('modalImportarXMLContent');
                    const modalInstance = bootstrap.Modal.getOrCreateInstance(modalImportarXML);

                    let isShowingReport = false; // Flag para controlar se estamos reabrindo para mostrar o relatório
                    let hidingForSpinner = false; // Flag para controlar se estamos fechando para mostrar o spinner
                    let responseDataForResultDisplay = null; // Guarda a resposta do fetch para usar depois

                    // --- Listener para QUANDO O SPINNER TERMINAR DE FECHAR ---
                    modalImportandoElement.addEventListener('hidden.bs.modal', () => {
                        console.log("Spinner ('modalImportando') 'hidden.bs.modal' disparado."); // Log
                        // Só executa se houver dados de resposta pendentes
                        if (responseDataForResultDisplay) {
                            console.log("Dados de resposta encontrados, processando pós-spinner..."); // Log
                            const data = responseDataForResultDisplay;
                            responseDataForResultDisplay = null; // Limpa para a próxima

                            // Mostra o Toast PRIMEIRO
                            if (data.success) {
                                showToast(data.message || 'Importação concluída!', 'success');
                                if (typeof carregarDados === 'function') carregarDados();
                            } else {
                                showToast(data.error || 'Falha na importação.', 'danger');
                            }

                            // Define o flag ANTES de mostrar o modal principal
                            isShowingReport = true;

                            // Define uma função que será chamada QUANDO o modal principal terminar de aparecer
                            const handleModalShown = () => {
                                console.log("Modal principal 'shown.bs.modal' disparado após spinner."); // Log
                                if (data.success) {
                                    if (typeof exibirRelatorioImportacao === 'function') {
                                        exibirRelatorioImportacao(data.sucessos, data.erros); // Passa só os contadores
                                    } else {
                                        console.error("Função exibirRelatorioImportacao não encontrada!");
                                    }
                                }
                            };

                            // Anexa o listener que só roda UMA VEZ para o evento 'shown.bs.modal'
                            modalImportarXML.addEventListener('shown.bs.modal', handleModalShown, { once: true });

                            // AGORA, manda mostrar o modal principal
                            console.log("Mandando reabrir modal principal após spinner."); // Log
                            modalInstance.show();
                        } else {
                            console.log("Nenhum dado de resposta encontrado após spinner fechar."); // Log
                        }
                    });

                    // --- Listener para ANTES DE ABRIR o modal principal ---
                    modalImportarXML.addEventListener('show.bs.modal', async function () {
                        console.log("Modal principal 'show.bs.modal' disparado. isShowingReport:", isShowingReport); // Log

                        // SEMPRE RECARREGA O FORM NO 'show' para garantir que a estrutura do relatório exista
                        console.log("Sempre recarregando form no 'show.bs.modal'..."); // Log
                        modalImportarXMLContent.innerHTML = `<div class="text-center p-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Carregando...</span></div><p class="mt-2">Carregando formulário...</p></div>`;
                        try {
                            const response = await fetch(`/api/documentos-fiscais/?form_modal=true`, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
                            if (!response.ok) throw new Error(`Erro ${response.status}: ${response.statusText}`);
                            modalImportarXMLContent.innerHTML = await response.text();
                            console.log("Formulário carregado/recarregado via fetch no 'show.bs.modal'."); // Log
                        } catch (error) {
                            console.error('Erro ao carregar/recarregar formulário do modal:', error);
                            modalImportarXMLContent.innerHTML = `<div class="alert alert-danger m-0">Erro ao carregar formulário (${error.message}). Tente fechar e abrir novamente.</div>`;
                        } finally {
                            // Reseta o flag aqui, pois a ação de exibir relatório agora é no 'shown'
                            isShowingReport = false;
                        }
                    });

                    // --- Listener para DEPOIS DE FECHAR o modal principal ---
                    modalImportarXML.addEventListener('hidden.bs.modal', function () {
                        console.log("Modal principal 'hidden.bs.modal' disparado. hidingForSpinner:", hidingForSpinner); // Log não precisa mais do isShowingReport aqui
                        // Só limpa se NÃO estivermos escondendo para o spinner
                        if (!hidingForSpinner) {
                            modalImportarXMLContent.innerHTML = ''; // Limpa para a próxima abertura normal
                            console.log("Conteúdo do modal principal limpo."); // Log
                        } else {
                            console.log("Conteúdo do modal principal PRESERVADO (pois hidingForSpinner=true)."); // Log
                        }
                        // Reseta a flag para a próxima vez que o modal for fechado (pelo usuário, etc.)
                        hidingForSpinner = false;
                    });

                    // --- Listener de SUBMIT do formulário ---
                    modalImportarXMLContent.addEventListener('submit', async function(e) {
                        // Garante que estamos capturando o submit do formulário correto
                        if (e.target.id === 'form-importacao-modal') {
                            e.preventDefault();
                            console.log("Submit do formulário de importação capturado."); // Log

                            const form = e.target;
                            const submitButton = form.querySelector('#btn-submit-modal');
                            const formData = new FormData(form);
                            const csrfToken = formData.get('csrfmiddlewaretoken') || (typeof getCookie === 'function' ? getCookie('csrftoken') : '');

                            if (!csrfToken) {
                                console.error("CSRF token não encontrado no formulário!");
                                showToast("Erro de segurança. Recarregue a página.", "danger");
                                return;
                            }

                            if(submitButton) submitButton.disabled = true;
                            if(submitButton) submitButton.querySelector('.btn-text').textContent = 'Processando...';

                            hidingForSpinner = true;
                            console.log("Escondendo modal principal para mostrar spinner..."); // Log
                            modalInstance.hide();

                            // <<< NOVO: Registra o tempo de início >>>
                            const spinnerStartTime = Date.now();

                            // Mostra o spinner DEPOIS que o modal principal começa a fechar
                            setTimeout(() => {
                                console.log("Mostrando spinner..."); // Log
                                modalImportando.show();
                            }, 150);

                            responseDataForResultDisplay = null;

                            try {
                                console.log("Iniciando fetch POST para:", form.action || window.location.pathname); // Log
                                const response = await fetch(form.action || window.location.pathname, {
                                    method: 'POST',
                                    body: formData,
                                    headers: {
                                        'X-CSRFToken': csrfToken,
                                        'X-Requested-With': 'XMLHttpRequest'
                                    }
                                });
                                console.log("Fetch POST concluído. Status:", response.status); // Log

                                const data = await response.json();
                                console.log("Resposta JSON recebida:", data); // Log

                                if (response.ok && data.success) {
                                    console.log("Importação SUCESSO. Guardando dados para exibir."); // Log
                                    responseDataForResultDisplay = data;
                                } else {
                                    console.log("Importação FALHOU (JSON recebido). Guardando erro."); // Log
                                    responseDataForResultDisplay = {
                                        success: false,
                                        error: data.error || `Erro ${response.status}: ${data.detail || 'Resposta inesperada do servidor.'}`
                                    };
                                }
                            } catch (error) {
                                console.error('Erro grave ao submeter importação:', error);
                                responseDataForResultDisplay = {
                                    success: false,
                                    error: `Falha na comunicação ou resposta inválida do servidor. Verifique o console para detalhes.`
                                };
                            } finally {
                                console.log("Bloco finally alcançado."); // Log

                                // <<< NOVO: Calcula o tempo decorrido e o delay necessário >>>
                                const spinnerEndTime = Date.now();
                                const elapsedTime = spinnerEndTime - spinnerStartTime;
                                const minimumVisibleTime = 3000; // 3000 ms = 3 segundos
                                const delayNeeded = Math.max(0, minimumVisibleTime - elapsedTime); // Garante que o delay não seja negativo

                                console.log(`Tempo decorrido: ${elapsedTime}ms. Delay necessário: ${delayNeeded}ms.`); // Log

                                // <<< NOVO: Esconde o spinner APÓS o delay calculado >>>
                                setTimeout(() => {
                                    console.log("Mandando fechar spinner após delay."); // Log
                                    modalImportando.hide();
                                    // O listener 'hidden.bs.modal' do spinner fará o resto
                                }, delayNeeded);

                                // Reabilita o botão imediatamente, mesmo que o spinner fique visível
                                if(submitButton) submitButton.disabled = false;
                                if(submitButton) submitButton.querySelector('.btn-text').textContent = 'Importar XML(s)';
                            }
                        }
                    }); // Fim do listener submit

                } else {
                    console.error("Erro Crítico: Modal de importação (#modalImportarXML) ou Modal de Spinner (#modalImportando) não encontrados no DOM! A funcionalidade de importação não funcionará.");
                } // Fim do if (elementos existem)

            }); 
        } // Fim do if (!window.modalImportSetupDone)

        //=============================================================================================================
        //========================================= Selecionar Todas as Notas =========================================
        //=============================================================================================================

        function selecionarTodas(checkbox) {
            const checkboxes = document.querySelectorAll('.checkbox-nota');
            checkboxes.forEach(cb => {
                cb.checked = checkbox.checked;
            });
            atualizarContadorSelecionados();
        }

        function atualizarContadorSelecionados() {
            // 1. Determina o ID do tbody da tabela ativa
            const tabelaBodyId = tipoDocumentoAtual === 'nfe' ? 'tabelaNotasNfe' : 'tabelaNotasCte';
            const tabelaBodyAtiva = document.getElementById(tabelaBodyId);

            // 2. Conta apenas os checkboxes DENTRO do tbody ativo
            const selecionados = tabelaBodyAtiva ? tabelaBodyAtiva.querySelectorAll('.checkbox-nota:checked').length : 0;

            const contador = document.getElementById('contadorSelecionados');
            const toolbar = document.getElementById('selectionToolbar');
            const btnDANFELote = document.getElementById('btnDANFELote'); // Pega o botão DANFE/DACTE

            if (contador) {
                contador.textContent = selecionados;
            }

            if (toolbar) {
                if (selecionados > 0) {
                    toolbar.classList.add('show');
                    // ✅ Atualiza o texto do botão DANFE/DACTE dinamicamente
                    if (btnDANFELote) {
                        btnDANFELote.innerHTML = tipoDocumentoAtual === 'nfe'
                            ? '<i class="fas fa-file-pdf me-1"></i> Baixar DANFEs'
                            : '<i class="fas fa-file-pdf me-1"></i> Baixar DACTEs';
                    }
                } else {
                    toolbar.classList.remove('show');
                }
            }
        }

        function limparSelecoes() {
            const checkboxes = document.querySelectorAll('.checkbox-nota');
            checkboxes.forEach(cb => cb.checked = false);
            
            const checkboxTodos = document.querySelector('input[type="checkbox"][onchange="selecionarTodas(this)"]');
            if (checkboxTodos) {
                checkboxTodos.checked = false;
            }
            
            atualizarContadorSelecionados();
        }

        document.addEventListener('keydown', function(event) {
            // 1. Verifica se a combinação de teclas foi CTRL + A
            // Usamos .toLowerCase() para funcionar mesmo se o Caps Lock estiver ativo
            if (event.ctrlKey && event.key.toLowerCase() === 'a') {
                
                // 2. Previne o comportamento padrão do navegador (que é selecionar todo o texto da página)
                event.preventDefault();
                
                // 3. Pega todas as checkboxes de nota na página
                const checkboxes = document.querySelectorAll('.checkbox-nota');
                if (checkboxes.length === 0) {
                    return; // Sai da função se não houver checkboxes na página
                }

                // 4. Lógica de Toggling (Marcar/Desmarcar)
                // Verifica se o número de checkboxes marcadas é diferente do total.
                // Se for diferente, significa que devemos marcar todas.
                // Se for igual, significa que todas já estão marcadas, então devemos desmarcar.
                const totalCheckboxes = checkboxes.length;
                const totalMarcadas = document.querySelectorAll('.checkbox-nota:checked').length;
                const marcarTodas = totalMarcadas !== totalCheckboxes;

                // 5. Aplica a ação a todas as checkboxes
                checkboxes.forEach(checkbox => {
                    checkbox.checked = marcarTodas;
                });

                // Dica: Se você tiver uma função que atualiza um contador de itens selecionados,
                // você pode chamá-la aqui para dar um feedback visual ao usuário.
                atualizarContadorSelecionados();
            }
        });

        //=============================================================================================================
        //========================================= Carregamento das Empresas ==========================================
        //=============================================================================================================

        async function carregarEmpresas() {
            try {
                const response = await fetch('/api/logs/empresas/');
                const data = await response.json();

                if (!data.success) return console.error('Erro ao buscar empresas:', data.error);

                const selectNfe = document.getElementById('empresaSelecao');
                const selectCte = document.getElementById('empresaSelecaoCte');
                const selectLog = document.getElementById('filtroEmpresaLog');

                function popularSelect(selectElement) {
                    if (!selectElement) return;

                    selectElement.innerHTML = `
                        <option value="" selected disabled>Selecione uma empresa</option>
                        <option value="todas">Todas</option>
                    `;

                    data.empresas.forEach(empresa => {
                        const option = document.createElement('option');
                        option.value = empresa.id;
                        option.textContent = `${formatarCPFCNPJ(empresa.cnpj_cpf)} - ${empresa.razao_social}`;
                        selectElement.appendChild(option);
                    });

                    // Ao mudar empresa → recarrega dados
                    selectElement.addEventListener('change', () => {
                        paginaAtual = 1;
                        carregarDados();
                    });
                }

                popularSelect(selectNfe);
                popularSelect(selectCte);
                popularSelect(selectLog);

            } catch (error) {
                console.error('Erro ao carregar empresas:', error);
            }
        }


        //=============================================================================================================
        //================================================ Modal Logs =================================================
        //=============================================================================================================

        let paginaAtualLog = 1;
        let totalPaginasLog = 1;

        function abrirModalLogs() {
            // Limpar filtros
            document.getElementById('filtroEmpresaLog').value = '';
            document.getElementById('filtroTipoNotaLog').value = '';
            //document.getElementById('filtroTipoBuscaLog').value = '';
            document.getElementById('filtroStatusLog').value = '';
            document.getElementById('filtroDataInicialLog').value = '';
            document.getElementById('filtroDataFinalLog').value = '';
            
            paginaAtualLog = 1;
            
            // Carregar empresas para o filtro
            carregarEmpresas();
            
            // Carregar logs
            carregarLogs();
            
            // Abrir modal
            const modal = new bootstrap.Modal(document.getElementById('modalLogs'));
            modal.show();
        }

        /**
         * Carrega os logs de consultas
         */
        async function carregarLogs() {
            const tbody = document.getElementById('tabelaLogs');
            
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                        <p class="mt-2 mb-0">Carregando logs...</p>
                    </td>
                </tr>
            `;
            
            try {
                const filtros = obterFiltrosLogs();
                const params = new URLSearchParams({
                    page: paginaAtualLog,
                    per_page: 20,
                    ...filtros
                });
                
                const response = await fetch(`/api/logs/consultas/?${params}`);
                const data = await response.json();
                
                if (response.ok && data.success) {
                    renderizarTabelaLogs(data.dados);
                    atualizarPaginacaoLogs(data);
                } else {
                    throw new Error(data.error || 'Erro ao carregar logs');
                }
            } catch (error) {
                console.error('Erro:', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-4">
                            <i class="fas fa-exclamation-triangle fa-2x text-warning mb-3"></i>
                            <p class="text-muted">Erro ao carregar logs: ${error.message}</p>
                        </td>
                    </tr>
                `;
            }
        }

        /**
         * Obtém os filtros aplicados
         */
        function obterFiltrosLogs() {
            const filtros = {};
            
            const empresaId = document.getElementById('filtroEmpresaLog').value;
            const tipoNota = document.getElementById('filtroTipoNotaLog').value;
            //const tipoBusca = document.getElementById('filtroTipoBuscaLog').value;
            const status = document.getElementById('filtroStatusLog').value;
            const dataInicial = document.getElementById('filtroDataInicialLog').value;
            const dataFinal = document.getElementById('filtroDataFinalLog').value;
            
            if (empresaId) filtros.empresa_id = empresaId;
            if (tipoNota) filtros.tipo_nota = tipoNota;
            //if (tipoBusca) filtros.tipo_busca = tipoBusca;
            if (status) filtros.status = status;
            if (dataInicial) filtros.data_inicial = dataInicial;
            if (dataFinal) filtros.data_final = dataFinal;
            
            return filtros;
        }

        /**
         * Renderiza a tabela de logs
         */
        function renderizarTabelaLogs(dados) {
            const tbody = document.getElementById('tabelaLogs');
            
            if (dados.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-4">
                            <i class="fas fa-inbox fa-2x text-muted mb-3"></i>
                            <p class="text-muted">Nenhum log encontrado</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            const linhas = dados.map(log => {
                const statusBadge = getStatusBadgeLog(log.status_valor);
                const tipoNotaBadge = getTipoNotaBadge(log.tipo_nota_valor);
                
                return `
                    <tr>
                        <td>${log.empresa}</td>
                        <td>${tipoNotaBadge}</td>
                        <td><span class="badge secondary">${log.tipo_busca}</span></td>
                        <td>${log.dt_retorno || '-'}</td>
                        <td>${statusBadge}</td>
                        <td>${log.retorno || '-'}</td>
                        <td>${log.prox_consulta || '-'}</td>
                    </tr>
                `;
            }).join('');
            
            tbody.innerHTML = linhas;
        }

        /**
         * Retorna badge de status do log
         */
        function getStatusBadgeLog(status) {
            const badges = {
                '2': { class: 'success', text: 'Sucesso' },
                '3': { class: 'danger', text: 'Erro' },
                '4': { class: 'warning', text: 'Advertência' },
                '1': { class: 'info', text: 'Informação' }
            };
            
            const badge = badges[status] || { class: 'secondary', text: 'Desconhecido' };
            return `<span class="badge ${badge.class}">${badge.text}</span>`;
        }

        /**
         * Retorna badge do tipo de nota
         */
        function getTipoNotaBadge(tipo) {
            const badges = {
                '1': { class: 'warning', text: 'NF-e' },
                '2': { class: 'warning', text: 'NFC-e' },
                '3': { class: 'warning', text: 'CT-e' },
                '4': { class: 'warning', text: 'NFS-e' },
            };
            
            const badge = badges[tipo] || { class: 'secondary', text: tipo };
            return `<span class="badge ${badge.class}">${badge.text}</span>`;
        }

        /**
         * Atualiza a paginação dos logs
         */
        function atualizarPaginacaoLogs(data) {
            totalPaginasLog = data.total_pages;
            
            document.getElementById('registrosInfoLog').textContent = 
                `${((data.page - 1) * data.per_page) + 1} - ${Math.min(data.page * data.per_page, data.total)} de ${data.total}`;
            
            const paginacao = document.getElementById('paginacaoLogs');
            let html = '';
            
            // Botão Anterior
            if (data.page > 1) {
                html += `<li class="page-item">
                    <a class="page-link" href="#" onclick="irParaPaginaLog(${data.page - 1}); return false;">
                        Anterior
                    </a>
                </li>`;
            } else {
                html += `<li class="page-item disabled">
                    <span class="page-link">Anterior</span>
                </li>`;
            }
            
            // Números de página
            const inicio = Math.max(1, data.page - 2);
            const fim = Math.min(data.total_pages, data.page + 2);
            
            for (let i = inicio; i <= fim; i++) {
                if (i === data.page) {
                    html += `<li class="page-item active">
                        <span class="page-link">${i}</span>
                    </li>`;
                } else {
                    html += `<li class="page-item">
                        <a class="page-link" href="#" onclick="irParaPaginaLog(${i}); return false;">
                            ${i}
                        </a>
                    </li>`;
                }
            }
            
            // Botão Próximo
            if (data.page < data.total_pages) {
                html += `<li class="page-item">
                    <a class="page-link" href="#" onclick="irParaPaginaLog(${data.page + 1}); return false;">
                        Próximo
                    </a>
                </li>`;
            } else {
                html += `<li class="page-item disabled">
                    <span class="page-link">Próximo</span>
                </li>`;
            }
            
            paginacao.innerHTML = html;
        }

        /**
         * Navega para uma página específica
         */
        function irParaPaginaLog(pagina) {
            paginaAtualLog = pagina;
            carregarLogs();
        }

        /**
         * Aplica os filtros selecionados
         */
        function aplicarFiltrosLogs() {
            paginaAtualLog = 1;
            carregarLogs();
        }

        /**
         * Limpa todos os filtros
         */
        function limparFiltrosLogs() {
            document.getElementById('filtroEmpresaLog').value = '';
            document.getElementById('filtroTipoNotaLog').value = '';
            //document.getElementById('filtroTipoBuscaLog').value = '';
            document.getElementById('filtroStatusLog').value = '';
            document.getElementById('filtroDataInicialLog').value = '';
            document.getElementById('filtroDataFinalLog').value = '';
            aplicarFiltrosLogs();
        }


        //=============================================================================================================
        //=========================================== Manifestação de Notas ===========================================
        //=============================================================================================================

        // Função para abrir o modal de manifestação
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOMContentLoaded event fired!");
            const modalManifestacao = document.getElementById('modalManifestacao');
            const operacaoSelect = document.getElementById('operacao');
            const justificativaContainer = document.getElementById('justificativaContainer');
            const justificativaTextarea = document.getElementById('justificativa');
            const justificativaCounter = document.getElementById('justificativaCounter');
            const formManifestacao = document.getElementById('formManifestacao');

            // --- Verificações Cruciais ---
            if (!formManifestacao) {
                console.error("FALHA CRÍTICA: Elemento <form id='formManifestacao'> NÃO encontrado no DOM!");
                // Se esta mensagem aparecer, o script está rodando antes do form existir.
                // Possíveis soluções: Mover o script para o final do <body> ou garantir
                // que o modal HTML esteja presente no carregamento inicial da página.
                return; // Interrompe a execução se o form não existe
            } else {
                console.log("SUCESSO: Elemento <form id='formManifestacao'> encontrado:", formManifestacao);
            }

            if (!modalManifestacao) console.warn("Aviso: Elemento #modalManifestacao não encontrado.");
            if (!operacaoSelect) console.warn("Aviso: Elemento #operacao não encontrado.");

            const opcoesManifestacao = {
                nfe: [
                    { value: "", text: "Selecione uma opção" },
                    { value: "1", text: "210200 – Confirmação da Operação" },
                    { value: "2", text: "210210 – Ciência da Emissão" },
                    { value: "3", text: "210220 – Desconhecimento da Operação" },
                    { value: "4", text: "210240 – Operação não Realizada" },
                ],
                cte: [
                    { value: "", text: "Selecione uma opção" },
                    { value: "4", text: "610110 – Prestação do Serviço em Desacordo" },
                    { value: "1", text: "610111 – Cancelamento da Prestação do Serviço em Desacordo" },
                ]
            };

            // Função para atualizar as opções de manifestação com base no tipo de documento
            function atualizarOpcoesOperacao(tipoDocumentoAtual) {
                const operacaoSelect = document.getElementById('operacao');
                operacaoSelect.innerHTML = ""; // limpa opções atuais

                const opcoes = opcoesManifestacao[tipoDocumentoAtual] || opcoesManifestacao['nfe'];

                opcoes.forEach(op => {
                    const option = document.createElement('option');
                    option.value = op.value;
                    option.textContent = op.text;
                    operacaoSelect.appendChild(option);
                });
            }

            // Função para abrir o modal (chame esta função no botão da sua página)
            window.abrirModalManifestacao = function(chaveNfe, tipoDocumentoAtual) {
                // Limpar formulário
                formManifestacao.reset();
                justificativaContainer.style.display = 'none';

                // Atualiza as opções conforme aba selecionada
                atualizarOpcoesOperacao(tipoDocumentoAtual);

                document.getElementById('chaveNfe').value = chaveNfe;
                document.getElementById('chaveDisplay').value = formatarChaveNfe(chaveNfe);

                // Define a ação correta (caso queira alterar a URL também)
                if (tipoDocumentoAtual === 'cte') {
                    formManifestacao.action = "/manifestar-cte/";
                    document.getElementById('modalManifestacaoLabel').innerHTML = 
                        '<i class="fas fa-file-alt me-2"></i>Manifestação de CT-e';
                } else {
                    formManifestacao.action = "/manifestar-nfe/";
                    document.getElementById('modalManifestacaoLabel').innerHTML = 
                        '<i class="fas fa-file-invoice me-2"></i>Manifestação de NF-e';
                }

                // Define os dados
                document.getElementById('chaveNfe').value = chaveNfe;
                document.getElementById('chaveDisplay').value = formatarChaveNfe(chaveNfe);
            
                // Abrir modal
                const modal = new bootstrap.Modal(modalManifestacao);
                modal.show();
            };

            // Formatar chave NF-e para exibição
            function formatarChaveNfe(chave) {
                if (chave.length === 44) {
                    return chave.match(/.{1,4}/g).join(' ');
                }
                return chave;
            }

            if (operacaoSelect) {
                // Controlar exibição da justificativa
                operacaoSelect.addEventListener('change', function() {
                    const operacao = this.value;
                    
                    if (operacao === '4') {
                        justificativaContainer.style.display = 'block';
                        justificativaContainer.classList.add('show');
                        justificativaTextarea.setAttribute('required', 'required');
                    } else {
                        justificativaContainer.style.display = 'none';
                        justificativaContainer.classList.remove('show');
                        justificativaTextarea.removeAttribute('required');
                        justificativaTextarea.value = '';
                    }
                });
                console.log("Listener 'change' anexado a #operacao.");
            }

            if (justificativaTextarea) {
                // Contador de caracteres
                justificativaTextarea.addEventListener('input', function() {
                    const length = this.value.length;
                    justificativaCounter.innerHTML = `<small class="text-muted">${length}/255 caracteres</small>`;
                    
                    // Validação visual
                    if (length > 0 && length < 15) {
                        this.classList.add('is-invalid');
                        this.classList.remove('is-valid');
                    } else if (length >= 15) {
                        this.classList.add('is-valid');
                        this.classList.remove('is-invalid');
                    } else {
                        this.classList.remove('is-valid', 'is-invalid');
                    }
                });
                console.log("Listener 'input' anexado a #justificativa.");
            }

            // Validação do formulário
            formManifestacao.addEventListener('submit', async function(e) {
                e.preventDefault();

                const operacao = operacaoSelect.value;
                const justificativa = justificativaTextarea.value.trim();

                if (!operacao) {;
                    alert('Por favor, selecione o tipo de manifestação.');
                    operacaoSelect.focus();
                    return false;
                }

                if (operacao === '4') {
                    if (!justificativa || justificativa.length < 15) {
                        alert('A justificativa deve ter no mínimo 15 caracteres para "Operação não Realizada".');
                        justificativaTextarea.focus();
                        return false;
                    }
                }

                // Desabilitar botão para evitar duplo clique
                const btnManifestar = document.getElementById('btnManifestar');
                btnManifestar.disabled = true;
                btnManifestar.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Processando...';

                try {
                    // A URL da action do form já deve estar correta (nfe ou cte)
                    const response = await fetch(formManifestacao.action, {
                        method: 'POST',
                        body: new FormData(formManifestacao), // Se estiver usando FormData
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken')
                            // Não defina 'Content-Type' se estiver usando FormData
                        }
                        // Se estiver enviando JSON, ajuste o body e headers como na exclusão
                    });

                    // Adapte a verificação de sucesso conforme a resposta do seu backend
                    const result = await response.json(); // Ou .text() se não for JSON

                    if (response.ok && result.success) { // <<< SUCESSO DA MANIFESTAÇÃO
                        const modal = bootstrap.Modal.getInstance(modalManifestacao);
                        modal.hide();

                        showToast(result.message || 'Manifestação realizada com sucesso!', 'success');

                        carregarDados();

                    } else {
                        // Tratar erro (mostrar toast, mensagem no modal, etc.)
                        const errorMessage = result.error || 'Falha ao realizar a manifestação.';
                        showToast(errorMessage, 'danger');
                        // Pode reativar o botão aqui ou no finally
                    }

                } catch (error) {
                    showToast('Erro de conexão ao tentar manifestar.', 'danger');
                } finally {
                    // Reabilitar botão
                    if(btnManifestar){
                        btnManifestar.disabled = false;
                        btnManifestar.innerHTML = '<i class="fas fa-paper-plane me-1"></i>Manifestar';
                    }
                }
            });
            console.log("SUCESSO: Listener 'submit' anexado a #formManifestacao.");

        });

        
        //=============================================================================================================
        //=========================================== Logs de Manifestação ============================================
        //=============================================================================================================

        async function abrirModalLogManifesto(chaveNota) {
            const modalElement = document.getElementById('modalLogManifesto');
            const modal = bootstrap.Modal.getOrCreateInstance(modalElement);
            const tbody = document.getElementById('tabelaLogManifesto');
            const modalTitulo = document.getElementById('modalLogManifestoLabel');

            if (!tipoDocumentoAtual) {
                const abaAtiva = document.querySelector('.nav-link.active');
                tipoDocumentoAtual = abaAtiva ? abaAtiva.getAttribute('data-tipo') : 'nfe';
            }

             // 🧭 Ajusta URL de busca conforme tipo de documento
            const url = tipoDocumentoAtual === 'cte'
                ? `/api/manifesto/logs/cte/${chaveNota}/`
                : `/api/manifesto/logs/nfe/${chaveNota}/`;

            // 🏷️ Ajusta o título do modal
            modalTitulo.innerHTML = tipoDocumentoAtual === 'cte'
                ? `<i class="fas fa-history me-2"></i>Logs de CT-e`
                : `<i class="fas fa-history me-2"></i>Logs de NF-e`;

            // 1. Mostrar estado de carregamento e abrir o modal
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                        <p class="mt-2 mb-0">Buscando histórico...</p>
                    </td>
                </tr>
            `;
            modal.show();

            // 2. Fazer a chamada à API
            try {
                const response = await fetch(url);
                const logs = await response.json();

                if (!response.ok) {
                    throw new Error(logs.error || 'Erro ao buscar os dados.');
                }

                // 3. Renderizar os dados no modal
                if (logs.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center py-4">
                                <i class="fas fa-inbox fa-2x text-muted mb-2"></i>
                                <p class="text-muted mb-0">Nenhum histórico de manifestação encontrado para esta nota.</p>
                            </td>
                        </tr>
                    `;
                } else {
                    const linhasHtml = logs.map(log => {
                        // Badge para o status do evento
                        const statusBadge = log.cstat_evento === '135' || log.cstat_evento === '100' // Sucesso
                            ? `<span class="badge bg-success">${log.cstat_evento}</span>`
                            : `<span class="badge bg-danger">${log.cstat_evento || 'N/A'}</span>`;

                        return `
                            <tr>
                                <td>${log.data_evento || 'N/A'}</td>
                                <td>${log.usuario || 'Sistema'}</td>
                                <td>${log.tipo_display || 'N/A'}</td>
                                <td>${log.evento || 'N/A'}</td>
                                <td>${statusBadge}</td>
                                <td>${log.xmotivo_evento || 'N/A'}</td>
                            </tr>
                        `;
                    }).join('');
                    tbody.innerHTML = linhasHtml;
                }

            } catch (error) {
                console.error('Erro ao carregar histórico de manifesto:', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-danger py-4">
                            <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                            <p class="mb-0">Falha ao carregar o histórico. Tente novamente.</p>
                            <small>${error.message}</small>
                        </td>
                    </tr>
                `;
            }
        }

        //=============================================================================================================
        //============================================== Exportar Excel ===============================================
        //=============================================================================================================

        function exportarExcel(scope) { // scope pode ser 'page' ou 'all'
            // 1. Obter o tipo de documento atual
            //    (a variável tipoDocumentoAtual já deve existir no seu script)
            if (!tipoDocumentoAtual) {
                console.error("Tipo de documento atual não definido.");
                alert("Erro: Tipo de documento não selecionado.");
                return;
            }

            // 2. Obter filtros atuais
            const filtros = obterFiltrosDocumento(); // Usa a função que você já tem

            // 3. Obter colunas visíveis
            const colunasConfig = tipoDocumentoAtual === 'nfe' ? colunasNfe : colunasCte;
            const colunasVisiveisKeys = Object.entries(colunasConfig)
                                            .filter(([key, config]) => config.visible && key !== 'checkbox') // Exclui checkbox
                                            .map(([key, config]) => key);

            if (colunasVisiveisKeys.length === 0) {
                alert("Nenhuma coluna está visível para exportação.");
                return;
            }
            const colunasVisiveisParam = colunasVisiveisKeys.join(',');

            // 4. Montar a URL base para exportação
            const baseUrl = "/api/documentos/exportar/"; // Usa a URL definida no Django
            const params = new URLSearchParams();

            // 5. Adicionar parâmetros básicos
            params.append('tipo', tipoDocumentoAtual);
            params.append('export_scope', scope);
            params.append('colunas_visiveis', colunasVisiveisParam);

            // 6. Adicionar filtros à URL
            for (const [key, value] of Object.entries(filtros)) {
                if (value !== null && value !== undefined && value !== '') {
                    params.append(key, value);
                }
            }

            // 7. Adicionar paginação se for 'page'
            //    (as variáveis paginaAtual e per_page já devem existir no seu script)
            if (scope === 'page') {
                params.append('page', paginaAtual || 1);
                // Defina um valor padrão para per_page se não existir
                const perPageAtual = 100; // Ou pegue de uma variável se você tiver
                params.append('per_page', perPageAtual);
            }

            // 8. Construir a URL final
            const urlFinal = `${baseUrl}?${params.toString()}`;

            // 9. Abrir a URL (o navegador iniciará o download)
            //    Abrir em nova aba é uma boa prática para downloads
            window.open(urlFinal, '_blank');
        }

        //=============================================================================================================
        //============================================== Exclusão Segura ==============================================
        //=============================================================================================================

        const modalExclusaoElement = document.getElementById('modalConfirmarExclusao');
        const modalExclusao = new bootstrap.Modal(modalExclusaoElement);
        const formExclusao = document.getElementById('formConfirmarExclusao');
        const inputChavesExcluir = document.getElementById('chavesParaExcluir');
        const inputTipoExcluir = document.getElementById('tipoParaExcluir');
        const inputSenhaExclusao = document.getElementById('senhaConfirmacaoExclusao');
        const errorExclusaoDiv = document.getElementById('errorExclusao');
        const contagemExclusaoSpan = document.getElementById('contagemExclusao');
        const btnSubmitExclusao = document.getElementById('btnConfirmarExclusaoSubmit');

        /**
         * Abre o modal de confirmação para exclusão individual.
         */
        function abrirModalExclusao(chave, tipo) {
            if (!chave || !tipo) return;

            inputChavesExcluir.value = JSON.stringify([chave]); // Envia como array
            inputTipoExcluir.value = tipo;
            contagemExclusaoSpan.textContent = '1 documento';

            // Resetar modal
            inputSenhaExclusao.value = '';
            errorExclusaoDiv.classList.add('d-none');
            errorExclusaoDiv.textContent = '';
            btnSubmitExclusao.disabled = false;
            btnSubmitExclusao.innerHTML = '<i class="fas fa-trash-alt me-1"></i> Confirmar Exclusão';

            modalExclusao.show();
        }

        /**
         * Abre o modal de confirmação para exclusão em lote.
         */
        function abrirModalExclusaoLote() {
            const checkboxes = document.querySelectorAll('.checkbox-nota:checked');
            const chaves = Array.from(checkboxes).map(cb => cb.value);

            if (chaves.length === 0) {
                alert('Selecione pelo menos um documento para excluir.');
                return;
            }

            inputChavesExcluir.value = JSON.stringify(chaves);
            inputTipoExcluir.value = tipoDocumentoAtual; // Usa a variável global
            contagemExclusaoSpan.textContent = `${chaves.length} documento(s)`;

            // Resetar modal
            inputSenhaExclusao.value = '';
            errorExclusaoDiv.classList.add('d-none');
            errorExclusaoDiv.textContent = '';
            btnSubmitExclusao.disabled = false;
            btnSubmitExclusao.innerHTML = '<i class="fas fa-trash-alt me-1"></i> Confirmar Exclusão';

            modalExclusao.show();
        }

        /**
         * Manipulador para o envio do formulário de exclusão.
         */
        formExclusao.addEventListener('submit', async function(event) {
            event.preventDefault(); // Impede o envio padrão do formulário

            const chaves = inputChavesExcluir.value; // Já está como string JSON
            const tipo = inputTipoExcluir.value;
            const password = inputSenhaExclusao.value;
            const csrfToken = this.querySelector('[name=csrfmiddlewaretoken]').value;

            if (!password) {
                errorExclusaoDiv.textContent = 'Por favor, digite sua senha.';
                errorExclusaoDiv.classList.remove('d-none');
                return;
            }

            // Mostrar loading e desabilitar botão
            btnSubmitExclusao.disabled = true;
            btnSubmitExclusao.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Excluindo...';
            errorExclusaoDiv.classList.add('d-none');

            try {
                const response = await fetch("/api/documentos/excluir/", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({
                        chaves: JSON.parse(chaves), // Envia como array JS
                        password: password,
                        tipo: tipo
                    })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    modalExclusao.hide();
                    // Exibir mensagem de sucesso (você pode usar um toast aqui)
                    showToast(result.message || 'Documento(s) excluído(s) com sucesso!', 'success');
                    limparSelecoes(); // Limpa checkboxes marcados
                    carregarDados(); // Recarrega a tabela
                } else {
                    // Exibir erro no modal
                    const errorMessage = result.error || `Erro ${response.status}: ${response.statusText}`;
                    errorExclusaoDiv.textContent = errorMessage;
                    errorExclusaoDiv.classList.remove('d-none');
                    inputSenhaExclusao.value = ''; // Limpa senha
                    inputSenhaExclusao.focus();
                    // Mostra o toast também, caso o erro não seja corrigível no modal
                    showToast(errorMessage, 'danger');
                }

            } catch (error) {
                console.error("Erro na requisição de exclusão:", error);
                const networkErrorMessage = 'Erro de conexão ou requisição. Verifique sua rede e tente novamente.';
                errorExclusaoDiv.textContent = networkErrorMessage;
                errorExclusaoDiv.classList.remove('d-none');
                // Mostrar toast
                showToast(networkErrorMessage, 'danger');
            } finally {
                // Reabilitar botão (mesmo em caso de erro)
                btnSubmitExclusao.disabled = false;
                btnSubmitExclusao.innerHTML = '<i class="fas fa-trash-alt me-1"></i> Confirmar Exclusão';
            }
        });

        // Limpar senha ao fechar o modal (por segurança)
        modalExclusaoElement.addEventListener('hidden.bs.modal', function () {
            inputSenhaExclusao.value = '';
            errorExclusaoDiv.classList.add('d-none');
            errorExclusaoDiv.textContent = '';
            // Reabilitar botão caso o usuário feche antes de terminar
            btnSubmitExclusao.disabled = false;
            btnSubmitExclusao.innerHTML = '<i class="fas fa-trash-alt me-1"></i> Confirmar Exclusão';
        });

        //=============================================================================================================
        //=========================================== Atualizar Conferência ===========================================
        //=============================================================================================================

        /**
         * Função chamada pelos botões individuais e de lote para alterar o status de conferência.
         * @param {string[]} chaves - Array com as chaves dos documentos a serem atualizados.
         * @param {string} novoStatus - O novo status desejado ("Conferida" ou "Não Conferida").
         * @param {HTMLElement} [buttonElement] - O elemento do botão clicado (opcional, para feedback de loading).
         */
        async function toggleConferenciaStatus(chaves, novoStatus, buttonElement = null) {
            if (!chaves || chaves.length === 0 || !novoStatus) {
                console.error("Dados inválidos para atualizar conferência.");
                return;
            }

            const csrfToken = getCookie('csrftoken'); // Sua função getCookie existente
            let originalButtonHtml = null;

            // Feedback de loading no botão, se fornecido
            if (buttonElement) {
                originalButtonHtml = buttonElement.innerHTML;
                buttonElement.disabled = true;
                // Adapte o loading para o tipo de botão (link dropdown ou botão normal)
                if (buttonElement.tagName === 'A') {
                    buttonElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';
                } else {
                    buttonElement.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Aguarde...';
                }
            }

            try {
                const response = await fetch("/api/documentos/conferencia/", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({
                        chaves: chaves,
                        status: novoStatus,
                        tipo: tipoDocumentoAtual // Usa a variável global
                    })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    showToast(result.message, 'success');

                    // Atualizar a interface do usuário para cada chave atualizada
                    chaves.forEach(chave => {
                        atualizarLinhaConferenciaUI(chave, result.novo_status);
                    });

                    // Se foi ação em lote, limpar seleções
                    if (chaves.length > 1) {
                        limparSelecoes();
                    }

                } else {
                    showToast(result.error || `Erro ${response.status}: Falha ao atualizar.`, 'danger');
                }

            } catch (error) {
                console.error("Erro na requisição de conferência:", error);
                showToast('Erro de conexão ou requisição. Tente novamente.', 'danger');
            } finally {
                // Restaurar botão, se fornecido
                if (buttonElement && originalButtonHtml) {
                    buttonElement.disabled = false;
                    buttonElement.innerHTML = originalButtonHtml;
                    // Pode ser necessário re-renderizar a linha ou re-atribuir o onclick
                    // para garantir que o próximo clique funcione corretamente
                    // A abordagem mais simples é recarregar os dados, mas menos ideal para UX
                    // carregarDados(); // Descomente se a atualização da UI falhar no próximo clique
                }
                // Restaurar botões de lote (se eles foram usados)
                restaurarBotoesConferenciaLote();
            }
        }

        /**
         * Função auxiliar para atualizar a aparência da linha da tabela após a mudança de status.
         * @param {string} chave - A chave do documento que foi atualizado.
         * @param {string} novoStatus - O novo status ("Conferida" ou "Não Conferida").
         */
        function atualizarLinhaConferenciaUI(chave, novoStatus) {
            const linha = document.querySelector(`tr[data-chave="${chave}"]`);
            if (!linha) return;

            const celulaConferencia = linha.querySelector('td.col-conferencia');
            const linkAcaoConferencia = linha.querySelector(`.col-acoes a[onclick*="toggleConferenciaStatus(['${chave}']"]`); // Encontra o link de ação

            if (celulaConferencia) {
                let badgeClass = 'bg-secondary';
                if (novoStatus === 'Conferida') {
                    badgeClass = 'bg-success';
                }
                // Define o innerHTML da célula para o novo badge
                celulaConferencia.innerHTML = `<span class="badge ${badgeClass}">${novoStatus}</span>`;
            }

            // Atualizar o botão/link de ação individual na linha
            if (linkAcaoConferencia) {
                const ehConferida = novoStatus === 'Conferida';
                const proximoStatusOnClick = ehConferida ? 'Não Conferida' : 'Conferida';
                const textoBotao = ehConferida ? 'Desmarcar Conferência' : 'Marcar como Conferida';
                const icone = ehConferida ? 'fa-times-circle' : 'fa-check-circle';
                //const corTexto = ehConferida ? 'text-warning' : 'text-success';

                //linkAcaoConferencia.classList.remove('text-success', 'text-warning');
                //linkAcaoConferencia.classList.add(corTexto);
                linkAcaoConferencia.onclick = function() { toggleConferenciaStatus([chave], proximoStatusOnClick, this); return false; }; // Atualiza o onclick

                const iconeElemento = linkAcaoConferencia.querySelector('i');
                const spanElemento = linkAcaoConferencia.querySelector('span');

                if (iconeElemento) {
                    iconeElemento.classList.remove('fa-check-circle', 'fa-times-circle');
                    iconeElemento.classList.add('fas', icone);
                }
                if(spanElemento) {
                    spanElemento.textContent = textoBotao;
                }
            }
        }

        /**
         * Função chamada pelos botões de lote na toolbar.
         * @param {string} novoStatus - O status a ser aplicado ("Conferida" ou "Não Conferida").
         */
        function marcarConferenciaLote(novoStatus) {
            const checkboxes = document.querySelectorAll('.checkbox-nota:checked');
            const chaves = Array.from(checkboxes).map(cb => cb.value);

            if (chaves.length === 0) {
                alert(`Selecione pelo menos um documento para marcar como "${novoStatus}".`);
                return;
            }

            // Desabilita botões de lote e mostra loading (exemplo para um botão)
            const btnMarcar = document.getElementById(novoStatus === 'Conferida' ? 'btnConferirLote' : 'btnDesconferirLote');
            const btnOposto = document.getElementById(novoStatus === 'Conferida' ? 'btnDesconferirLote' : 'btnConferirLote');

            if (btnMarcar) btnMarcar.disabled = true;
            if (btnOposto) btnOposto.disabled = true; // Desabilita o outro também
            if (btnMarcar) btnMarcar.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Aguarde...';


            // Chama a função principal de toggle
            toggleConferenciaStatus(chaves, novoStatus, btnMarcar); // Passa o botão para feedback
        }

        /** Restaura os botões de conferência em lote ao estado original */
        function restaurarBotoesConferenciaLote() {
            const btnConferir = document.getElementById('btnConferirLote');
            const btnDesconferir = document.getElementById('btnDesconferirLote');

            if (btnConferir) {
                btnConferir.disabled = false;
                btnConferir.innerHTML = '<i class="fas fa-check-circle me-1"></i> Marcar Conferido';
            }
            if (btnDesconferir) {
                btnDesconferir.disabled = false;
                btnDesconferir.innerHTML = '<i class="fas fa-times-circle me-1"></i> Marcar Não Conferido';
            }
        }

        //=============================================================================================================
        //============================================== Notificação Toast ============================================
        //=============================================================================================================

        /**
         * Exibe uma notificação toast do Bootstrap.
         * @param {string} message - A mensagem a ser exibida.
         * @param {string} type - 'success' (verde) ou 'danger' (vermelho). Padrão 'success'.
         * @param {number} delay - Tempo em milissegundos para o toast desaparecer (opcional, padrão Bootstrap).
         */
        function showToast(message, type = 'success', delay = 5000) {
            const toastElement = document.getElementById('feedbackToast');
            const toastBody = document.getElementById('toastBody');
            const toastTitle = document.getElementById('toastTitle');
            const toastHeader = toastElement?.querySelector('.toast-header');
            const toastIcon = toastHeader?.querySelector('i');
            const toastTimestamp = document.getElementById('toastTimestamp');

            if (!toastElement || !toastBody || !toastTitle || !toastHeader || !toastIcon) {
                console.error("Elementos do Toast não encontrados! Verifique os IDs: feedbackToast, toastBody, toastTitle.");
                alert(message); // Fallback
                return;
            }

            toastBody.textContent = message;
            toastElement.classList.remove('text-bg-success', 'text-bg-danger');
            toastIcon.classList.remove('fa-check-circle', 'fa-exclamation-triangle', 'fa-info-circle'); // Limpa ícones

            if (type === 'success') {
                toastElement.classList.add('text-bg-success');
                toastTitle.textContent = 'Sucesso';
                toastIcon.classList.add('fas', 'fa-check-circle');
            } else if (type === 'danger') {
                toastElement.classList.add('text-bg-danger');
                toastTitle.textContent = 'Erro';
                toastIcon.classList.add('fas', 'fa-exclamation-triangle');
            } else {
                toastTitle.textContent = 'Notificação';
                toastIcon.classList.add('fas', 'fa-info-circle');
            }

            if (toastTimestamp) {
                toastTimestamp.textContent = new Date().toLocaleTimeString();
            }

            const toast = bootstrap.Toast.getOrCreateInstance(toastElement, { delay: delay });
            toast.show();
        }

        //============================================================================================================
        //=========================================== CONSULTA POR CHAVE ============================================
        //============================================================================================================

        /**
         * Abre o modal de consulta por chave de acesso
         */
        function abrirModalConsultaChave() {
            const empresaSelect = document.getElementById('empresaSelecao');
            const empresaId = empresaSelect.value;
            const empresaNome = empresaSelect.options[empresaSelect.selectedIndex].text;
            
            if (!empresaId) {
                showToast('Por favor, selecione uma empresa antes de consultar por chave.', 'danger');
                return;
            }
            
            // Atualizar nome da empresa no modal
            document.getElementById('empresaSelecionadaNome').textContent = empresaNome;
            
            // Limpar campo de chaves
            document.getElementById('chavesAcesso').value = '';
            document.getElementById('contagemChaves').textContent = '0 chave(s) detectada(s)';
            
            // Abrir modal
            const modal = new bootstrap.Modal(document.getElementById('modalConsultaChave'));
            modal.show();
        }

        /**
         * Conta quantas chaves foram digitadas no textarea
         */
        document.addEventListener('DOMContentLoaded', function() {
            const chavesTextarea = document.getElementById('chavesAcesso');
            
            if (chavesTextarea) {
                chavesTextarea.addEventListener('input', function() {
                    const texto = this.value.trim();
                    if (!texto) {
                        document.getElementById('contagemChaves').textContent = '0 chave(s) detectada(s)';
                        return;
                    }
                    
                    // Contar chaves separadas por ;
                    const chaves = texto.split(';').filter(c => c.trim().length > 0);
                    const plural = chaves.length !== 1 ? 's' : '';
                    document.getElementById('contagemChaves').textContent = `${chaves.length} chave${plural} detectada${plural}`;
                });
            }
            
            // Handler do formulário de consulta
            const formConsultaChave = document.getElementById('formConsultaChave');
            if (formConsultaChave) {
                formConsultaChave.addEventListener('submit', function(e) {
                    e.preventDefault();
                    iniciarConsultaPorChave();
                });
            }
            
            // Habilitar/desabilitar botão de consulta por chave baseado na seleção de empresa
            const empresaSelect = document.getElementById('empresaSelecao');
            if (empresaSelect) {
                empresaSelect.addEventListener('change', function() {
                    const btnConsultarChave = document.getElementById('btnConsultarChave');
                    if (btnConsultarChave) {
                        if (this.value) {
                            btnConsultarChave.disabled = false;
                            btnConsultarChave.title = 'Consultar notas por chave de acesso';
                        } else {
                            btnConsultarChave.disabled = true;
                            btnConsultarChave.title = 'Selecione uma empresa primeiro';
                        }
                    }
                });
            }
        });

        /**
         * Inicia a consulta por chave de acesso via AJAX
         */
        function iniciarConsultaPorChave() {
            const empresaSelect = document.getElementById('empresaSelecao');
            const chavesTextarea = document.getElementById('chavesAcesso');
            const btnIniciar = document.getElementById('btnIniciarConsulta');
            
            const empresaId = empresaSelect.value;
            const chavesTexto = chavesTextarea.value.trim();
            
            if (!empresaId) {
                showToast('Selecione uma empresa.', 'danger');
                return;
            }
            
            if (!chavesTexto) {
                showToast('Digite pelo menos uma chave de acesso.', 'danger');
                return;
            }
            
            // Desabilitar botão e mostrar loading
            btnIniciar.disabled = true;
            btnIniciar.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Consultando...';
            
            // Preparar dados para envio
            const dados = {
                empresa_id: empresaId,
                chaves: chavesTexto
            };
            
            // Fazer requisição AJAX
            fetch('/api/consultar-por-chaves/', {  // Ajuste a URL conforme sua configuração
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')  // Para Django CSRF
                },
                body: JSON.stringify(dados)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast(data.message, 'success');
                    
                    // Fechar modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('modalConsultaChave'));
                    if (modal) {
                        modal.hide();
                    }
                    
                    // Opcional: Atualizar tabela de logs
                    if (typeof carregarLogs === 'function') {
                        setTimeout(() => {
                            carregarLogs();
                        }, 2000);
                    }
                    
                    // Opcional: Atualizar tabela principal após alguns segundos
                    setTimeout(() => {
                        if (typeof refreshTable === 'function') {
                            refreshTable();
                        }
                    }, 5000);
                    
                } else {
                    showToast(data.message || 'Erro ao iniciar consulta.', 'danger');
                }
            })
            .catch(error => {
                console.error('Erro na requisição:', error);
                showToast('Erro ao comunicar com o servidor. Tente novamente.', 'danger');
            })
            .finally(() => {
                // Restaurar botão
                btnIniciar.disabled = false;
                btnIniciar.innerHTML = '<i class="fas fa-search me-1"></i> Iniciar Consulta';
            });
        }

        /**
         * Função auxiliar para obter CSRF token do cookie
         * Necessária para requisições POST no Django
         */
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // ============================================================================================================
        // =========================================== BUSCA MANUAL ===================================================
        // ============================================================================================================

        // Variável global para armazenar o intervalo de atualização de status
        let intervalAtualizacaoStatus = null;

        /**
         * Verifica condições e inicia busca manual
         */
        function verificarEIniciarBuscaManual() {
            const empresaSelect = document.getElementById('empresaSelecao');
            const empresaId = empresaSelect.value;
            const empresaNome = empresaSelect.options[empresaSelect.selectedIndex].text;
            
            if (!empresaId) {
                showToast('Por favor, selecione uma empresa antes de realizar a busca manual.', 'danger');
                return;
            }
            
            // Abrir modal e verificar status
            const modal = new bootstrap.Modal(document.getElementById('modalBuscaManual'));
            modal.show();
            
            // Verificar se pode fazer busca
            verificarStatusBusca(empresaId, empresaNome);
        }

        /**
         * Verifica se a empresa pode fazer busca manual
         */
        function verificarStatusBusca(empresaId, empresaNome) {
            // Mostrar loading
            const modalBody = document.getElementById('modalBuscaManualBody');
            modalBody.innerHTML = `
                <div class="text-center py-3">
                    <div class="spinner-border text-success" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <p class="mt-3">Verificando condições para busca...</p>
                </div>
            `;
            
            // Fazer requisição para verificar status
            fetch(`/api/verificar-status-busca/${empresaId}/`)  // Ajuste a URL conforme sua configuração
                .then(response => response.json())
                .then(data => {
                    if (data.pode_consultar) {
                        // Pode consultar - mostrar confirmação
                        mostrarConfirmacaoBusca(empresaId, empresaNome, data);
                    } else {
                        // Não pode consultar - mostrar motivo
                        mostrarMotivoNaoPodeBuscar(data);
                    }
                })
                .catch(error => {
                    console.error('Erro ao verificar status:', error);
                    modalBody.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Erro ao verificar status da busca. Tente novamente.
                        </div>
                    `;
                });
        }

        /**
         * Mostra confirmação para iniciar a busca
         */
        function mostrarConfirmacaoBusca(empresaId, empresaNome, data) {
            const modalBody = document.getElementById('modalBuscaManualBody');
            const modalFooter = document.getElementById('modalBuscaManualFooter');
            
            modalBody.innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle me-2"></i>
                    <strong>Tudo pronto para buscar!</strong>
                </div>
                <div class="mb-3">
                    <p><strong>Empresa:</strong> ${empresaNome}</p>
                    ${data.ultima_consulta ? `<p><small class="text-muted">Última consulta: ${data.ultima_consulta}</small></p>` : ''}
                </div>
                <p class="text-muted">
                    <i class="fas fa-info-circle me-1"></i>
                    A busca irá consultar novas notas fiscais diretamente na SEFAZ.
                </p>
            `;
            
            modalFooter.innerHTML = `
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>
                    Cancelar
                </button>
                <button type="button" class="btn btn-success" onclick="executarBuscaManual(${empresaId}, '${empresaNome}')">
                    <i class="fas fa-sync-alt me-1"></i>
                    Confirmar Busca
                </button>
            `;
        }

        /**
         * Mostra motivo pelo qual não pode buscar
         */
        function mostrarMotivoNaoPodeBuscar(data) {
            const modalBody = document.getElementById('modalBuscaManualBody');
            const modalFooter = document.getElementById('modalBuscaManualFooter');
            
            let iconClass = 'fa-clock';
            let alertClass = 'alert-warning';
            let titulo = 'Aguarde para próxima consulta';
            
            // Se não é problema de tempo, é configuração
            if (data.tipo_busca !== "1") {
                iconClass = 'fa-exclamation-triangle';
                alertClass = 'alert-danger';
                titulo = 'Busca manual não disponível';
            }
            
            modalBody.innerHTML = `
                <div class="alert ${alertClass}">
                    <i class="fas ${iconClass} me-2"></i>
                    <strong>${titulo}</strong>
                </div>
                <div class="mb-3">
                    <p>${data.message}</p>
                    ${data.motivos && data.motivos.length > 0 ? `
                        <ul class="mb-0">
                            ${data.motivos.map(motivo => `<li>${motivo}</li>`).join('')}
                        </ul>
                    ` : ''}
                </div>
                ${data.tempo_restante > 0 ? `
                    <div class="card bg-light">
                        <div class="card-body text-center">
                            <h2 class="mb-0 text-warning">
                                <i class="fas fa-hourglass-half me-2"></i>
                                <span id="tempoRestanteDisplay">${data.tempo_restante}</span>
                                <small>min</small>
                            </h2>
                            <small class="text-muted">Tempo restante para próxima consulta</small>
                            ${data.ultima_consulta ? `<br><small class="text-muted">Última consulta: ${data.ultima_consulta}</small>` : ''}
                        </div>
                    </div>
                ` : ''}
                ${data.tipo_busca !== "1" ? `
                    <div class="alert alert-info mt-3">
                        <i class="fas fa-info-circle me-2"></i>
                        <small>
                            <strong>Como resolver:</strong><br>
                            Vá em Configurações → Empresas → Editar empresa → 
                            Configure o "Tipo de Busca" como "Manual"
                        </small>
                    </div>
                ` : ''}
            `;
            
            modalFooter.innerHTML = `
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>
                    Fechar
                </button>
            `;
            
            // Se tem tempo restante, iniciar contagem regressiva
            if (data.tempo_restante > 0) {
                iniciarContagemRegressiva(data.tempo_restante);
            }
        }

        /**
         * Inicia contagem regressiva no modal
         */
        function iniciarContagemRegressiva(minutosRestantes) {
            let segundosRestantes = minutosRestantes * 60;
            
            // Limpar intervalo anterior se existir
            if (intervalAtualizacaoStatus) {
                clearInterval(intervalAtualizacaoStatus);
            }
            
            intervalAtualizacaoStatus = setInterval(() => {
                segundosRestantes--;
                
                const minutos = Math.floor(segundosRestantes / 60);
                const segundos = segundosRestantes % 60;
                
                const display = document.getElementById('tempoRestanteDisplay');
                if (display) {
                    display.textContent = `${minutos}:${segundos.toString().padStart(2, '0')}`;
                }
                
                // Se terminou a contagem
                if (segundosRestantes <= 0) {
                    clearInterval(intervalAtualizacaoStatus);
                    if (display) {
                        display.textContent = '0';
                        display.closest('.card').classList.remove('bg-light');
                        display.closest('.card').classList.add('bg-success', 'text-white');
                        display.innerHTML = '<i class="fas fa-check-circle"></i> Pronto!';
                    }
                }
            }, 1000);
        }

        /**
         * Executa a busca manual via AJAX
         */
        function executarBuscaManual(empresaId, empresaNome) {
            const modalBody = document.getElementById('modalBuscaManualBody');
            const modalFooter = document.getElementById('modalBuscaManualFooter');
            
            // Mostrar loading
            modalBody.innerHTML = `
                <div class="text-center py-4">
                    <div class="spinner-border text-success mb-3" role="status">
                        <span class="visually-hidden">Consultando...</span>
                    </div>
                    <h5>Consultando SEFAZ...</h5>
                    <p class="text-muted">Aguarde enquanto buscamos novas notas fiscais.</p>
                </div>
            `;
            
            modalFooter.innerHTML = `
                <button type="button" class="btn btn-secondary" disabled>
                    <i class="fas fa-spinner fa-spin me-1"></i>
                    Consultando...
                </button>
            `;
            
            // Fazer requisição
            fetch('/api/busca-manual-nfe/', {  // Ajuste a URL conforme sua configuração
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    empresa_id: empresaId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Sucesso
                    modalBody.innerHTML = `
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>
                            <strong>Consulta iniciada com sucesso!</strong>
                        </div>
                        <p>${data.message}</p>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <small>
                                Os resultados aparecerão na tabela em alguns instantes. 
                                Você pode acompanhar o progresso nos logs de consulta.
                            </small>
                        </div>
                    `;
                    
                    modalFooter.innerHTML = `
                        <button type="button" class="btn btn-success" data-bs-dismiss="modal">
                            <i class="fas fa-check me-1"></i>
                            OK
                        </button>
                    `;
                    
                    // Fechar modal automaticamente após 3 segundos
                    setTimeout(() => {
                        const modal = bootstrap.Modal.getInstance(document.getElementById('modalBuscaManual'));
                        if (modal) {
                            modal.hide();
                        }
                    }, 3000);
                    
                    // Atualizar tabela de logs após 2 segundos
                    setTimeout(() => {
                        if (typeof carregarLogs === 'function') {
                            carregarLogs();
                        }
                    }, 2000);
                    
                    // Atualizar tabela principal após 5 segundos
                    setTimeout(() => {
                        if (typeof refreshTable === 'function') {
                            refreshTable();
                        }
                    }, 5000);
                    
                    showToast(data.message, 'success');
                    
                } else {
                    // Erro ou tempo de espera
                    const isTempoEspera = data.tempo_restante && data.tempo_restante > 0;
                    
                    modalBody.innerHTML = `
                        <div class="alert alert-${isTempoEspera ? 'warning' : 'danger'}">
                            <i class="fas fa-${isTempoEspera ? 'clock' : 'exclamation-triangle'} me-2"></i>
                            <strong>${isTempoEspera ? 'Aguarde!' : 'Erro'}</strong>
                        </div>
                        <p>${data.message}</p>
                        ${data.ultima_consulta ? `<p><small class="text-muted">Última consulta: ${data.ultima_consulta}</small></p>` : ''}
                        ${data.proxima_consulta ? `<p><small class="text-muted">Próxima consulta disponível: ${data.proxima_consulta}</small></p>` : ''}
                    `;
                    
                    modalFooter.innerHTML = `
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i>
                            Fechar
                        </button>
                    `;
                    
                    showToast(data.message, isTempoEspera ? 'warning' : 'danger');
                }
            })
            .catch(error => {
                console.error('Erro na requisição:', error);
                
                modalBody.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Erro ao executar busca</strong>
                    </div>
                    <p>Ocorreu um erro ao comunicar com o servidor. Tente novamente.</p>
                `;
                
                modalFooter.innerHTML = `
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>
                        Fechar
                    </button>
                `;
                
                showToast('Erro ao executar busca manual. Tente novamente.', 'danger');
            });
        }

        // ============================================================================================================
        // Event Listeners para o botão de busca manual
        // ============================================================================================================

        document.addEventListener('DOMContentLoaded', function() {
            const empresaSelect = document.getElementById('empresaSelecao');
            const btnBuscaManual = document.getElementById('btnBuscaManual');
            
            if (empresaSelect && btnBuscaManual) {
                // Quando selecionar empresa, verificar se pode habilitar busca manual
                empresaSelect.addEventListener('change', function() {
                    const empresaId = this.value;
                    
                    if (!empresaId) {
                        btnBuscaManual.disabled = true;
                        btnBuscaManual.title = 'Selecione uma empresa primeiro';
                        return;
                    }
                    
                    // Verificar se pode habilitar o botão
                    verificarSeHabilitaBotaoBusca(empresaId);
                });
            }
            
            // Limpar intervalo quando modal fechar
            const modalBuscaManual = document.getElementById('modalBuscaManual');
            if (modalBuscaManual) {
                modalBuscaManual.addEventListener('hidden.bs.modal', function () {
                    if (intervalAtualizacaoStatus) {
                        clearInterval(intervalAtualizacaoStatus);
                        intervalAtualizacaoStatus = null;
                    }
                });
            }
        });

        /**
         * Verifica se deve habilitar botão de busca manual baseado na empresa selecionada
         */
        function verificarSeHabilitaBotaoBusca(empresaId) {
            const btnBuscaManual = document.getElementById('btnBuscaManual');
            
            // Desabilitar enquanto verifica
            btnBuscaManual.disabled = true;
            btnBuscaManual.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Verificando...';
            
            fetch(`/api/verificar-status-busca/${empresaId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.tipo_busca === "1") {
                        // É busca manual
                        if (data.pode_consultar) {
                            btnBuscaManual.disabled = false;
                            btnBuscaManual.title = 'Realizar busca manual de notas fiscais';
                            btnBuscaManual.innerHTML = '<i class="fas fa-sync-alt me-1"></i> Busca Manual';
                        } else {
                            btnBuscaManual.disabled = true;
                            btnBuscaManual.title = data.message;
                            btnBuscaManual.innerHTML = `<i class="fas fa-clock me-1"></i> Aguarde ${data.tempo_restante} min`;
                        }
                    } else {
                        // Não é busca manual
                        btnBuscaManual.disabled = true;
                        btnBuscaManual.title = 'Esta empresa não está configurada para busca manual';
                        btnBuscaManual.innerHTML = '<i class="fas fa-ban me-1"></i> Busca Manual';
                    }
                })
                .catch(error => {
                    console.error('Erro ao verificar status:', error);
                    btnBuscaManual.disabled = true;
                    btnBuscaManual.title = 'Erro ao verificar status';
                    btnBuscaManual.innerHTML = '<i class="fas fa-sync-alt me-1"></i> Busca Manual';
                });
        }

        
    </script>

    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1100">
        <div id="feedbackToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <i class="fas fa-info-circle me-2"></i> <strong class="me-auto" id="toastTitle">Notificação</strong>
                <small id="toastTimestamp">Agora</small>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Fechar"></button>
            </div>
            <div class="toast-body" id="toastBody">
                Bem vindo.
            </div>
        </div>
    </div>




        </div>
    </main>

    <!-- Profile Modal -->
     <div class="modal fade" id="profileModal" tabindex="-1" aria-labelledby="profileModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="profileModalLabel">
                        <i class="bi bi-person-gear me-2"></i>
                        Editar Perfil
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form method="POST" action="/accounts/update-profile/" id="profileForm">
                        <input type="hidden" name="csrfmiddlewaretoken" value="5irda87WcbzR0TEIV1m63ofqSNhAPSZ0OYR0KhsWtLKWTkwO8NAUUODbsaoVgiFB">
                        <!-- User Initial Display -->
                        <div class="text-center mb-4">
                            <div class="user-initial mx-auto" style="width: 80px; height: 80px; font-size: 32px;">
                                P
                            </div>
                            <p class="text-muted mt-2">Inicial baseada no seu nome</p>
                        </div>

                        <!-- Form Fields -->
                        <div class="row g-2">
                            <div class="col-md-6">
                                <label for="first_name" class="form-label">Nome</label>
                                <input type="text" class="form-control" id="first_name" name="first_name" value="Planejamento" required="">
                            </div>
                            
                            <div class="col-md-6">
                                <label for="last_name" class="form-label">Sobrenome</label>
                                <input type="text" class="form-control" id="last_name" name="last_name" value="">
                            </div>
                        </div>
                        
                        <div class="mb-3" style="padding-top: 20px;">
                            <label for="email" class="form-label">E-mail (não editável)</label>
                            <input type="email" class="form-control" id="email" value="planejamentotributario@grupomgbr.com" disabled="">
                        </div>

                        <hr class="my-4">
                        <h6 class="mb-3">Alterar Senha</h6>
                        
                        <!--
                        <div class="mb-3">
                            <label for="current_password" class="form-label">Senha Atual</label>
                            <div class="password-field">
                                <input type="password" class="form-control" id="current_password" name="current_password">
                                <button type="button" class="password-toggle" onclick="togglePassword('current_password')">
                                    <i class="bi bi-eye" id="current_password_icon"></i>
                                </button>
                            </div>
                        </div>
                        -->
                        
                        <!-- Campo fake invisível para enganar o autofill -->
                        <input type="text" name="fakeusernameremembered" id="fakeusernameremembered" style="display:none">
                        <input type="password" name="fakepasswordremembered" id="fakepasswordremembered" style="display:none">

                        <div class="row g-2">
                            <div class="col-md-6">
                                <label for="new_password" class="form-label">Nova Senha</label>
                                <div class="password-field">
                                    <input type="password" class="form-control" id="new_password" name="new_password" autocomplete="new-password" placeholder="Digite a nova senha">
                                    <button type="button" class="password-toggle" onclick="togglePassword('new_password')">
                                        <i class="bi bi-eye" id="new_password_icon"></i>
                                    </button>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <label for="confirm_password" class="form-label">Confirmar Nova Senha</label>
                                <div class="password-field">
                                    <input type="password" class="form-control" id="confirm_password" name="confirm_password" autocomplete="new-password" placeholder="Confirme a nova senha">
                                    <button type="button" class="password-toggle" onclick="togglePassword('confirm_password')">
                                        <i class="bi bi-eye" id="confirm_password_icon"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <small class="text-muted">Deixe os campos de senha em branco se não quiser alterá-la.</small>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" form="profileForm" class="btn btn-primary">
                        <i class="bi bi-check-lg me-1"></i>
                        Salvar Alterações
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // --- 1. Lógica para carregar Toasts na inicialização ---
        //const toastElList = [].slice.call(document.querySelectorAll('.toast'));
        //const toastList = toastElList.map(function(toastEl) {
            // Cria uma instância do Toast e a exibe
        //    const toast = new bootstrap.Toast(toastEl);
        //    toast.show();
        //    return toast;
        //});

        // Sidebar functionality
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('mainContent');
        const toggleBtn = document.getElementById('toggleSidebar');
        const toggleIcon = document.getElementById('toggleIcon');
        const mobileOverlay = document.getElementById('mobileOverlay');
        
        let isCollapsed = false;
        let isMobile = window.innerWidth <= 768;

        // Toggle sidebar
        function toggleSidebar() {
            if (isMobile) {
                sidebar.classList.toggle('show');
                mobileOverlay.classList.toggle('show');
            } else {
                isCollapsed = !isCollapsed;
                sidebar.classList.toggle('collapsed');
                mainContent.classList.toggle('expanded');
                toggleIcon.className = isCollapsed ? 'bi bi-chevron-right' : 'bi bi-chevron-left';
                
                // Close all dropdowns when collapsing
                if (isCollapsed) {
                    document.querySelectorAll('.submenu.show').forEach(submenu => {
                        submenu.classList.remove('show');
                    });
                    document.querySelectorAll('.menu-arrow.rotated').forEach(arrow => {
                        arrow.classList.remove('rotated');
                    });
                }
            }
        }

        toggleBtn.addEventListener('click', toggleSidebar);
        mobileOverlay.addEventListener('click', toggleSidebar);

        // Dropdown functionality
        document.querySelectorAll('[data-toggle]').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                
                if (isCollapsed && !isMobile) return;
                
                const target = this.getAttribute('data-toggle');
                const submenu = document.getElementById(target + '-submenu');
                const arrow = this.querySelector('.menu-arrow');
                
                // Close other dropdowns
                document.querySelectorAll('.submenu.show').forEach(otherSubmenu => {
                    if (otherSubmenu !== submenu) {
                        otherSubmenu.classList.remove('show');
                    }
                });
                
                document.querySelectorAll('.menu-arrow.rotated').forEach(otherArrow => {
                    if (otherArrow !== arrow) {
                        otherArrow.classList.remove('rotated');
                    }
                });
                
                // Toggle current dropdown
                submenu.classList.toggle('show');
                arrow.classList.toggle('rotated');
                
                // Set active state
                document.querySelectorAll('.menu-link.active').forEach(activeLink => {
                    activeLink.classList.remove('active');
                });
                this.classList.add('active');
            });
        });

        // User menu functionality
        const userProfile = document.getElementById('userProfile');
        const userMenu = document.getElementById('userMenu');
        
        userProfile.addEventListener('click', function(e) {
            e.stopPropagation();
            userMenu.classList.toggle('show');
        });

        // Close user menu when clicking outside
        document.addEventListener('click', function() {
            userMenu.classList.remove('show');
        });

        // Password toggle functionality
        function togglePassword(fieldId) {
            const field = document.getElementById(fieldId);
            const icon = document.getElementById(fieldId + '_icon');
            
            if (field.type === 'password') {
                field.type = 'text';
                icon.className = 'bi bi-eye-slash';
            } else {
                field.type = 'password';
                icon.className = 'bi bi-eye';
            }
        }

        // Form validation
        document.getElementById('profileForm').addEventListener('submit', function(e) {
            const newPassword = document.getElementById('new_password').value;
            const confirmPassword = document.getElementById('confirm_password').value;
            const currentPassword = document.getElementById('current_password').value;
            
            // Only validate password if user is trying to change it
            if (newPassword || confirmPassword) {
                if (!currentPassword) {
                    e.preventDefault();
                    alert('Digite sua senha atual para alterar a senha.');
                    return;
                }
                
                if (newPassword !== confirmPassword) {
                    e.preventDefault();
                    alert('A nova senha e a confirmação não coincidem.');
                    return;
                }
                
                if (newPassword.length < 8) {
                    e.preventDefault();
                    alert('A nova senha deve ter pelo menos 8 caracteres.');
                    return;
                }
            }
            
            // If only current password is filled but no new password
            if (newPassword && !confirmPassword) {
                e.preventDefault();
                alert('Digite a nova senha para alterar sua senha.');
                return;
            }
        });

        // Handle window resize
        window.addEventListener('resize', function() {
            const wasMobile = isMobile;
            isMobile = window.innerWidth <= 768;
            
            if (wasMobile && !isMobile) {
                // Switching from mobile to desktop
                sidebar.classList.remove('show');
                mobileOverlay.classList.remove('show');
            } else if (!wasMobile && isMobile) {
                // Switching from desktop to mobile
                sidebar.classList.remove('collapsed');
                mainContent.classList.remove('expanded');
                isCollapsed = false;
                toggleIcon.className = 'bi bi-chevron-left';
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Set first menu item as active by default
            const firstMenuItem = document.querySelector('[data-toggle="dashboards"]');
            if (firstMenuItem) {
                firstMenuItem.classList.add('active');
            }
        });

        // CHAT
        //window.$crisp=[];
        //window.CRISP_WEBSITE_ID="2b84f14e-1162-4798-a613-1c317291e208";
        //(function(){
        //    d=document;
        //    s=d.createElement("script");
        //    s.src="https://client.crisp.chat/l.js";
        //    s.async=1;
        //    d.getElementsByTagName("head")[0].appendChild(s);
        //   window.$crisp.push(["set", "user:email", "planejamentotributario@grupomgbr.com"]);
        //    window.$crisp.push(["set", "user:nickname", "Planejamento"]);
        //    window.$crisp.push(["set", "user:segments", ["Cliente App Django"]]);
        //})();


    </script>

</body></html>