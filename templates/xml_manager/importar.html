{% extends "base.html" %}
{% load static %}

{% block title %}Importar XMLs{% endblock %}

{% block extra_css %}
<style>
    .upload-area {
        border: 2px dashed var(--primary-color);
        border-radius: 12px;
        padding: 40px;
        text-align: center;
        transition: all 0.3s;
        cursor: pointer;
        background: #fafafa;
    }
    
    .upload-area:hover,
    .upload-area.dragover {
        background: rgba(140, 64, 240, 0.05);
        border-color: var(--secondary-color);
    }
    
    .upload-icon {
        font-size: 3rem;
        color: var(--primary-color);
        margin-bottom: 15px;
    }
    
    .file-list {
        max-height: 300px;
        overflow-y: auto;
    }
    
    .file-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 15px;
        background: #f8f9fa;
        border-radius: 8px;
        margin-bottom: 8px;
    }
    
    .file-item .file-name {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .file-item .file-size {
        color: #6c757d;
        font-size: 0.85rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header text-center">
                    <h5 class="mb-0">
                        <i class="bi bi-file-earmark-code me-2"></i>
                        Importar Arquivos XML
                    </h5>
                </div>
                
                <div class="card-body p-4">
                    <form id="formImportarXML" method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        
                        <div class="mb-4">
                            <label class="form-label fw-semibold">Empresa *</label>
                            <select name="empresa" id="empresaSelect" class="form-select" required>
                                <option value="">Selecione uma empresa</option>
                                {% for empresa in empresas %}
                                <option value="{{ empresa.id }}">{{ empresa.razao_social }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="mb-4">
                            <label class="form-label fw-semibold">Arquivos XML</label>
                            <div class="upload-area" id="dropArea" onclick="document.getElementById('fileInput').click()">
                                <i class="bi bi-cloud-upload upload-icon"></i>
                                <h5>Arraste os arquivos XML aqui</h5>
                                <p class="text-muted mb-2">ou clique para selecionar</p>
                                <small class="text-muted">Formatos aceitos: .xml (NF-e, CT-e, NFS-e)</small>
                            </div>
                            <input type="file" id="fileInput" name="arquivos" multiple accept=".xml" style="display: none;">
                        </div>
                        
                        <div id="fileListContainer" class="mb-4" style="display: none;">
                            <label class="form-label fw-semibold">Arquivos Selecionados</label>
                            <div class="file-list" id="fileList"></div>
                        </div>
                        
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary flex-grow-1" id="btnImportar" disabled>
                                <i class="bi bi-upload me-2"></i>
                                Importar Arquivos
                            </button>
                            <button type="button" class="btn btn-secondary" id="btnLimpar" style="display: none;">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Resultados -->
            <div class="card shadow mt-4" id="resultadosCard" style="display: none;">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-check-circle me-2"></i>
                        Resultado da Importação
                    </h5>
                </div>
                <div class="card-body" id="resultadosBody">
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const dropArea = document.getElementById('dropArea');
    const fileInput = document.getElementById('fileInput');
    const fileList = document.getElementById('fileList');
    const fileListContainer = document.getElementById('fileListContainer');
    const btnImportar = document.getElementById('btnImportar');
    const btnLimpar = document.getElementById('btnLimpar');
    
    let selectedFiles = [];
    
    // Drag and drop
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, preventDefaults, false);
    });
    
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    ['dragenter', 'dragover'].forEach(eventName => {
        dropArea.addEventListener(eventName, () => dropArea.classList.add('dragover'), false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, () => dropArea.classList.remove('dragover'), false);
    });
    
    dropArea.addEventListener('drop', handleDrop, false);
    fileInput.addEventListener('change', handleFiles, false);
    
    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        handleFiles({ target: { files } });
    }
    
    function handleFiles(e) {
        const files = [...e.target.files].filter(f => f.name.endsWith('.xml'));
        selectedFiles = [...selectedFiles, ...files];
        updateFileList();
    }
    
    function updateFileList() {
        if (selectedFiles.length === 0) {
            fileListContainer.style.display = 'none';
            btnImportar.disabled = true;
            btnLimpar.style.display = 'none';
            return;
        }
        
        fileListContainer.style.display = 'block';
        btnImportar.disabled = false;
        btnLimpar.style.display = 'block';
        
        fileList.innerHTML = selectedFiles.map((file, index) => `
            <div class="file-item">
                <div class="file-name">
                    <i class="bi bi-file-earmark-code text-primary"></i>
                    <span>${file.name}</span>
                </div>
                <div class="d-flex align-items-center gap-2">
                    <span class="file-size">${formatFileSize(file.size)}</span>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeFile(${index})">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
            </div>
        `).join('');
    }
    
    function removeFile(index) {
        selectedFiles.splice(index, 1);
        updateFileList();
    }
    
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    btnLimpar.addEventListener('click', () => {
        selectedFiles = [];
        fileInput.value = '';
        updateFileList();
    });
</script>
{% endblock %}
