{% extends "base.html" %}
{% load static %}

{% block title %}Importar SPED{% endblock %}

{% block extra_css %}
<style>
    .import-container {
        max-width: 600px;
        margin: 0 auto;
    }
    
    .header-section {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        color: white;
        padding: 20px;
        border-radius: 12px 12px 0 0;
    }
    
    .content-section {
        background: white;
        padding: 30px;
        border-radius: 0 0 12px 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    
    .btn-primary-custom {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        border: none;
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 600;
    }
    
    .btn-primary-custom:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(140, 64, 240, 0.4);
        color: white;
    }
    
    .btn-success-custom {
        background: #28a745;
        border: none;
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 600;
    }
    
    .progress-modal .modal-content {
        border-radius: 12px;
        overflow: hidden;
    }
    
    .progress-modal .nav-tabs {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        border: none;
    }
    
    .progress-modal .nav-link {
        color: rgba(255,255,255,0.7);
        border: none;
        padding: 15px 25px;
    }
    
    .progress-modal .nav-link.active {
        background: rgba(255,255,255,0.2);
        color: white;
    }
    
    .stats-card {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 10px;
        text-align: center;
    }
    
    .stat-number {
        font-size: 2rem;
        font-weight: bold;
        color: var(--primary-color);
    }
    
    .stat-label {
        font-size: 0.85rem;
        color: #6c757d;
    }
    
    .history-item {
        background: white;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 8px;
        border-left: 4px solid #0d6efd;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .history-item.completed { border-left-color: #28a745; }
    .history-item.error { border-left-color: #dc3545; }
    .history-item.processing { border-left-color: #ffc107; }
    
    .success-icon {
        color: #28a745;
        font-size: 3rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="import-container">
        <div class="header-section text-center">
            <h5 class="mb-0">
                <i class="bi bi-upload me-2"></i>
                Importar Arquivo SPED
            </h5>
        </div>
        
        <div class="content-section">
            <form id="importarSpedForm" method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                
                <div class="mb-4">
                    <label class="form-label fw-semibold">Selecione o tipo de SPED:</label>
                    <div class="d-flex gap-4">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="tipo" value="fiscal" id="tipoFiscal" required>
                            <label class="form-check-label" for="tipoFiscal">SPED Fiscal</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="tipo" value="registro" id="tipoContribuicoes" required>
                            <label class="form-check-label" for="tipoContribuicoes">SPED Contribui√ß√µes</label>
                        </div>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label for="arquivoSped" class="form-label fw-semibold">Selecione o arquivo SPED:</label>
                    <input class="form-control" type="file" id="arquivoSped" name="arquivo_sped" accept=".txt,.zip" required>
                    <small class="text-muted">Formatos aceitos: .txt ou .zip</small>
                </div>
                
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="sobrescrever" name="sobrescrever">
                    <label class="form-check-label" for="sobrescrever">
                        Sobrescrever dados existentes?
                    </label>
                </div>

                <div class="form-check mb-4">
                    <input class="form-check-input" type="checkbox" id="buscarProdutosApi" name="buscar_produtos_api">
                    <label class="form-check-label" for="buscarProdutosApi">
                        <i class="bi bi-cloud-download me-1 text-primary"></i>
                        Buscar produtos via API ap√≥s importa√ß√£o (entrada e sa√≠da sem itens)
                    </label>
                </div>
                
                <div class="d-flex gap-2">
                    <button id="btnImportar" type="submit" class="btn btn-primary-custom flex-grow-1">
                        <i class="bi bi-upload me-1"></i> Enviar
                    </button>
                    <button type="button" class="btn btn-success-custom" data-bs-toggle="modal" data-bs-target="#modalConsultas">
                        <i class="bi bi-clock-history me-1"></i> Processamentos
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal de Processamentos -->
<div class="modal fade progress-modal" id="modalConsultas" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <ul class="nav nav-tabs" role="tablist">
                <li class="nav-item">
                    <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#consulta-ativa">
                        <i class="bi bi-clock-history me-1"></i> Consulta Ativa
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#consulta-cnpj">
                        <i class="bi bi-search me-1"></i> Consultar CNPJs
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#historico">
                        <i class="bi bi-list-ul me-1"></i> Hist√≥rico
                    </button>
                </li>
            </ul>

            <div class="tab-content">
                <!-- Aba Consulta Ativa -->
                <div class="tab-pane fade show active" id="consulta-ativa">
                    <div class="modal-body">
                        <div id="estado-vazio" class="text-center py-5">
                            <i class="bi bi-inbox text-muted" style="font-size: 4rem;"></i>
                            <p class="text-muted mt-3">Nenhuma consulta em andamento</p>
                        </div>

                        <div id="estado-processando" style="display: none;">
                            <div class="text-center mb-4">
                                <div class="spinner-border text-primary" role="status"></div>
                            </div>
                            <h5 class="text-center mb-3">Processando SPED...</h5>
                            <div class="progress mb-4" style="height: 25px;">
                                <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%">0%</div>
                            </div>
                            <div class="row g-3">
                                <div class="col-4">
                                    <div class="stats-card">
                                        <div class="stat-number" id="stat-current">0</div>
                                        <div class="stat-label">Processados</div>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="stats-card">
                                        <div class="stat-number" id="stat-updated">0</div>
                                        <div class="stat-label">Atualizados</div>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="stats-card">
                                        <div class="stat-number" id="stat-errors">0</div>
                                        <div class="stat-label">Erros</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="estado-concluido" style="display: none;">
                            <div class="text-center py-4">
                                <i class="bi bi-check-circle-fill success-icon"></i>
                                <h4 class="mt-3">Processamento Conclu√≠do!</h4>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    </div>
                </div>

                <!-- Aba Consultar CNPJs -->
                <div class="tab-pane fade" id="consulta-cnpj">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Selecione o SPED para consultar fornecedores:</label>
                            <select class="form-select" id="selectRegistroConsulta">
                                <option value="">Selecione um SPED importado...</option>
                                {% for registro in registros %}
                                <option value="{{ registro.id }}">
                                    {{ registro.empresa.razao_social|truncatechars:30 }} - {{ registro.tipo }} - {{ registro.periodo|date:"m/Y" }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div id="info-participantes" style="display: none;">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                <span id="info-pendentes">0</span> fornecedores pendentes de consulta
                            </div>
                            
                            <button type="button" class="btn btn-primary w-100 mb-3" id="btnIniciarConsulta">
                                <i class="bi bi-search me-1"></i> Iniciar Consulta de CNPJs
                            </button>
                        </div>
                        
                        <div id="consulta-em-andamento" style="display: none;">
                            <h5 class="text-center mb-3">
                                <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                                Consultando CNPJs...
                            </h5>
                            <div class="progress mb-3" style="height: 25px;">
                                <div id="progress-cnpj" class="progress-bar progress-bar-striped progress-bar-animated bg-success" style="width: 0%">0%</div>
                            </div>
                            <div id="log-consulta" class="border rounded p-3 bg-light" style="max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px;">
                                <!-- Log em tempo real -->
                            </div>
                        </div>
                        
                        <div id="consulta-concluida" style="display: none;">
                            <div class="text-center py-4">
                                <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
                                <h4 class="mt-3">Consulta Conclu√≠da!</h4>
                                <div class="row g-3 mt-3">
                                    <div class="col-3">
                                        <div class="stats-card">
                                            <div class="stat-number text-success" id="stat-simples">0</div>
                                            <div class="stat-label">Simples Nacional</div>
                                        </div>
                                    </div>
                                    <div class="col-3">
                                        <div class="stats-card">
                                            <div class="stat-number text-primary" id="stat-normal">0</div>
                                            <div class="stat-label">Regime Normal</div>
                                        </div>
                                    </div>
                                    <div class="col-3">
                                        <div class="stats-card">
                                            <div class="stat-number text-warning" id="stat-mei">0</div>
                                            <div class="stat-label">MEI</div>
                                        </div>
                                    </div>
                                    <div class="col-3">
                                        <div class="stats-card">
                                            <div class="stat-number text-danger" id="stat-erros">0</div>
                                            <div class="stat-label">Erros</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    </div>
                </div>

                <!-- Aba Hist√≥rico -->
                <div class="tab-pane fade" id="historico">
                    <div class="modal-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">Hist√≥rico de Importa√ß√µes</h5>
                            <button class="btn btn-sm btn-outline-primary" onclick="location.reload()">
                                <i class="bi bi-arrow-clockwise"></i> Atualizar
                            </button>
                        </div>
                        <div id="lista-historico">
                            {% for registro in registros %}
                            <div class="history-item {% if registro.processado %}completed{% endif %}">
                                <div>
                                    <div class="fw-bold">{{ registro.empresa.razao_social|truncatechars:30 }}</div>
                                    <small class="text-muted">{{ registro.tipo }} - {{ registro.periodo|date:"m/Y" }}</small>
                                </div>
                                <span class="badge {% if registro.processado %}bg-success{% else %}bg-warning{% endif %}">
                                    {% if registro.processado %}Conclu√≠do{% else %}Pendente{% endif %}
                                </span>
                            </div>
                            {% empty %}
                            <div class="text-center py-4 text-muted">
                                <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                                <p class="mt-2">Nenhuma importa√ß√£o realizada</p>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Progresso Autom√°tico da Consulta de Fornecedores -->
<div class="modal-progresso-consulta" id="modalProgressoConsulta">
    <div class="modal-progresso-consulta-content">
        <button type="button" class="btn-fechar-modal-consulta" onclick="fecharModalConsulta()" title="Fechar">‚úï</button>
        <div class="progresso-consulta-header">
            <h3><i class="bi bi-search me-2"></i>Consultando Regime Tribut√°rio</h3>
            <p id="progressoConsultaSubtitulo">Identificando fornecedores via API...</p>
        </div>
        
        <div class="progresso-consulta-stats">
            <div class="stat-box-consulta">
                <div class="stat-number-consulta" id="csTotal">0</div>
                <div class="stat-label-consulta">Total</div>
            </div>
            <div class="stat-box-consulta" style="background:#d1fae5;">
                <div class="stat-number-consulta" id="csSimples">0</div>
                <div class="stat-label-consulta">Simples</div>
            </div>
            <div class="stat-box-consulta" style="background:#dbeafe;">
                <div class="stat-number-consulta" id="csNormal">0</div>
                <div class="stat-label-consulta">Regime Normal</div>
            </div>
            <div class="stat-box-consulta" style="background:#fef3c7;">
                <div class="stat-number-consulta" id="csMei">0</div>
                <div class="stat-label-consulta">MEI</div>
            </div>
            <div class="stat-box-consulta" style="background:#fee2e2;">
                <div class="stat-number-consulta" id="csErros">0</div>
                <div class="stat-label-consulta">Erros</div>
            </div>
        </div>
        
        <div class="progresso-consulta-barra-container">
            <div class="progresso-consulta-info">
                <span id="csStatus">Preparando...</span>
                <span id="csContador">0/0</span>
            </div>
            <div class="progresso-consulta-barra">
                <div class="progresso-consulta-barra-fill" id="csBarraFill"></div>
            </div>
        </div>
        
        <div class="progresso-consulta-log" id="csLog">
            <!-- Log em tempo real -->
        </div>
        
        <div class="progresso-consulta-acoes">
            <button type="button" class="btn-cancelar-consulta" id="csBtnCancelar" onclick="cancelarConsultaAuto()">
                Cancelar
            </button>
            <button type="button" class="btn-fechar-consulta" id="csBtnFechar" style="display:none;" onclick="fecharModalConsulta()">
                Fechar
            </button>
        </div>
    </div>
</div>

<style>
    .modal-progresso-consulta {
        display: none;
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 10000;
        justify-content: center;
        align-items: center;
    }
    .modal-progresso-consulta.active { display: flex; }
    .modal-progresso-consulta-content {
        background: white;
        border-radius: 16px;
        padding: 30px;
        width: 90%;
        max-width: 650px;
        max-height: 85vh;
        overflow-y: auto;
        box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        position: relative;
    }
    .btn-fechar-modal-consulta {
        position: absolute; top: 12px; right: 15px;
        background: #6b7280; color: white; border: none;
        width: 30px; height: 30px; border-radius: 50%;
        cursor: pointer; font-size: 16px;
        display: flex; align-items: center; justify-content: center;
    }
    .btn-fechar-modal-consulta:hover { background: #4b5563; }
    .progresso-consulta-header { text-align: center; margin-bottom: 20px; }
    .progresso-consulta-header h3 { color: #1f2937; margin: 0; font-size: 1.4rem; }
    .progresso-consulta-header p { color: #6b7280; margin: 8px 0 0; }
    .progresso-consulta-stats {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 10px;
        margin-bottom: 20px;
    }
    .stat-box-consulta {
        background: #f3f4f6; padding: 12px;
        border-radius: 10px; text-align: center;
    }
    .stat-number-consulta { font-size: 1.5rem; font-weight: bold; color: #1f2937; }
    .stat-label-consulta { font-size: 0.75rem; color: #6b7280; margin-top: 3px; }
    .progresso-consulta-barra-container { margin-bottom: 15px; }
    .progresso-consulta-info {
        display: flex; justify-content: space-between;
        margin-bottom: 6px; font-size: 0.85rem; color: #4b5563;
    }
    .progresso-consulta-barra {
        height: 12px; background: #e5e7eb;
        border-radius: 6px; overflow: hidden;
    }
    .progresso-consulta-barra-fill {
        height: 100%;
        background: linear-gradient(90deg, #059669, #10b981);
        border-radius: 6px; transition: width 0.3s ease; width: 0%;
    }
    .progresso-consulta-log {
        background: #f9fafb; border: 1px solid #e5e7eb;
        border-radius: 8px; padding: 12px;
        max-height: 200px; overflow-y: auto;
        font-family: monospace; font-size: 11px;
        margin-bottom: 15px;
    }
    .progresso-consulta-acoes {
        display: flex; justify-content: center; gap: 15px;
    }
    .btn-cancelar-consulta {
        background: #ef4444; color: white; border: none;
        padding: 10px 25px; border-radius: 8px; cursor: pointer; font-weight: 500;
    }
    .btn-fechar-consulta {
        background: #3b82f6; color: white; border: none;
        padding: 10px 25px; border-radius: 8px; cursor: pointer; font-weight: 500;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // ========================================
    // IMPORTA√á√ÉO VIA AJAX COM PROGRESSO
    // ========================================
    const formImportar = document.getElementById('importarSpedForm');
    if (formImportar) {
        formImportar.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const btnImportar = document.getElementById('btnImportar');
            const textoOriginal = btnImportar.innerHTML;
            btnImportar.disabled = true;
            btnImportar.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Importando...';
            
            // Abrir modal na aba "Consulta Ativa" e mostrar estado processando
            const modalConsultas = new bootstrap.Modal(document.getElementById('modalConsultas'));
            modalConsultas.show();
            document.getElementById('estado-vazio').style.display = 'none';
            document.getElementById('estado-processando').style.display = 'block';
            document.getElementById('estado-concluido').style.display = 'none';
            
            try {
                const formData = new FormData(formImportar);
                const response = await fetch(formImportar.action || window.location.href, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Mostrar estado conclu√≠do na aba ativa
                    document.getElementById('estado-processando').style.display = 'none';
                    document.getElementById('estado-concluido').style.display = 'block';

                    // Guardar flag e IDs para busca de produtos ap√≥s consulta de fornecedores
                    window._buscarProdutosApi = data.buscar_produtos_api || false;
                    window._registrosImportados = data.registros_0000_ids || [];

                    // Iniciar consulta autom√°tica de fornecedores com progresso visual
                    if (data.registros_0000_ids && data.registros_0000_ids.length > 0) {
                        // Fechar modal bootstrap e abrir modal de progresso customizado
                        setTimeout(() => {
                            modalConsultas.hide();
                            window.iniciarConsultaAutomatica(data.registros_0000_ids);
                        }, 1500);
                    } else if (window._buscarProdutosApi && window._registrosImportados.length > 0) {
                        // Sem fornecedores para consultar, mas tem busca API ativa
                        setTimeout(() => {
                            modalConsultas.hide();
                            window.iniciarBuscaProdutosImportacao(window._registrosImportados);
                        }, 1500);
                    } else {
                        setTimeout(() => location.reload(), 3000);
                    }
                } else {
                    document.getElementById('estado-processando').style.display = 'none';
                    document.getElementById('estado-vazio').style.display = 'block';
                    alert('Erro: ' + (data.message || 'Falha na importa√ß√£o'));
                }
            } catch (err) {
                document.getElementById('estado-processando').style.display = 'none';
                document.getElementById('estado-vazio').style.display = 'block';
                alert('Erro de conex√£o: ' + err.message);
            } finally {
                btnImportar.disabled = false;
                btnImportar.innerHTML = textoOriginal;
            }
        });
    }
    
    const selectRegistro = document.getElementById('selectRegistroConsulta');
    const infoParticipantes = document.getElementById('info-participantes');
    const infoPendentes = document.getElementById('info-pendentes');
    const btnIniciarConsulta = document.getElementById('btnIniciarConsulta');
    const consultaEmAndamento = document.getElementById('consulta-em-andamento');
    const consultaConcluida = document.getElementById('consulta-concluida');
    const logConsulta = document.getElementById('log-consulta');
    const progressCnpj = document.getElementById('progress-cnpj');
    
    let participantesPendentes = [];
    let consultaAtiva = false;
    
    // Ao selecionar um registro
    selectRegistro.addEventListener('change', function() {
        const registroId = this.value;
        if (!registroId) {
            infoParticipantes.style.display = 'none';
            return;
        }
        
        // Buscar participantes pendentes
        fetch(`/importar-sped/listar-participantes-pendentes/${registroId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    participantesPendentes = data.participantes;
                    infoPendentes.textContent = data.total;
                    infoParticipantes.style.display = 'block';
                    consultaEmAndamento.style.display = 'none';
                    consultaConcluida.style.display = 'none';
                }
            });
    });
    
    // Iniciar consulta
    btnIniciarConsulta.addEventListener('click', async function() {
        if (participantesPendentes.length === 0) {
            alert('Nenhum fornecedor pendente de consulta.');
            return;
        }
        
        consultaAtiva = true;
        infoParticipantes.style.display = 'none';
        consultaEmAndamento.style.display = 'block';
        logConsulta.innerHTML = '';
        
        const registroId = selectRegistro.value;
        const total = participantesPendentes.length;
        let processados = 0;
        let simples = 0;
        let normal = 0;
        let mei = 0;
        let erros = 0;
        
        for (const part of participantesPendentes) {
            if (!consultaAtiva) break;
            
            const cnpjFormatado = part.cnpj.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})$/, '$1.$2.$3/$4-$5');
            addLog(`[${processados + 1}/${total}] Consultando ${cnpjFormatado}...`, 'info');
            
            try {
                const response = await fetch(`/importar-sped/consultar-participante-individual/${registroId}/${part.id}/`);
                const data = await response.json();
                
                if (data.success) {
                    const regime = data.participante.regime;
                    if (regime === 'MEI') mei++;
                    else if (regime === 'Simples Nacional') simples++;
                    else normal++;
                    
                    addLog(`‚úì ${part.nome.substring(0, 30)} - ${regime}`, 'success');
                } else {
                    erros++;
                    addLog(`‚úó ${part.nome.substring(0, 30)} - ${data.erro || 'Erro'}`, 'error');
                    
                    // Se rate limit, aguarda 10s antes de continuar
                    if (data.erro && data.erro.toLowerCase().includes('rate limit')) {
                        addLog(`‚è≥ Rate limit detectado - aguardando 10s...`, 'info');
                        await new Promise(resolve => setTimeout(resolve, 10000));
                    }
                }
            } catch (e) {
                erros++;
                addLog(`‚úó Erro ao consultar ${cnpjFormatado}`, 'error');
            }
            
            processados++;
            const percentual = Math.round((processados / total) * 100);
            progressCnpj.style.width = `${percentual}%`;
            progressCnpj.textContent = `${percentual}%`;
            
            // Delay de 2.5s para respeitar rate limit das APIs
            if (processados < total) {
                await new Promise(resolve => setTimeout(resolve, 2500));
            }
        }
        
// Consulta conclu√≠da
        consultaEmAndamento.style.display = 'none';
        consultaConcluida.style.display = 'block';
        document.getElementById('stat-simples').textContent = simples;
        document.getElementById('stat-normal').textContent = normal;
        document.getElementById('stat-mei').textContent = mei;
        if (document.getElementById('stat-erros')) {
            document.getElementById('stat-erros').textContent = erros;
        }
    });
    
    function addLog(message, type) {
        const color = type === 'success' ? 'green' : type === 'error' ? 'red' : '#333';
        logConsulta.innerHTML += `<div style="color: ${color};">${message}</div>`;
        logConsulta.scrollTop = logConsulta.scrollHeight;
    }
    
    // ========================================
    // CONSULTA AUTOM√ÅTICA AP√ìS IMPORTA√á√ÉO
    // ========================================
    let consultaAutoAtiva = false;
    
    function addLogConsulta(msg, type) {
        const csLog = document.getElementById('csLog');
        const color = type === 'success' ? '#059669' : type === 'error' ? '#dc2626' : type === 'warn' ? '#d97706' : '#374151';
        csLog.innerHTML += `<div style="color: ${color};">${msg}</div>`;
        csLog.scrollTop = csLog.scrollHeight;
    }
    
    function fecharModalConsulta() {
        consultaAutoAtiva = false;
        document.getElementById('modalProgressoConsulta').classList.remove('active');
        // Se a flag de buscar produtos API est√° ativa, iniciar busca antes de recarregar
        if (window._buscarProdutosApi && window._registrosImportados && window._registrosImportados.length > 0) {
            window._buscarProdutosApi = false; // Evitar re-execu√ß√£o
            window.iniciarBuscaProdutosImportacao(window._registrosImportados);
        } else {
            location.reload();
        }
    }
    
    function cancelarConsultaAuto() {
        consultaAutoAtiva = false;
        addLogConsulta('‚õî Consulta cancelada pelo usu√°rio.', 'warn');
        document.getElementById('csStatus').textContent = 'Cancelada';
        document.getElementById('csBtnCancelar').style.display = 'none';
        document.getElementById('csBtnFechar').style.display = 'inline-block';
    }
    
    async function iniciarConsultaAutomatica(registrosIds) {
        consultaAutoAtiva = true;
        const modal = document.getElementById('modalProgressoConsulta');
        modal.classList.add('active');
        
        document.getElementById('csLog').innerHTML = '';
        document.getElementById('csTotal').textContent = '0';
        document.getElementById('csSimples').textContent = '0';
        document.getElementById('csNormal').textContent = '0';
        document.getElementById('csMei').textContent = '0';
        document.getElementById('csErros').textContent = '0';
        document.getElementById('csBarraFill').style.width = '0%';
        document.getElementById('csBtnCancelar').style.display = 'inline-block';
        document.getElementById('csBtnFechar').style.display = 'none';
        
        let totalGeral = 0;
        let simplesGeral = 0;
        let normalGeral = 0;
        let meiGeral = 0;
        let errosGeral = 0;
        let processadosGeral = 0;
        
        for (const registroId of registrosIds) {
            if (!consultaAutoAtiva) break;
            
            addLogConsulta(`üìÇ Carregando participantes do SPED #${registroId}...`, 'info');
            document.getElementById('csStatus').textContent = `Carregando SPED #${registroId}...`;
            
            try {
                const resp = await fetch(`/importar-sped/listar-participantes-pendentes/${registroId}/`);
                const data = await resp.json();
                
                if (!data.success || data.total === 0) {
                    addLogConsulta(`‚ÑπÔ∏è SPED #${registroId}: nenhum participante pendente.`, 'info');
                    continue;
                }
                
                const participantes = data.participantes;
                totalGeral += participantes.length;
                document.getElementById('csTotal').textContent = totalGeral;
                addLogConsulta(`üîç ${participantes.length} fornecedor(es) para consultar`, 'info');
                
                for (let i = 0; i < participantes.length; i++) {
                    if (!consultaAutoAtiva) break;
                    
                    const part = participantes[i];
                    const cnpjFmt = part.cnpj.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})$/, '$1.$2.$3/$4-$5');
                    
                    document.getElementById('csStatus').textContent = `Consultando ${cnpjFmt}...`;
                    document.getElementById('csContador').textContent = `${processadosGeral + 1}/${totalGeral}`;
                    
                    try {
                        const respPart = await fetch(`/importar-sped/consultar-participante-individual/${registroId}/${part.id}/`);
                        const dataPart = await respPart.json();
                        
                        if (dataPart.success) {
                            const regime = dataPart.participante.regime;
                            if (regime === 'MEI') {
                                meiGeral++;
                                document.getElementById('csMei').textContent = meiGeral;
                            } else if (regime === 'Simples Nacional') {
                                simplesGeral++;
                                document.getElementById('csSimples').textContent = simplesGeral;
                            } else {
                                normalGeral++;
                                document.getElementById('csNormal').textContent = normalGeral;
                            }
                            addLogConsulta(`‚úì [${processadosGeral + 1}/${totalGeral}] ${part.nome.substring(0, 35)} - ${regime}`, 'success');
                        } else {
                            errosGeral++;
                            document.getElementById('csErros').textContent = errosGeral;
                            addLogConsulta(`‚úó [${processadosGeral + 1}/${totalGeral}] ${part.nome.substring(0, 35)} - ${dataPart.erro || 'Erro'}`, 'error');
                            
                            // Se rate limit, aguardar mais tempo
                            if (dataPart.erro && dataPart.erro.toLowerCase().includes('rate limit')) {
                                addLogConsulta(`‚è≥ Rate limit detectado - aguardando 12s...`, 'warn');
                                await new Promise(r => setTimeout(r, 12000));
                            }
                        }
                    } catch (e) {
                        errosGeral++;
                        document.getElementById('csErros').textContent = errosGeral;
                        addLogConsulta(`‚úó [${processadosGeral + 1}/${totalGeral}] Erro de rede: ${cnpjFmt}`, 'error');
                    }
                    
                    processadosGeral++;
                    const pct = Math.round((processadosGeral / totalGeral) * 100);
                    document.getElementById('csBarraFill').style.width = `${pct}%`;
                    document.getElementById('csContador').textContent = `${processadosGeral}/${totalGeral}`;
                    
                    // Delay de 2.5s entre consultas
                    if (i < participantes.length - 1 && consultaAutoAtiva) {
                        await new Promise(r => setTimeout(r, 2500));
                    }
                }
            } catch (e) {
                addLogConsulta(`‚ùå Erro ao carregar SPED #${registroId}: ${e.message}`, 'error');
            }
        }
        
        // Finalizado
        document.getElementById('csBarraFill').style.width = '100%';
        if (consultaAutoAtiva) {
            document.getElementById('csStatus').textContent = 'Consulta conclu√≠da!';
            document.getElementById('progressoConsultaSubtitulo').textContent = '‚úÖ Todos os fornecedores foram processados!';
            addLogConsulta(`\n‚úÖ Consulta finalizada! Simples: ${simplesGeral} | Normal: ${normalGeral} | MEI: ${meiGeral} | Erros: ${errosGeral}`, 'success');
        }
        document.getElementById('csBtnCancelar').style.display = 'none';
        document.getElementById('csBtnFechar').style.display = 'inline-block';
        consultaAutoAtiva = false;
    }
    
// Expor fun√ß√µes globalmente para serem chamadas pelo onclick do HTML
    window.iniciarConsultaAutomatica = iniciarConsultaAutomatica;
    window.fecharModalConsulta = fecharModalConsulta;
    window.cancelarConsultaAuto = cancelarConsultaAuto;
});
</script>
                <li class="nav-item">
                    <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#consulta-ativa">
                        <i class="bi bi-clock-history me-1"></i> Consulta Ativa
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#historico">
                        <i class="bi bi-list-ul me-1"></i> Hist√≥rico
                    </button>
                </li>
            </ul>

            <div class="tab-content">
                <!-- Aba Consulta Ativa -->
                <div class="tab-pane fade show active" id="consulta-ativa">
                    <div class="modal-body">
                        <div id="estado-vazio" class="text-center py-5">
                            <i class="bi bi-inbox text-muted" style="font-size: 4rem;"></i>
                            <p class="text-muted mt-3">Nenhuma consulta em andamento</p>
                        </div>

                        <div id="estado-processando" style="display: none;">
                            <div class="text-center mb-4">
                                <div class="spinner-border text-primary" role="status"></div>
                            </div>
                            <h5 class="text-center mb-3">Processando SPED...</h5>
                            <div class="progress mb-4" style="height: 25px;">
                                <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%">0%</div>
                            </div>
                            <div class="row g-3">
                                <div class="col-4">
                                    <div class="stats-card">
                                        <div class="stat-number" id="stat-current">0</div>
                                        <div class="stat-label">Processados</div>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="stats-card">
                                        <div class="stat-number" id="stat-updated">0</div>
                                        <div class="stat-label">Atualizados</div>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="stats-card">
                                        <div class="stat-number" id="stat-errors">0</div>
                                        <div class="stat-label">Erros</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="estado-concluido" style="display: none;">
                            <div class="text-center py-4">
                                <i class="bi bi-check-circle-fill success-icon"></i>
                                <h4 class="mt-3">Processamento Conclu√≠do!</h4>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    </div>
                </div>

                <!-- Aba Hist√≥rico -->
                <div class="tab-pane fade" id="historico">
                    <div class="modal-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">Hist√≥rico de Importa√ß√µes</h5>
                            <button class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-arrow-clockwise"></i> Atualizar
                            </button>
                        </div>
                        <div id="lista-historico">
                            {% for registro in registros %}
                            <div class="history-item {% if registro.processado %}completed{% endif %}">
                                <div>
                                    <div class="fw-bold">{{ registro.empresa.razao_social|truncatechars:30 }}</div>
                                    <small class="text-muted">{{ registro.tipo }} - {{ registro.periodo|date:"m/Y" }}</small>
                                </div>
                                <span class="badge {% if registro.processado %}bg-success{% else %}bg-warning{% endif %}">
                                    {% if registro.processado %}Conclu√≠do{% else %}Pendente{% endif %}
                                </span>
                            </div>
                            {% empty %}
                            <div class="text-center py-4 text-muted">
                                <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                                <p class="mt-2">Nenhuma importa√ß√£o realizada</p>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
