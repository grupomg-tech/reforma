{% extends "base.html" %}
{% load static %}

{% block title %}Importar SPED{% endblock %}

{% block extra_css %}
<style>
    .import-container {
        max-width: 600px;
        margin: 0 auto;
    }
    
    .header-section {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        color: white;
        padding: 20px;
        border-radius: 12px 12px 0 0;
    }
    
    .content-section {
        background: white;
        padding: 30px;
        border-radius: 0 0 12px 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    
    .btn-primary-custom {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        border: none;
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 600;
    }
    
    .btn-primary-custom:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(140, 64, 240, 0.4);
        color: white;
    }
    
    .btn-success-custom {
        background: #28a745;
        border: none;
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 600;
    }
    
    .progress-modal .modal-content {
        border-radius: 12px;
        overflow: hidden;
    }
    
    .progress-modal .nav-tabs {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        border: none;
    }
    
    .progress-modal .nav-link {
        color: rgba(255,255,255,0.7);
        border: none;
        padding: 15px 25px;
    }
    
    .progress-modal .nav-link.active {
        background: rgba(255,255,255,0.2);
        color: white;
    }
    
    .stats-card {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 10px;
        text-align: center;
    }
    
    .stat-number {
        font-size: 2rem;
        font-weight: bold;
        color: var(--primary-color);
    }
    
    .stat-label {
        font-size: 0.85rem;
        color: #6c757d;
    }
    
    .history-item {
        background: white;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 8px;
        border-left: 4px solid #0d6efd;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .history-item.completed { border-left-color: #28a745; }
    .history-item.error { border-left-color: #dc3545; }
    .history-item.processing { border-left-color: #ffc107; }
    
    .success-icon {
        color: #28a745;
        font-size: 3rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="import-container">
        <div class="header-section text-center">
            <h5 class="mb-0">
                <i class="bi bi-upload me-2"></i>
                Importar Arquivo SPED
            </h5>
        </div>
        
        <div class="content-section">
            <form id="importarSpedForm" method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                
                <div class="mb-4">
                    <label class="form-label fw-semibold">Selecione o tipo de SPED:</label>
                    <div class="d-flex gap-4">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="tipo" value="fiscal" id="tipoFiscal" required>
                            <label class="form-check-label" for="tipoFiscal">SPED Fiscal</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="tipo" value="registro" id="tipoContribuicoes" required>
                            <label class="form-check-label" for="tipoContribuicoes">SPED Contribuições</label>
                        </div>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label for="arquivoSped" class="form-label fw-semibold">Selecione o arquivo SPED:</label>
                    <input class="form-control" type="file" id="arquivoSped" name="arquivo_sped" accept=".txt,.zip" required>
                    <small class="text-muted">Formatos aceitos: .txt ou .zip</small>
                </div>
                
                <div class="form-check mb-4">
                    <input class="form-check-input" type="checkbox" id="sobrescrever" name="sobrescrever">
                    <label class="form-check-label" for="sobrescrever">
                        Sobrescrever dados existentes?
                    </label>
                </div>
                
                <div class="d-flex gap-2">
                    <button id="btnImportar" type="submit" class="btn btn-primary-custom flex-grow-1">
                        <i class="bi bi-upload me-1"></i> Enviar
                    </button>
                    <button type="button" class="btn btn-success-custom" data-bs-toggle="modal" data-bs-target="#modalConsultas">
                        <i class="bi bi-clock-history me-1"></i> Processamentos
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal de Processamentos -->
<div class="modal fade progress-modal" id="modalConsultas" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <ul class="nav nav-tabs" role="tablist">
                <li class="nav-item">
                    <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#consulta-ativa">
                        <i class="bi bi-clock-history me-1"></i> Consulta Ativa
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#consulta-cnpj">
                        <i class="bi bi-search me-1"></i> Consultar CNPJs
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#historico">
                        <i class="bi bi-list-ul me-1"></i> Histórico
                    </button>
                </li>
            </ul>

            <div class="tab-content">
                <!-- Aba Consulta Ativa -->
                <div class="tab-pane fade show active" id="consulta-ativa">
                    <div class="modal-body">
                        <div id="estado-vazio" class="text-center py-5">
                            <i class="bi bi-inbox text-muted" style="font-size: 4rem;"></i>
                            <p class="text-muted mt-3">Nenhuma consulta em andamento</p>
                        </div>

                        <div id="estado-processando" style="display: none;">
                            <div class="text-center mb-4">
                                <div class="spinner-border text-primary" role="status"></div>
                            </div>
                            <h5 class="text-center mb-3">Processando SPED...</h5>
                            <div class="progress mb-4" style="height: 25px;">
                                <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%">0%</div>
                            </div>
                            <div class="row g-3">
                                <div class="col-4">
                                    <div class="stats-card">
                                        <div class="stat-number" id="stat-current">0</div>
                                        <div class="stat-label">Processados</div>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="stats-card">
                                        <div class="stat-number" id="stat-updated">0</div>
                                        <div class="stat-label">Atualizados</div>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="stats-card">
                                        <div class="stat-number" id="stat-errors">0</div>
                                        <div class="stat-label">Erros</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="estado-concluido" style="display: none;">
                            <div class="text-center py-4">
                                <i class="bi bi-check-circle-fill success-icon"></i>
                                <h4 class="mt-3">Processamento Concluído!</h4>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    </div>
                </div>

                <!-- Aba Consultar CNPJs -->
                <div class="tab-pane fade" id="consulta-cnpj">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Selecione o SPED para consultar fornecedores:</label>
                            <select class="form-select" id="selectRegistroConsulta">
                                <option value="">Selecione um SPED importado...</option>
                                {% for registro in registros %}
                                <option value="{{ registro.id }}">
                                    {{ registro.empresa.razao_social|truncatechars:30 }} - {{ registro.tipo }} - {{ registro.periodo|date:"m/Y" }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div id="info-participantes" style="display: none;">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                <span id="info-pendentes">0</span> fornecedores pendentes de consulta
                            </div>
                            
                            <button type="button" class="btn btn-primary w-100 mb-3" id="btnIniciarConsulta">
                                <i class="bi bi-search me-1"></i> Iniciar Consulta de CNPJs
                            </button>
                        </div>
                        
                        <div id="consulta-em-andamento" style="display: none;">
                            <h5 class="text-center mb-3">
                                <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                                Consultando CNPJs...
                            </h5>
                            <div class="progress mb-3" style="height: 25px;">
                                <div id="progress-cnpj" class="progress-bar progress-bar-striped progress-bar-animated bg-success" style="width: 0%">0%</div>
                            </div>
                            <div id="log-consulta" class="border rounded p-3 bg-light" style="max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px;">
                                <!-- Log em tempo real -->
                            </div>
                        </div>
                        
                        <div id="consulta-concluida" style="display: none;">
                            <div class="text-center py-4">
                                <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
                                <h4 class="mt-3">Consulta Concluída!</h4>
                                <div class="row g-3 mt-3">
                                    <div class="col-4">
                                        <div class="stats-card">
                                            <div class="stat-number text-success" id="stat-simples">0</div>
                                            <div class="stat-label">Simples Nacional</div>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="stats-card">
                                            <div class="stat-number text-primary" id="stat-normal">0</div>
                                            <div class="stat-label">Regime Normal</div>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="stats-card">
                                            <div class="stat-number text-warning" id="stat-mei">0</div>
                                            <div class="stat-label">MEI</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    </div>
                </div>

                <!-- Aba Histórico -->
                <div class="tab-pane fade" id="historico">
                    <div class="modal-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">Histórico de Importações</h5>
                            <button class="btn btn-sm btn-outline-primary" onclick="location.reload()">
                                <i class="bi bi-arrow-clockwise"></i> Atualizar
                            </button>
                        </div>
                        <div id="lista-historico">
                            {% for registro in registros %}
                            <div class="history-item {% if registro.processado %}completed{% endif %}">
                                <div>
                                    <div class="fw-bold">{{ registro.empresa.razao_social|truncatechars:30 }}</div>
                                    <small class="text-muted">{{ registro.tipo }} - {{ registro.periodo|date:"m/Y" }}</small>
                                </div>
                                <span class="badge {% if registro.processado %}bg-success{% else %}bg-warning{% endif %}">
                                    {% if registro.processado %}Concluído{% else %}Pendente{% endif %}
                                </span>
                            </div>
                            {% empty %}
                            <div class="text-center py-4 text-muted">
                                <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                                <p class="mt-2">Nenhuma importação realizada</p>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const selectRegistro = document.getElementById('selectRegistroConsulta');
    const infoParticipantes = document.getElementById('info-participantes');
    const infoPendentes = document.getElementById('info-pendentes');
    const btnIniciarConsulta = document.getElementById('btnIniciarConsulta');
    const consultaEmAndamento = document.getElementById('consulta-em-andamento');
    const consultaConcluida = document.getElementById('consulta-concluida');
    const logConsulta = document.getElementById('log-consulta');
    const progressCnpj = document.getElementById('progress-cnpj');
    
    let participantesPendentes = [];
    let consultaAtiva = false;
    
    // Ao selecionar um registro
    selectRegistro.addEventListener('change', function() {
        const registroId = this.value;
        if (!registroId) {
            infoParticipantes.style.display = 'none';
            return;
        }
        
        // Buscar participantes pendentes
        fetch(`/importar-sped/listar-participantes-pendentes/${registroId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    participantesPendentes = data.participantes;
                    infoPendentes.textContent = data.total;
                    infoParticipantes.style.display = 'block';
                    consultaEmAndamento.style.display = 'none';
                    consultaConcluida.style.display = 'none';
                }
            });
    });
    
    // Iniciar consulta
    btnIniciarConsulta.addEventListener('click', async function() {
        if (participantesPendentes.length === 0) {
            alert('Nenhum fornecedor pendente de consulta.');
            return;
        }
        
        consultaAtiva = true;
        infoParticipantes.style.display = 'none';
        consultaEmAndamento.style.display = 'block';
        logConsulta.innerHTML = '';
        
        const registroId = selectRegistro.value;
        const total = participantesPendentes.length;
        let processados = 0;
        let simples = 0;
        let normal = 0;
        let mei = 0;
        let erros = 0;
        
        for (const part of participantesPendentes) {
            if (!consultaAtiva) break;
            
            const cnpjFormatado = part.cnpj.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})$/, '$1.$2.$3/$4-$5');
            addLog(`[${processados + 1}/${total}] Consultando ${cnpjFormatado}...`, 'info');
            
            try {
                const response = await fetch(`/importar-sped/consultar-participante-individual/${registroId}/${part.id}/`);
                const data = await response.json();
                
                if (data.success) {
                    const regime = data.participante.regime;
                    if (regime === 'MEI') mei++;
                    else if (regime === 'Simples Nacional') simples++;
                    else normal++;
                    
                    addLog(`✓ ${part.nome.substring(0, 30)} - ${regime}`, 'success');
                } else {
                    erros++;
                    addLog(`✗ ${part.nome.substring(0, 30)} - ${data.erro || 'Erro'}`, 'error');
                }
            } catch (e) {
                erros++;
                addLog(`✗ Erro ao consultar ${cnpjFormatado}`, 'error');
            }
            
            processados++;
            const percentual = Math.round((processados / total) * 100);
            progressCnpj.style.width = `${percentual}%`;
            progressCnpj.textContent = `${percentual}%`;
            
            // Delay de 1.5s para respeitar rate limit das APIs
            if (processados < total) {
                await new Promise(resolve => setTimeout(resolve, 1500));
            }
        }
        
        // Consulta concluída
        consultaEmAndamento.style.display = 'none';
        consultaConcluida.style.display = 'block';
        document.getElementById('stat-simples').textContent = simples;
        document.getElementById('stat-normal').textContent = normal;
        document.getElementById('stat-mei').textContent = mei;
    });
    
    function addLog(message, type) {
        const color = type === 'success' ? 'green' : type === 'error' ? 'red' : '#333';
        logConsulta.innerHTML += `<div style="color: ${color};">${message}</div>`;
        logConsulta.scrollTop = logConsulta.scrollHeight;
    }
});
</script>
                <li class="nav-item">
                    <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#consulta-ativa">
                        <i class="bi bi-clock-history me-1"></i> Consulta Ativa
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#historico">
                        <i class="bi bi-list-ul me-1"></i> Histórico
                    </button>
                </li>
            </ul>

            <div class="tab-content">
                <!-- Aba Consulta Ativa -->
                <div class="tab-pane fade show active" id="consulta-ativa">
                    <div class="modal-body">
                        <div id="estado-vazio" class="text-center py-5">
                            <i class="bi bi-inbox text-muted" style="font-size: 4rem;"></i>
                            <p class="text-muted mt-3">Nenhuma consulta em andamento</p>
                        </div>

                        <div id="estado-processando" style="display: none;">
                            <div class="text-center mb-4">
                                <div class="spinner-border text-primary" role="status"></div>
                            </div>
                            <h5 class="text-center mb-3">Processando SPED...</h5>
                            <div class="progress mb-4" style="height: 25px;">
                                <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%">0%</div>
                            </div>
                            <div class="row g-3">
                                <div class="col-4">
                                    <div class="stats-card">
                                        <div class="stat-number" id="stat-current">0</div>
                                        <div class="stat-label">Processados</div>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="stats-card">
                                        <div class="stat-number" id="stat-updated">0</div>
                                        <div class="stat-label">Atualizados</div>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="stats-card">
                                        <div class="stat-number" id="stat-errors">0</div>
                                        <div class="stat-label">Erros</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="estado-concluido" style="display: none;">
                            <div class="text-center py-4">
                                <i class="bi bi-check-circle-fill success-icon"></i>
                                <h4 class="mt-3">Processamento Concluído!</h4>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    </div>
                </div>

                <!-- Aba Histórico -->
                <div class="tab-pane fade" id="historico">
                    <div class="modal-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">Histórico de Importações</h5>
                            <button class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-arrow-clockwise"></i> Atualizar
                            </button>
                        </div>
                        <div id="lista-historico">
                            {% for registro in registros %}
                            <div class="history-item {% if registro.processado %}completed{% endif %}">
                                <div>
                                    <div class="fw-bold">{{ registro.empresa.razao_social|truncatechars:30 }}</div>
                                    <small class="text-muted">{{ registro.tipo }} - {{ registro.periodo|date:"m/Y" }}</small>
                                </div>
                                <span class="badge {% if registro.processado %}bg-success{% else %}bg-warning{% endif %}">
                                    {% if registro.processado %}Concluído{% else %}Pendente{% endif %}
                                </span>
                            </div>
                            {% empty %}
                            <div class="text-center py-4 text-muted">
                                <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                                <p class="mt-2">Nenhuma importação realizada</p>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
