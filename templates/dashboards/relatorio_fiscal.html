{% extends "base.html" %}
{% load static %}

{% block title %}Relat√≥rio Reforma Tribut√°ria{% endblock %}

{% block extra_css %}
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    .container-relatorio {
        max-width: 1600px;
        margin: 0 auto;
        background: white;
        border-bottom-right-radius: 10px;
        border-bottom-left-radius: 10px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        overflow: hidden;
    }
    
    .header-relatorio {
        max-width: 1600px;
        margin: 0 auto;
        background: linear-gradient(135deg, #4e6ae9 0%, #764ba2 100%);
        color: white;
        padding: 7px;
        text-align: left;
        border-top-left-radius: 10px;
        border-top-right-radius: 10px;
    }
    
    .header-relatorio h4 {
        font-size: 24px;
        font-weight: 600;
        margin: 5px;
    }
    
    .content-wrapper-relatorio {
        padding: 10px;
    }
    
    .form-filtros {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
    }

    .filters-section:first-of-type {
        flex: 2;
    }

    .filters-section:last-of-type {
        flex: 1;
    }

    .filters-section {
        min-width: 300px;
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
        padding-bottom: 20px;
    }
    
    .filter-group {
        display: flex;
        flex-direction: column;
        max-width: 400px;
    }
    
    .filter-group label {
        font-weight: 600;
        margin-bottom: 8px;
        color: #2c3e50;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .filter-group select,
    .filter-group input {
        padding: 12px 15px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.3s ease;
        background: white;
    }

    .filter-group-aliquota select,
    .filter-group-aliquota input {
        max-width: 115px;
    }
    
    .filter-group select:focus,
    .filter-group input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .btn-filtrar {
        grid-column: 1 / -1;
        padding: 11px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-top: 25px;
    }
    
    .btn-filtrar:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }
    
    /* Tabs */
    .tabs-container {
        margin-bottom: 30px;
    }
    
    .tabs-header {
        display: flex;
        gap: 5px;
        border-bottom: 2px solid #e0e0e0;
        margin-bottom: 15px;
    }
    
    .tab-button {
        padding: 15px 30px;
        background: transparent;
        border: none;
        border-bottom: 3px solid transparent;
        color: #6c757d;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
    }
    
    .tab-button:hover {
        color: #667eea;
        background: #f8f9fa;
    }
    
    .tab-button.active {
        color: #667eea;
        border-bottom-color: #667eea;
        background: white;
    }
    
    .tab-content {
        display: none;
        animation: fadeIn 0.3s ease;
    }
    
    .tab-content.active {
        display: block;
    }
    
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* Metrics Cards */
    .vertical-label {
        writing-mode: vertical-rl;
        transform: rotate(180deg);
        text-orientation: mixed;
        padding: 10px 5px;
        background-color: black;
        border-radius: 12px;
        text-align: center;
        color: white;
        font-weight: 600;
        font-size: 14px;
        letter-spacing: 1px;
        white-space: nowrap;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 50px;
        flex-shrink: 0;
        margin-bottom: 10px;
        text-transform: uppercase;
    }

    .metrics-section {
        display: flex;
        gap: 10px;
        align-items: stretch;
        width: 100%;
    }
    
    .metric-card {
        flex: 1;
        padding: 10px;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        border-radius: 12px;
        text-align: center;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        border: 1px solid rgba(255,255,255,0.5);
        bottom: 10px;
        margin-bottom: 10px;
    }
    
    .metric-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }
    
    .metric-card h3 {
        font-size: 12px;
        color: #6c757d;
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 600;
    }
    
    .metric-card .value {
        font-size: 24px;
        font-weight: 700;
        color: #2c3e50;
    }

    .metric-card .value-positive {
        font-size: 24px;
        font-weight: 700;
        color: #00692f;
    }

    .metric-card .value-negative {
        font-size: 24px;
        font-weight: 700;
        color: #630202;
    }
    
    .metric-card.reforma {
        background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
    }
    
    .section-title {
        font-size: 14px;
        color: #667eea;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 15px;
        padding-bottom: 10px;
        padding-top: 15px;
        border-bottom: 2px solid #667eea;
    }

    .section-title-pizza {
        font-size: 14px;
        color: #667eea;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #667eea;
        padding-left: 150px;
        padding-right: 150px;
    }
    
    /* Tables */
    .tables-section {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
        gap: 25px;
        margin-top: 30px;
    }
    
    .table-container {
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid #e0e0e0;
        background: white;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }
    
    .table-container h2 {
        background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        color: white;
        padding: 20px;
        font-size: 16px;
        font-weight: 600;
        text-align: center;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    .table-relatorio {
        width: 100%;
        min-width: max-content;
        border-collapse: collapse;
    }
    
    .table-relatorio thead {
        background: rgb(240, 248, 255);
        position: sticky;
        top: 0;
        z-index: 10;
        border-bottom: 2px solid #667eea;
    }
    
    .table-relatorio th {
        padding: 12px 12px;
        text-align: center;
        font-weight: 600;
        font-size: 12px;
        color: #2c3e50;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-right: #f0f0f0 1px solid;
    }

    .table-relatorio th.reforma {
        background-color:#ffbe1b ;
    }
    
    .table-relatorio td {
        padding: 10px 6px;
        border-bottom: 1px solid #f0f0f0;
        font-size: 12px;
        color: #495057;
        text-align: center;
        white-space: nowrap;
        border-right: #f0f0f0 1px solid;
    }

    .table-relatorio td.reforma {
        background-color: #fcdb9e;
    }
    
    .table-relatorio tbody tr {
        transition: background 0.2s ease;
    }
    
    .table-relatorio tbody tr:hover {
        background: #f8f9fa;
    }
    
    .table-relatorio tfoot {
        background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        color: white;
        position: sticky;
        bottom: 0;
        z-index: 10;
        font-weight: 700;
    }
    
    .table-relatorio tfoot td {
        padding: 12px 10px;
        border-top: 3px solid #667eea;
        border-bottom: none;
        color: white;
        font-size: 14px;
    }

    .table-relatorio tfoot td.reforma {
        background-color: #ffbe1b;
        color: black;
    }
    
    .table-relatorio tfoot td:first-child {
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .table-scroll {
        max-height: 500px;
        overflow-y: auto;
        overflow-x: auto;
    }
    
    .table-scroll::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }
    
    .table-scroll::-webkit-scrollbar-track {
        background: #f1f1f1;
    }
    
    .table-scroll::-webkit-scrollbar-thumb {
        background: #667eea;
        border-radius: 4px;
    }
    
    .table-scroll::-webkit-scrollbar-thumb:hover {
        background: #5568d3;
    }
    
    .empty-state {
        padding: 60px 40px;
        text-align: center;
        color: #999;
    }
    
    .empty-state-icon {
        font-size: 48px;
        margin-bottom: 15px;
        opacity: 0.5;
    }
    
    .empty-state-text {
        font-size: 16px;
        color: #6c757d;
    }
    
    .table-container.full-width {
        grid-column: 1 / -1;
        margin-bottom: 30px;
    }

    /* Charts Grid */
    .grafico-grid {
        display: grid !important;
        grid-template-columns: 1fr 1fr !important;
        gap: 30px !important;
        margin: 40px 0 !important;
    }

    .grafico-grid canvas {
        width: 100% !important;
        height: 350px !important;
    }

    /* Tabelas de Transi√ß√£o */
    .table-scroll-trans {
        width: 100%;
        overflow-x: hidden;
    }

    .transicao-table {
        width: 100%;
        min-width: 100%;
        table-layout: fixed;
        font-size: 13px;
    }
    
    .transicao-table thead th {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        text-align: center;
        padding: 15px 10px;
        font-size: 13px;
    }
    
    .transicao-table tbody td {
        text-align: center;
        padding: 12px 10px;
    }
    
    .transicao-table tbody td:first-child {
        text-align: left;
        font-weight: 600;
        background: #f8f9fa;
    }
    
    .transicao-table .row-destaque {
        background: linear-gradient(135deg, #e0e7ff 0%, #e9d5ff 100%);
        font-weight: 700;
    }
    
    .transicao-table .row-destaque td {
        color: #667eea;
    }
    
    .transicao-table .row-reforma {
        background: #fef3c7;
    }
    
    .transicao-table .row-reforma td:first-child {
        background: #fbbf24;
        color: white;
    }
    
    .transicao-table .row-total {
        background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        color: white;
        font-weight: 700;
    }
    
    .transicao-table .row-total td {
        color: white;
        background: transparent;
    }

    /* Bot√£o de Exporta√ß√£o */
    .btn-export {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 10px;
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
    }
    
    .btn-export:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(16, 185, 129, 0.3);
        color: white;
    }
    
    .btn-export svg {
        width: 16px;
        height: 16px;
    }
    
    .table-header-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 20px;
        background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        min-height: 70px;
    }
    
    .table-header-container h2 {
        margin: 0;
        padding: 0;
        color: white;
        font-size: 16px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .btn-exportar-pdf {
        background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        color: white;
        border: none;
        padding: 15px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 4px 6px rgba(220, 38, 38, 0.3);
        transition: all 0.3s ease;
        text-decoration: none;
        margin-top: 25px;
    }

    .btn-exportar-pdf:hover {
        background: linear-gradient(135deg, #b91c1c 0%, #991b1b 100%);
        box-shadow: 0 6px 8px rgba(220, 38, 38, 0.4);
        transform: translateY(-2px);
        color: white;
    }

    .btn-buscar-api {
        background: linear-gradient(135deg, #059669 0%, #047857 100%);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: all 0.3s ease;
    }

    .btn-buscar-api:hover {
        background: linear-gradient(135deg, #047857 0%, #065f46 100%);
        transform: translateY(-1px);
    }

    .btn-buscar-api:disabled {
        background: #9ca3af;
        cursor: not-allowed;
        transform: none;
    }

    .btn-retomar-api {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        display: none;
        align-items: center;
        gap: 6px;
        transition: all 0.3s ease;
    }

    .btn-retomar-api:hover {
        background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
        transform: translateY(-1px);
    }

    .btn-retomar-api.visible {
        display: inline-flex;
    }

    .btn-ver-pendencias {
        background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        display: none;
        align-items: center;
        gap: 6px;
        transition: all 0.3s ease;
    }

    .btn-ver-pendencias:hover {
        background: linear-gradient(135deg, #4f46e5 0%, #4338ca 100%);
        transform: translateY(-1px);
    }

    .btn-ver-pendencias.visible {
        display: inline-flex;
    }

    /* Modal de Pend√™ncias */
    .modal-pendencias {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 10000;
        justify-content: center;
        align-items: center;
    }

    .modal-pendencias.active {
        display: flex;
    }

    .modal-pendencias-content {
        background: white;
        border-radius: 16px;
        padding: 30px;
        width: 95%;
        max-width: 900px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        position: relative;
    }

    .modal-pendencias-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e5e7eb;
    }

    .modal-pendencias-header h3 {
        margin: 0;
        color: #1f2937;
        font-size: 1.3rem;
    }

    .tabela-pendencias {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
    }

    .tabela-pendencias th {
        background: #f3f4f6;
        padding: 12px 10px;
        text-align: left;
        font-weight: 600;
        color: #374151;
        border-bottom: 2px solid #e5e7eb;
    }

    .tabela-pendencias td {
        padding: 10px;
        border-bottom: 1px solid #e5e7eb;
        color: #4b5563;
    }

    .tabela-pendencias tr:hover {
        background: #f9fafb;
    }

    .tabela-pendencias .chave-acesso {
        font-family: monospace;
        font-size: 11px;
        word-break: break-all;
    }

    .badge-erro {
        background: #fee2e2;
        color: #dc2626;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 11px;
    }

    .badge-nfce {
        background: #fef3c7;
        color: #d97706;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 11px;
    }

    .secao-pendencias {
        margin-bottom: 25px;
    }

    .secao-pendencias h4 {
        color: #1f2937;
        font-size: 1rem;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .contador-pendencias {
        background: #ef4444;
        color: white;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 12px;
    }

    .contador-nfce {
        background: #f59e0b;
        color: white;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 12px;
    }

    /* Modal de Progresso API */
    .modal-progresso-api {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 9999;
        justify-content: center;
        align-items: center;
    }

    .modal-progresso-api.active {
        display: flex;
    }

    .modal-progresso-content {
        background: white;
        border-radius: 16px;
        padding: 30px;
        width: 90%;
        max-width: 600px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        position: relative;
    }

    .btn-fechar-modal-x {
        position: absolute;
        top: 15px;
        right: 15px;
        background: #6b7280;
        color: white;
        border: none;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.3s;
        z-index: 10;
    }

    .btn-fechar-modal-x:hover {
        background: #4b5563;
    }

    .progresso-header {
        text-align: center;
        margin-bottom: 25px;
    }

    .progresso-header h3 {
        color: #1f2937;
        margin: 0;
        font-size: 1.5rem;
    }

    .progresso-header p {
        color: #6b7280;
        margin: 10px 0 0;
    }

    .progresso-stats {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 15px;
        margin-bottom: 25px;
    }

    .stat-box {
        background: #f3f4f6;
        padding: 15px;
        border-radius: 10px;
        text-align: center;
    }

    .stat-box.success { background: #d1fae5; }
    .stat-box.error { background: #fee2e2; }
    .stat-box.produtos { background: #dbeafe; }

    .stat-number {
        font-size: 1.8rem;
        font-weight: bold;
        color: #1f2937;
    }

    .stat-label {
        font-size: 0.8rem;
        color: #6b7280;
        margin-top: 5px;
    }

    .progresso-barra-container {
        margin-bottom: 20px;
    }

    .progresso-info {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        font-size: 0.9rem;
        color: #4b5563;
    }

    .progresso-barra {
        height: 12px;
        background: #e5e7eb;
        border-radius: 6px;
        overflow: hidden;
    }

    .progresso-barra-fill {
        height: 100%;
        background: linear-gradient(90deg, #059669, #10b981);
        border-radius: 6px;
        transition: width 0.3s ease;
        width: 0%;
    }

    .progresso-nota-atual {
        background: #f9fafb;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        font-size: 0.9rem;
    }

    .progresso-nota-atual strong {
        color: #059669;
    }

    .progresso-acoes {
        display: flex;
        justify-content: center;
        gap: 15px;
    }

    .btn-cancelar-busca {
        background: #ef4444;
        color: white;
        border: none;
        padding: 10px 25px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
    }

    .btn-fechar-progresso {
        background: #3b82f6;
        color: white;
        border: none;
        padding: 10px 25px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        display: none;
    }

    @media (max-width: 768px) {
        .grafico-grid {
            grid-template-columns: 1fr;
        }
    }
    
    @media (max-width: 1200px) {
        .tables-section {
            grid-template-columns: 1fr;
        }
    }
    
    @media (max-width: 768px) {
        .filters-section {
            grid-template-columns: 1fr;
        }
        
        .metrics-section {
            grid-template-columns: 1fr;
        }
        
        .tabs-header {
            overflow-x: auto;
        }
        
        .tab-button {
            white-space: nowrap;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="header-relatorio">
    <h4>
        <i class="fas fa-file-invoice me-2"></i>
        An√°lise Reforma Tribut√°ria
    </h4>
</div>
<div class="container-relatorio">
    <div class="content-wrapper-relatorio">
        <form id="formFiltroRelatorio" method="GET" action="" class="form-filtros">
            <div class="filters-section">
                <div class="filter-group">
                    <label>üè¢ Empresa</label>
                    <select name="empresa" required id="empresaSelect" onchange="carregarPeriodos()">
                        <option value="">Selecione a empresa</option>
                        {% for empresa in empresas %}
                        <option value="{{ empresa.id }}" {% if request.GET.empresa == empresa.id|stringformat:"s" %}selected{% endif %}>
                            {{ empresa.cnpj }} - {{ empresa.razao_social }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>üìÖ Per√≠odo Inicial</label>
                    <select name="periodo_inicial" required id="periodoInicialSelect">
                        <option value="">Selecione o in√≠cio</option>
                        {% for periodo in periodos %}
                        <option value="{{ periodo }}" {% if request.GET.periodo_inicial == periodo %}selected{% endif %}>{{ periodo }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>üìÖ Per√≠odo Final</label>
                    <select name="periodo_final" required id="periodoFinalSelect">
                        <option value="">Selecione o fim</option>
                        {% for periodo in periodos %}
                        <option value="{{ periodo }}" {% if request.GET.periodo_final == periodo %}selected{% endif %}>{{ periodo }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <button type="submit" class="btn-filtrar" onclick="mostrarSpinnerCarregamento()">
                    üîç Filtrar
                </button>
            </div>

            <div class="filters-section">                   
                <div class="filter-group filter-group-aliquota">
                    <label>üí∞ Al√≠quota IBS</label>
                    <input type="number" name="aliquota_ibs" value="{{ request.GET.aliquota_ibs|default:'18.5' }}" placeholder="Ex: 18.5" step="0.01">
                </div>

                <div class="filter-group filter-group-aliquota">
                    <label>üí∞ Al√≠quota CBS</label>
                    <input type="number" name="aliquota_cbs" value="{{ request.GET.aliquota_cbs|default:'8.5' }}" placeholder="Ex: 8.5" step="0.01">
                </div>

                <div class="filter-group filter-group-aliquota">
                    <label>üí∞ Al√≠quota IS</label>
                    <input type="number" name="aliquota_is" value="{{ request.GET.aliquota_is|default:'0' }}" placeholder="Ex: 2" step="0.01">
                </div>   

                <div class="filter-group filter-group-aliquota">
                    <label>üí∞ Al√≠quota SN</label>
                    <input type="number" name="aliquota_sn" value="{{ request.GET.aliquota_sn }}" placeholder="Ex: 3" step="0.01">
                </div>

                <div class="filter-group">
                    <label>
                        <input type="checkbox" name="filiais" value="1" {% if request.GET.filiais %}checked{% endif %}>
                        Agrupar matriz e filiais?
                    </label>
                </div>
            </div>
        </form>
        
        <!-- Tabs Navigation -->
        <div class="tabs-container">
            <div class="tabs-header">
                <button class="tab-button active" onclick="openTab(event, 'resumo')">
                    üìà Resumo
                </button>
                <button class="tab-button" onclick="openTab(event, 'entradas')">
                    üì• Entradas
                </button>
                <button class="tab-button" onclick="openTab(event, 'saidas')">
                    üì§ Sa√≠das
                </button>
                <button class="tab-button" onclick="openTab(event, 'transicao')">
                    üîÑ Transi√ß√£o
                </button>
            </div>
            
            <!-- Tab: Resumo -->
            <div id="resumo" class="tab-content active">
                <div class="section-title">Apura√ß√£o</div>
                <div class="metrics-section">
                    <div class="vertical-label">Atual</div>

                    <div class="metric-card">
                        <h3>D√©bitos</h3>
                        <div class="value">R$ {{ debitos_atual|default:"0"|floatformat:2 }}</div>
                    </div>
                    
                    <div class="metric-card">
                        <h3>Cr√©ditos</h3>
                        <div class="value">R$ {{ creditos_atual|default:"0"|floatformat:2 }}</div>
                    </div>

                    <div class="metric-card">
                        <h3>Resultado</h3>
                        <div class="{% if resultado_atual >= 0 %}value-positive{% else %}value-negative{% endif %}">
                            R$ {{ resultado_atual|default:"0"|floatformat:2 }}
                        </div>
                    </div>
                    
                    <div class="metric-card">
                        <h3>Carga Trib. Efetiva</h3>
                        <div class="{% if carga_atual >= 0 %}value-positive{% else %}value-negative{% endif %}">
                            {{ carga_atual|default:"0,00" }}%
                        </div>
                    </div>
                </div>

                <div class="metrics-section">
                    <div class="vertical-label">Reforma</div>
                    
                    <div class="metric-card reforma">
                        <h3>D√©bitos</h3>
                        <div class="value">R$ {{ debitos_reforma|default:"0"|floatformat:2 }}</div>
                    </div>
                    
                    <div class="metric-card reforma">
                        <h3>Cr√©ditos</h3>
                        <div class="value">R$ {{ creditos_reforma|default:"0"|floatformat:2 }}</div>
                    </div>

                    <div class="metric-card reforma">
                        <h3>Resultado</h3>
                        <div class="{% if resultado_reforma >= 0 %}value-positive{% else %}value-negative{% endif %}">
                            R$ {{ resultado_reforma|default:"0"|floatformat:2 }}
                        </div>
                    </div>

                    <div class="metric-card reforma">
                        <h3>Carga Trib. Efetiva</h3>
                        <div class="{% if carga_reforma >= 0 %}value-positive{% else %}value-negative{% endif %}">
                            {{ carga_reforma|default:"0,00" }}%
                        </div>
                    </div>
                </div>

                <div class="grafico-grid">
                    <div class="section-title">Gr√°fico Carga Tribut√°ria - Compras
                        <canvas id="chartCargaCompras"></canvas>
                    </div>
                    <div class="section-title">Gr√°fico Carga Tribut√°ria - Vendas
                        <canvas id="chartCargaVendas"></canvas>
                    </div>
                </div>

                <div class="grafico-grid">
                    <div class="section-title-pizza">Tributos Entradas
                        <canvas id="chartTributosEntradas"></canvas>
                    </div>
                    <div class="section-title-pizza">Tributos Sa√≠das
                        <canvas id="chartTributosSaidas"></canvas>
                    </div>
                </div>

                <div class="grafico-grid">
                    <div class="section-title">Comparativo Entradas
                        <canvas id="chartComparativoEntradas"></canvas>
                    </div>
                    <div class="section-title">Comparativo Sa√≠das
                        <canvas id="chartComparativoSaidas"></canvas>
                    </div>
                </div>
            </div>

            <!-- Tab: Entradas -->
            <div id="entradas" class="tab-content">
                <div class="section-title">üìä Sistema Tribut√°rio Atual</div>
                <div class="metrics-section">
                    <div class="metric-card">
                        <h3>Compra Bruta</h3>
                        <div class="value">R$ {{ compra_bruta_fmt|default:"0,00" }}</div>
                    </div>
                    
                    <div class="metric-card">
                        <h3>Cr√©ditos</h3>
                        <div class="value">R$ {{ creditos_entradas_fmt|default:"0,00" }}</div>
                    </div>
                    
                    <div class="metric-card">
                        <h3>Compra L√≠quida</h3>
                        <div class="value">R$ {{ compra_liquida_fmt|default:"0,00" }}</div>
                    </div>
                    
                    <div class="metric-card">
                        <h3>Carga Tribut√°ria</h3>
                        <div class="value">{{ carga_entradas|default:"0,00" }}%</div>
                    </div>
                </div>

                <div class="section-title">üîÑ Proje√ß√£o com Reforma Tribut√°ria</div>
                <div class="metrics-section">
                    <div class="metric-card reforma">
                        <h3>Compra L√≠quida</h3>
                        <div class="value">R$ {{ compra_liquida_reforma_fmt|default:"0,00" }}</div>
                    </div>
                    
                    <div class="metric-card reforma">
                        <h3>Cr√©ditos IBS/CBS</h3>
                        <div class="value">R$ {{ creditos_ibs_cbs_fmt|default:"0,00" }}</div>
                    </div>
                    
                    <div class="metric-card reforma">
                        <h3>Compra Total</h3>
                        <div class="value">R$ {{ compra_total_reforma_fmt|default:"0,00" }}</div>
                    </div>
                    
                    <div class="metric-card reforma">
                        <h3>Carga Tribut√°ria</h3>
                        <div class="value">{{ carga_entradas_reforma|default:"0,00" }}%</div>
                    </div>
                </div>
                
                <div class="tables-section">
                    <!-- Produtos -->
                    <div class="table-container full-width">
                        <div class="table-header-container">
                            <h2>üõí Produtos Adquiridos</h2>
                            <a href="#" class="btn-export" onclick="exportarProdutosEntradas(); return false;">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                Exportar Excel
                            </a>
                        </div>
                        <div class="table-scroll">
                            {% if produtos_entradas %}
                            <table class="table-relatorio">
                                <thead>
                                    <tr>
                                        <th>C√≥digo</th>
                                        <th>Descri√ß√£o</th>
                                        <th>NCM</th>
                                        <th>Quant.</th>
                                        <th>% Red.</th>
                                        <th>Aliq. IBS/CBS</th>
                                        <th>Valor Bruto Unit.</th>
                                        <th>Valor Bruto Tot.</th>
                                        <th>ICMS</th>
                                        <th>ICMS ST</th>
                                        <th>IPI</th>
                                        <th>PIS</th>
                                        <th>COFINS</th>
                                        <th>Total Tributos</th>
                                        <th class="reforma">Valor L√≠q. Unit.</th>
                                        <th class="reforma">Valor L√≠q. Tot.</th>
                                        <th class="reforma">IBS/CBS Unit.</th>
                                        <th class="reforma">IBS/CBS Tot.</th>
                                        <th class="reforma">Total Reforma Unit.</th>
                                        <th class="reforma">Total Reforma</th>
                                        <th class="reforma">Dif. Unit.</th>
                                        <th class="reforma">Dif. Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for produto in produtos_entradas %}
                                    <tr>
                                        <td>{{ produto.codigo }}</td>
                                        <td>{{ produto.descricao }}</td>
                                        <td>{{ produto.ncm }}</td>
                                        <td>{{ produto.quantidade_fmt|default:"0,00" }}</td>
                                        <td>{{ produto.perc_reducao_fmt|default:"0,00" }}%</td>
                                        <td>{{ produto.aliq_ibs_cbs_fmt|default:"0,00" }}%</td>
                                        <td>R$ {{ produto.valor_bruto_unit_fmt|default:"0,00" }}</td>
                                        <td>R$ {{ produto.valor_bruto_fmt|default:"0,00" }}</td>
                                        <td>R$ {{ produto.icms_fmt|default:"0,00" }}</td>
                                        <td>R$ {{ produto.icms_st_fmt|default:"0,00" }}</td>
                                        <td>R$ {{ produto.ipi_fmt|default:"0,00" }}</td>
                                        <td>R$ {{ produto.pis_fmt|default:"0,00" }}</td>
                                        <td>R$ {{ produto.cofins_fmt|default:"0,00" }}</td>
                                        <td>R$ {{ produto.total_tributos_fmt|default:"0,00" }}</td>
                                        <td class="reforma">R$ {{ produto.valor_liq_unit_fmt|default:"0,00" }}</td>
                                        <td class="reforma">R$ {{ produto.valor_liq_fmt|default:"0,00" }}</td>
                                        <td class="reforma">R$ {{ produto.ibs_cbs_unit_fmt|default:"0,00" }}</td>
                                        <td class="reforma">R$ {{ produto.ibs_cbs_fmt|default:"0,00" }}</td>
                                        <td class="reforma">R$ {{ produto.total_reforma_unit_fmt|default:"0,00" }}</td>
                                        <td class="reforma">R$ {{ produto.total_reforma_fmt|default:"0,00" }}</td>
                                        <td class="reforma">R$ {{ produto.dif_unit_fmt|default:"0,00" }}</td>
                                        <td class="reforma">R$ {{ produto.dif_total_fmt|default:"0,00" }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="6"><strong>TOTAL</strong></td>
                                        <td>R$ {{ total_valor_bruto_unit_entradas|floatformat:2 }}</td>
                                        <td>R$ {{ total_valor_entradas|floatformat:2 }}</td>
                                        <td>R$ {{ total_icms_entradas|floatformat:2 }}</td>
                                        <td>R$ {{ total_icms_st_entradas|floatformat:2 }}</td>
                                        <td>R$ {{ total_ipi_entradas|floatformat:2 }}</td>
                                        <td>R$ {{ total_pis_entradas|floatformat:2 }}</td>
                                        <td>R$ {{ total_cofins_entradas|floatformat:2 }}</td>
                                        <td>R$ {{ total_tributos_entradas|floatformat:2 }}</td>
                                        <td class="reforma">R$ {{ total_valor_liq_unit_entradas|floatformat:2 }}</td>
                                        <td class="reforma">R$ {{ total_valor_liquido_entradas|floatformat:2 }}</td>
                                        <td class="reforma">R$ {{ total_ibs_cbs_unit_entradas|floatformat:2 }}</td>
                                        <td class="reforma">R$ {{ total_ibs_cbs_entradas|floatformat:2 }}</td>
                                        <td class="reforma">R$ {{ total_reforma_unit_entradas|floatformat:2 }}</td>
                                        <td class="reforma">R$ {{ total_reforma_entradas|floatformat:2 }}</td>
                                        <td class="reforma">R$ {{ total_dif_unit_entradas|floatformat:2 }}</td>
                                        <td class="reforma">R$ {{ total_dif_total_entradas|floatformat:2 }}</td>
                                    </tr>
                                </tfoot>
                            </table>
                            {% else %}
                            <div class="empty-state">
                                <i class="bi bi-inbox-fill empty-state-icon"></i>
                                <div class="empty-state-text">Nenhum produto de entrada encontrado</div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Fornecedores -->
                    <div class="table-container full-width">
                        <div class="table-header-container">
                            <h2>üè≠ Fornecedores Detalhados</h2>
                            <a href="#" class="btn-export">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                Exportar Excel
                            </a>
                        </div>
                        <div class="table-scroll">
                            {% if fornecedores_entradas %}
                            <table class="table-relatorio">
                                <thead>
                                    <tr>
                                        <th>C√≥digo</th>
                                        <th>CNPJ/CPF</th>
                                        <th>Nome</th>
                                        <th>Regime</th>
                                        <th>Valor Bruto</th>
                                        <th>ICMS</th>
                                        <th>ICMS ST</th>
                                        <th>IPI</th>
                                        <th>ISS</th>
                                        <th>PIS</th>
                                        <th>COFINS</th>
                                        <th>Tributos</th>
                                        <th class="reforma">L√≠quido</th>
                                        <th class="reforma">IBS/CBS Efetivo</th>
                                        <th class="reforma">Total Reforma</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for fornecedor in fornecedores_entradas %}
                                    <tr>
                                        <td>{{ fornecedor.codigo }}</td>
                                        <td>{{ fornecedor.cnpj_cpf }}</td>
                                        <td>{{ fornecedor.nome }}</td>
                                        <td>{{ fornecedor.regime|default:" - " }}</td>
                                        <td>R$ {{ fornecedor.valor_bruto|floatformat:2 }}</td>
                                        <td>R$ {{ fornecedor.icms|floatformat:2 }}</td>
                                        <td>R$ {{ fornecedor.icms_st|floatformat:2 }}</td>
                                        <td>R$ {{ fornecedor.ipi|floatformat:2 }}</td>
                                        <td>R$ {{ fornecedor.iss|floatformat:2 }}</td>
                                        <td>R$ {{ fornecedor.pis|floatformat:2 }}</td>
                                        <td>R$ {{ fornecedor.cofins|floatformat:2 }}</td>
                                        <td>R$ {{ fornecedor.tributos|floatformat:2 }}</td>
                                        <td class="reforma">R$ {{ fornecedor.liquido|floatformat:2 }}</td>
                                        <td class="reforma">R$ {{ fornecedor.ibs_cbs_efetivo|floatformat:2 }}</td>
                                        <td class="reforma">R$ {{ fornecedor.total_reforma|floatformat:2 }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="3">TOTAL</td>
                                        <td></td>
                                        <td>R$ {{ total_fornecedores_valor_bruto|floatformat:2 }}</td>
                                        <td>R$ {{ total_fornecedores_icms|floatformat:2 }}</td>
                                        <td>R$ {{ total_fornecedores_icms_st|floatformat:2 }}</td>
                                        <td>R$ {{ total_fornecedores_ipi|floatformat:2 }}</td>
                                        <td>R$ {{ total_fornecedores_iss|floatformat:2 }}</td>
                                        <td>R$ {{ total_fornecedores_pis|floatformat:2 }}</td>
                                        <td>R$ {{ total_fornecedores_cofins|floatformat:2 }}</td>
                                        <td>R$ {{ total_fornecedores_tributos|floatformat:2 }}</td>
                                        <td>R$ {{ total_fornecedores_liquido|floatformat:2 }}</td>
                                        <td>R$ {{ total_fornecedores_ibs_cbs|floatformat:2 }}</td>
                                        <td>R$ {{ total_fornecedores_reforma|floatformat:2 }}</td>
                                    </tr>
                                </tfoot>
                            </table>
                            {% else %}
                            <div class="empty-state">
                                <i class="bi bi-inbox-fill empty-state-icon"></i>
                                <div class="empty-state-text">Nenhum fornecedor encontrado</div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- CFOPs -->
                    <div class="table-container">
                        <div class="table-header-container">
                            <h2>üìã CFOPs de Entrada</h2>
                            <a href="#" class="btn-export">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                Exportar Excel
                            </a>
                        </div>
                        <div class="table-scroll">
                            {% if cfops_entradas %}
                            <table class="table-relatorio">
                                <thead>
                                    <tr>
                                        <th>CFOP</th>
                                        <th>Valor Bruto</th>
                                        <th>ICMS</th>
                                        <th>ICMS ST</th>
                                        <th>IPI</th>
                                        <th>PIS</th>
                                        <th>COFINS</th>
                                        <th>Tributos</th>
                                        <th>L√≠quido</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for cfop in cfops_entradas %}
                                    <tr>
                                        <td><strong>{{ cfop.cfop }}</strong></td>
                                        <td>R$ {{ cfop.valor_bruto|floatformat:2 }}</td>
                                        <td>R$ {{ cfop.icms|floatformat:2 }}</td>
                                        <td>R$ {{ cfop.icms_st|floatformat:2 }}</td>
                                        <td>R$ {{ cfop.ipi|floatformat:2 }}</td>
                                        <td>R$ {{ cfop.pis|floatformat:2 }}</td>
                                        <td>R$ {{ cfop.cofins|floatformat:2 }}</td>
                                        <td>R$ {{ cfop.tributos|floatformat:2 }}</td>
                                        <td>R$ {{ cfop.liquido|floatformat:2 }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td>TOTAL</td>
                                        <td>R$ {{ total_cfops_valor_bruto|floatformat:2 }}</td>
                                        <td>R$ {{ total_cfops_icms|floatformat:2 }}</td>
                                        <td>R$ {{ total_cfops_icms_st|floatformat:2 }}</td>
                                        <td>R$ {{ total_cfops_ipi|floatformat:2 }}</td>
                                        <td>R$ {{ total_cfops_pis|floatformat:2 }}</td>
                                        <td>R$ {{ total_cfops_cofins|floatformat:2 }}</td>
                                        <td>R$ {{ total_cfops_tributos|floatformat:2 }}</td>
                                        <td>R$ {{ total_cfops_liquido|floatformat:2 }}</td>
                                    </tr>
                                </tfoot>
                            </table>
                            {% else %}
                            <div class="empty-state">
                                <i class="bi bi-inbox-fill empty-state-icon"></i>
                                <div class="empty-state-text">Nenhum CFOP encontrado</div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- UF -->
                    <div class="table-container">
                        <div class="table-header-container">
                            <h2>üó∫Ô∏è Distribui√ß√£o por UF - Entradas</h2>
                            <a href="#" class="btn-export">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                Exportar Excel
                            </a>
                        </div>
                        <div class="table-scroll">
                            {% if ufs_entradas %}
                            <table class="table-relatorio">
                                <thead>
                                    <tr>
                                        <th>UF</th>
                                        <th>Valor Bruto</th>
                                        <th>ICMS</th>
                                        <th>ICMS ST</th>
                                        <th>IPI</th>
                                        <th>ISS</th>
                                        <th>PIS</th>
                                        <th>COFINS</th>
                                        <th>Tributos</th>
                                        <th>L√≠quido</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for uf in ufs_entradas %}
                                    <tr>
                                        <td><strong>{{ uf.uf }}</strong></td>
                                        <td>R$ {{ uf.valor_bruto|floatformat:2 }}</td>
                                        <td>R$ {{ uf.icms|floatformat:2 }}</td>
                                        <td>R$ {{ uf.icms_st|floatformat:2 }}</td>
                                        <td>R$ {{ uf.ipi|floatformat:2 }}</td>
                                        <td>R$ {{ uf.iss|floatformat:2 }}</td>
                                        <td>R$ {{ uf.pis|floatformat:2 }}</td>
                                        <td>R$ {{ uf.cofins|floatformat:2 }}</td>
                                        <td>R$ {{ uf.tributos|floatformat:2 }}</td>
                                        <td>R$ {{ uf.liquido|floatformat:2 }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td>TOTAL</td>
                                        <td>R$ {{ total_ufs_valor_bruto|floatformat:2 }}</td>
                                        <td>R$ {{ total_ufs_icms|floatformat:2 }}</td>
                                        <td>R$ {{ total_ufs_icms_st|floatformat:2 }}</td>
                                        <td>R$ {{ total_ufs_ipi|floatformat:2 }}</td>
                                        <td>R$ {{ total_ufs_iss|floatformat:2 }}</td>
                                        <td>R$ {{ total_ufs_pis|floatformat:2 }}</td>
                                        <td>R$ {{ total_ufs_cofins|floatformat:2 }}</td>
                                        <td>R$ {{ total_ufs_tributos|floatformat:2 }}</td>
                                        <td>R$ {{ total_ufs_liquido|floatformat:2 }}</td>
                                    </tr>
                                </tfoot>
                            </table>
                            {% else %}
                            <div class="empty-state">
                                <i class="bi bi-inbox-fill empty-state-icon"></i>
                                <div class="empty-state-text">Nenhuma UF encontrada</div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- APURA√á√ÉO ICMS -->
                    <div class="table-container full-width">
                        <div class="table-header-container">
                            <h2>Ajustes Apura√ß√£o ICMS</h2>
                        </div>
                        <div class="table-scroll">
                            {% if ajustes_icms %}
                            <table class="table-relatorio">
                                <thead>
                                    <tr>
                                        <th>C√≥digo de Ajuste</th>
                                        <th>Tipo de Ajuste</th>
                                        <th>Valor do Ajuste</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for ajuste in ajustes_icms %}
                                    <tr>
                                        <td>{{ ajuste.codigo }}</td>
                                        <td>{{ ajuste.descricao }}</td>
                                        <td>R$ {{ ajuste.valor|floatformat:2 }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="2">TOTAL</td>
                                        <td>R$ {{ total_ajustes_icms|floatformat:2 }}</td>
                                    </tr>
                                </tfoot>
                            </table>
                            {% else %}
                            <div class="empty-state">
                                <i class="bi bi-inbox-fill empty-state-icon"></i>
                                <div class="empty-state-text">Nenhum ajuste encontrado</div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Ajustes Manuais ICMS -->
                    <div class="table-container full-width">
                        <div class="table-header-container">
                            <h2>üìù Ajustes Manuais - Apura√ß√£o ICMS</h2>
                            <div style="display: flex; gap: 10px;">
                                <button type="button" class="btn-export" id="btnImportarAjusteManualICMS" {% if not request.GET.empresa %}disabled style="opacity: 0.5; cursor: not-allowed;"{% endif %}>
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                                    </svg>
                                    Importar Planilha
                                </button>
                                <button type="button" class="btn-export" id="btnExcluirTodosAjustesICMS" style="background: linear-gradient(135deg, rgb(239, 68, 68) 0%, rgb(220, 38, 38) 100%);" {% if not request.GET.empresa %}disabled style="opacity: 0.5; cursor: not-allowed;"{% endif %}>
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                    Excluir Todos
                                </button>
                            </div>
                        </div>
                        <div class="table-scroll">
                            {% if ajustes_manuais_icms %}
                            <table class="table-relatorio">
                                <thead>
                                    <tr>
                                        <th>C√≥digo de Ajuste</th>
                                        <th>Tipo de Ajuste</th>
                                        <th>Valor do Ajuste</th>
                                        <th>A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for ajuste in ajustes_manuais_icms %}
                                    <tr>
                                        <td>{{ ajuste.codigo }}</td>
                                        <td>{{ ajuste.descricao }}</td>
                                        <td>R$ {{ ajuste.valor|floatformat:2 }}</td>
                                        <td>
                                            <button class="btn btn-sm btn-danger" onclick="excluirAjusteManualICMS({{ ajuste.id }})">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="2">TOTAL</td>
                                        <td>R$ {{ total_ajustes_manuais_icms|floatformat:2 }}</td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                            {% else %}
                            <div class="empty-state">
                                <i class="bi bi-inbox-fill empty-state-icon"></i>
                                <div class="empty-state-text">Nenhum ajuste manual encontrado</div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Lan√ßamentos Manuais -->
                    <div class="table-container full-width">
                        <div class="table-header-container">
                            <h2>üìù Lan√ßamentos Manuais - Cr√©ditos IBS/CBS</h2>
                            <div style="display: flex; gap: 10px;">
                                <button type="button" class="btn-export" id="btnImportarPlanilha" {% if not request.GET.empresa %}disabled style="opacity: 0.5; cursor: not-allowed;"{% endif %}>
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                                    </svg>
                                    Importar Planilha
                                </button>
                            </div>
                        </div>
                        <div class="table-scroll">
                            {% if lancamentos_entradas %}
                            <table class="table-relatorio">
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Descri√ß√£o</th>
                                        <th>Valor IBS</th>
                                        <th>Valor CBS</th>
                                        <th>Total</th>
                                        <th>A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for lanc in lancamentos_entradas %}
                                    <tr>
                                        <td>{{ lanc.data|date:"d/m/Y" }}</td>
                                        <td>{{ lanc.descricao }}</td>
                                        <td>R$ {{ lanc.valor_ibs|floatformat:2 }}</td>
                                        <td>R$ {{ lanc.valor_cbs|floatformat:2 }}</td>
                                        <td>R$ {{ lanc.total|floatformat:2 }}</td>
                                        <td>
                                            <button class="btn btn-sm btn-danger" onclick="excluirLancamento({{ lanc.id }})">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                            {% else %}
                            <div class="empty-state">
                                <i class="bi bi-inbox-fill empty-state-icon"></i>
                                <div class="empty-state-text">Nenhum ajuste encontrado</div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tab: Sa√≠das -->
            <div id="saidas" class="tab-content">
                <div class="section-title">üìä Sistema Tribut√°rio Atual - Sa√≠das</div>
                <div class="metrics-section">
                    <div class="metric-card">
                        <h3>Venda Bruta</h3>
                        <div class="value">R$ {{ venda_bruta|default:"0"|floatformat:2 }}</div>
                    </div>
                    
                    <div class="metric-card">
                        <h3>D√©bitos</h3>
                        <div class="value">R$ {{ debitos_saidas|default:"0"|floatformat:2 }}</div>
                    </div>
                    
                    <div class="metric-card">
                        <h3>Venda L√≠quida</h3>
                        <div class="value">R$ {{ venda_liquida|default:"0"|floatformat:2 }}</div>
                    </div>
                    
                    <div class="metric-card">
                        <h3>Carga Tribut√°ria</h3>
                        <div class="value">{{ carga_saidas|default:"0,00" }}%</div>
                    </div>
                </div>

                <div class="section-title">üîÑ Proje√ß√£o com Reforma - Sa√≠das</div>
                <div class="metrics-section">
                    <div class="metric-card reforma">
                        <h3>Venda L√≠quida</h3>
                        <div class="value">R$ {{ venda_liquida_reforma|default:"0"|floatformat:2 }}</div>
                    </div>
                    
                    <div class="metric-card reforma">
                        <h3>D√©bitos IBS/CBS</h3>
                        <div class="value">R$ {{ debitos_ibs_cbs|default:"0"|floatformat:2 }}</div>
                    </div>
                    
                    <div class="metric-card reforma">
                        <h3>Venda Total</h3>
                        <div class="value">R$ {{ venda_total_reforma|default:"0"|floatformat:2 }}</div>
                    </div>
                    
                    <div class="metric-card reforma">
                        <h3>Carga Tribut√°ria</h3>
                        <div class="value">{{ carga_saidas_reforma|default:"0,00" }}%</div>
                    </div>
                </div>
                
                <div class="tables-section">
<!-- Produtos Vendidos -->
                    <div class="table-container full-width">
                        <div class="table-header-container">
                            <h2>üì¶ Produtos Vendidos {% if produtos_fonte_api %}<span class="badge bg-info ms-2" style="font-size: 0.6em; vertical-align: middle;">Dados da API</span>{% endif %}</h2>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn-buscar-api" onclick="iniciarBuscaProdutosAPI()" id="btnBuscarAPI">
                                    <i class="bi bi-cloud-download me-1"></i>
                                    {% if produtos_fonte_api %}Atualizar via API{% else %}Buscar via API{% endif %}
                                </button>
                                <button type="button" class="btn btn-warning" onclick="buscarProdutosFaltantes()" id="btnBuscarFaltantesHeader" style="display:none;">
                                    <i class="bi bi-arrow-repeat me-1"></i>
                                    Buscar Faltantes
                                </button>
                                <button type="button" class="btn-retomar-api" onclick="abrirModalRetomar()" id="btnRetomarHeader">
                                    <i class="bi bi-play-circle me-1"></i>
                                    Retomar Buscas
                                </button>
                                <button type="button" class="btn-ver-pendencias" onclick="abrirModalPendencias()" id="btnVerPendencias">
                                    <i class="bi bi-exclamation-triangle me-1"></i>
                                    Ver Pend√™ncias
                                </button>
                                <a href="#" class="btn-export">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                    </svg>
                                    Exportar Excel
                                </a>
                            </div>
                        </div>
                        <div class="table-scroll">
                            {% if produtos_saidas %}
                            <table class="table-relatorio">
                                <thead>
                                    <tr>
                                        <th>Chave NF-e</th>
                                        <th>C√≥digo</th>
                                        <th>Descri√ß√£o</th>
                                        <th>NCM</th>
                                        <th>Quant.</th>
                                        <th>% Red.</th>
                                        <th>Aliq. IBS/CBS</th>
                                        <th>Valor Bruto Unit.</th>
                                        <th>Valor Bruto Tot.</th>
                                        <th>ICMS</th>
                                        <th>ICMS ST</th>
                                        <th>IPI</th>
                                        <th>PIS</th>
                                        <th>COFINS</th>
                                        <th>Total Tributos</th>
                                        <th class="reforma">Valor L√≠q. Unit.</th>
                                        <th class="reforma">Valor L√≠q. Tot.</th>
                                        <th class="reforma">IBS/CBS Unit.</th>
                                        <th class="reforma">IBS/CBS Tot.</th>
                                        <th class="reforma">Total Reforma Unit.</th>
                                        <th class="reforma">Total Reforma</th>
                                        <th class="reforma">Dif. Unit.</th>
                                        <th class="reforma">Dif. Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for produto in produtos_saidas %}
                                    <tr>
                                        <td><small title="{{ produto.chave_nfe|default:'-' }}">{{ produto.chave_nfe|default:'-'|truncatechars:20 }}</small></td>
                                        <td>{{ produto.codigo }}</td>
                                        <td>{{ produto.descricao|truncatechars:35 }}</td>
                                        <td>{{ produto.ncm }}</td>
                                        <td>{{ produto.quantidade_fmt|default:"0,00" }}</td>
                                        <td>{{ produto.perc_reducao_fmt|default:"0,00" }}%</td>
                                        <td>{{ produto.aliq_ibs_cbs_fmt|default:"0,00" }}%</td>
                                        <td>R$ {{ produto.valor_bruto_unit_fmt|default:"0,00" }}</td>
                                        <td>R$ {{ produto.valor_bruto_fmt|default:"0,00" }}</td>
                                        <td>R$ {{ produto.icms_fmt|default:"0,00" }}</td>
                                        <td>R$ {{ produto.icms_st_fmt|default:"0,00" }}</td>
                                        <td>R$ {{ produto.ipi_fmt|default:"0,00" }}</td>
                                        <td>R$ {{ produto.pis_fmt|default:"0,00" }}</td>
                                        <td>R$ {{ produto.cofins_fmt|default:"0,00" }}</td>
                                        <td>R$ {{ produto.total_tributos_fmt|default:"0,00" }}</td>
                                        <td class="reforma">R$ {{ produto.valor_liq_unit_fmt|default:"0,00" }}</td>
                                        <td class="reforma">R$ {{ produto.valor_liq_fmt|default:"0,00" }}</td>
                                        <td class="reforma">R$ {{ produto.ibs_cbs_unit_fmt|default:"0,00" }}</td>
                                        <td class="reforma">R$ {{ produto.ibs_cbs_fmt|default:"0,00" }}</td>
                                        <td class="reforma">R$ {{ produto.total_reforma_unit_fmt|default:"0,00" }}</td>
                                        <td class="reforma">R$ {{ produto.total_reforma_fmt|default:"0,00" }}</td>
                                        <td class="reforma">R$ {{ produto.dif_unit_fmt|default:"0,00" }}</td>
                                        <td class="reforma">R$ {{ produto.dif_total_fmt|default:"0,00" }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="8"><strong>TOTAL</strong></td>
                                        <td>R$ {{ total_valor_saidas|floatformat:2 }}</td>
                                        <td>R$ {{ total_icms_saidas|floatformat:2 }}</td>
                                        <td>-</td>
                                        <td>-</td>
                                        <td>R$ {{ total_pis_saidas|floatformat:2 }}</td>
                                        <td>R$ {{ total_cofins_saidas|floatformat:2 }}</td>
                                        <td>-</td>
                                        <td>-</td>
                                        <td>-</td>
                                        <td>-</td>
                                        <td class="reforma">R$ {{ total_ibs_cbs_saidas|floatformat:2 }}</td>
                                        <td class="reforma">-</td>
                                        <td class="reforma">-</td>
                                        <td class="reforma">-</td>
                                        <td class="reforma">-</td>
                                    </tr>
                                </tfoot>
                            </table>
                            {% else %}
                            <div class="empty-state" id="emptyStateSaidas">
                                <i class="bi bi-inbox-fill empty-state-icon"></i>
                                <div class="empty-state-text">Nenhum produto de sa√≠da encontrado</div>
                                <button type="button" class="btn btn-primary mt-3" onclick="iniciarBuscaProdutosAPI()">
                                    <i class="bi bi-cloud-download me-1"></i>
                                    Buscar Produtos via API
                                </button>
                                <button type="button" class="btn btn-warning mt-3 ms-2" onclick="buscarProdutosFaltantes()" id="btnBuscarFaltantes" style="display:none;">
                                    <i class="bi bi-arrow-repeat me-1"></i>
                                    Buscar Produtos que Faltam
                                </button>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Clientes Detalhados -->
                    <div class="table-container full-width">
                        <div class="table-header-container">
                            <h2>üè≠ Clientes Detalhados</h2>
                            <a href="#" class="btn-export">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                Exportar Excel
                            </a>
                        </div>
                        <div class="table-scroll">
                            {% if clientes %}
                            <table class="table-relatorio">
                                <thead>
                                    <tr>
                                        <th>CNPJ/CPF</th>
                                        <th>Nome</th>
                                        <th>UF</th>
                                        <th>Valor Total</th>
                                        <th>ICMS</th>
                                        <th class="reforma">IBS/CBS</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for cliente in clientes %}
                                    <tr>
                                        <td>{{ cliente.cnpj_cpf }}</td>
                                        <td>{{ cliente.nome|truncatechars:40 }}</td>
                                        <td>{{ cliente.uf }}</td>
                                        <td>R$ {{ cliente.valor_total|floatformat:2 }}</td>
                                        <td>R$ {{ cliente.icms|floatformat:2 }}</td>
                                        <td class="reforma">R$ {{ cliente.ibs_cbs|floatformat:2 }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                            {% else %}
                            <div class="empty-state">
                                <i class="bi bi-inbox-fill empty-state-icon"></i>
                                <div class="empty-state-text">Nenhum cliente encontrado</div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- CFOPs de Sa√≠da -->
                    <div class="table-container">
                        <div class="table-header-container">
                            <h2>üìã CFOPs de Sa√≠da</h2>
                            <a href="#" class="btn-export">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                Exportar Excel
                            </a>
                        </div>
                        <div class="table-scroll">
                            {% if cfops_saidas %}
                            <table class="table-relatorio">
                                <thead>
                                    <tr>
                                        <th>CFOP</th>
                                        <th>Descri√ß√£o</th>
                                        <th>Valor</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for cfop in cfops_saidas %}
                                    <tr>
                                        <td>{{ cfop.codigo }}</td>
                                        <td>{{ cfop.descricao }}</td>
                                        <td>R$ {{ cfop.valor|floatformat:2 }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                            {% else %}
                            <div class="empty-state">
                                <i class="bi bi-inbox-fill empty-state-icon"></i>
                                <div class="empty-state-text">Nenhum CFOP de sa√≠da encontrado</div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Distribui√ß√£o por UF -->
                    <div class="table-container">
                        <div class="table-header-container">
                            <h2>üó∫Ô∏è Distribui√ß√£o por UF - Sa√≠das</h2>
                            <a href="#" class="btn-export">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                Exportar Excel
                            </a>
                        </div>
                        <div class="table-scroll">
                            {% if ufs_saidas %}
                            <table class="table-relatorio">
                                <thead>
                                    <tr>
                                        <th>UF</th>
                                        <th>Quantidade</th>
                                        <th>Valor Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for uf in ufs_saidas %}
                                    <tr>
                                        <td>{{ uf.sigla }}</td>
                                        <td>{{ uf.quantidade }}</td>
                                        <td>R$ {{ uf.valor|floatformat:2 }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                            {% else %}
                            <div class="empty-state">
                                <i class="bi bi-inbox-fill empty-state-icon"></i>
                                <div class="empty-state-text">Nenhuma UF encontrada</div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Ajustes Apura√ß√£o ICMS -->
                    <div class="table-container full-width">
                        <div class="table-header-container">
                            <h2>Ajustes Apura√ß√£o ICMS</h2>
                        </div>
                        <div class="table-scroll">
                            {% if ajustes_icms %}
                            <table class="table-relatorio">
                                <thead>
                                    <tr>
                                        <th>C√≥digo</th>
                                        <th>Descri√ß√£o</th>
                                        <th>Valor</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for ajuste in ajustes_icms %}
                                    <tr>
                                        <td>{{ ajuste.codigo }}</td>
                                        <td>{{ ajuste.descricao }}</td>
                                        <td>R$ {{ ajuste.valor|floatformat:2 }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                            {% else %}
                            <div class="empty-state">
                                <i class="bi bi-inbox-fill empty-state-icon"></i>
                                <div class="empty-state-text">Nenhum ajuste encontrado</div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Lan√ßamentos Manuais Sa√≠das -->
                    <div class="table-container full-width">
                        <div class="table-header-container">
                            <h2>üìù Lan√ßamentos Manuais - D√©bitos IBS/CBS</h2>
                            <div style="display: flex; gap: 10px;">
                                <button type="button" class="btn-export" id="btnImportarPlanilhaSaidas" {% if not request.GET.empresa %}disabled style="opacity: 0.5; cursor: not-allowed;"{% endif %}>
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                                    </svg>
                                    Importar Planilha
                                </button>
                            </div>
                        </div>
                        <div class="table-scroll">
                            {% if lancamentos_saidas %}
                            <table class="table-relatorio">
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Descri√ß√£o</th>
                                        <th>Valor IBS</th>
                                        <th>Valor CBS</th>
                                        <th>Total</th>
                                        <th>A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for lanc in lancamentos_saidas %}
                                    <tr>
                                        <td>{{ lanc.data|date:"d/m/Y" }}</td>
                                        <td>{{ lanc.descricao }}</td>
                                        <td>R$ {{ lanc.valor_ibs|floatformat:2 }}</td>
                                        <td>R$ {{ lanc.valor_cbs|floatformat:2 }}</td>
                                        <td>R$ {{ lanc.total|floatformat:2 }}</td>
                                        <td>
                                            <button class="btn btn-sm btn-danger" onclick="excluirLancamento({{ lanc.id }})">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                            {% else %}
                            <div class="empty-state">
                                <i class="bi bi-inbox-fill empty-state-icon"></i>
                                <div class="empty-state-text">Nenhum ajuste encontrado</div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tab: Transi√ß√£o -->
            <div id="transicao" class="tab-content">
                <div class="section-title">üì• Progress√£o da Reforma - Compras (Entradas)</div>
                <div class="table-container">
                    <h2>üõí Simula√ß√£o de Tributos nas Compras (2026-2033)</h2>
                    <div class="table-scroll-trans">
                        <table class="transicao-table">
                            <thead>
                                <tr>
                                    <th>Tributo</th>
                                    <th>2026</th>
                                    <th>2027</th>
                                    <th>2028</th>
                                    <th>2029</th>
                                    <th>2030</th>
                                    <th>2031</th>
                                    <th>2032</th>
                                    <th>2033</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="row-destaque">
                                    <td><strong>Compra Bruta</strong></td>
                                    <td>R$ {{ transicao_compras.compra_bruta_2026|default:"0"|floatformat:2 }}</td>
                                    <td>R$ {{ transicao_compras.compra_bruta_2027|default:"0"|floatformat:2 }}</td>
                                    <td>R$ {{ transicao_compras.compra_bruta_2028|default:"0"|floatformat:2 }}</td>
                                    <td>R$ {{ transicao_compras.compra_bruta_2029|default:"0"|floatformat:2 }}</td>
                                    <td>R$ {{ transicao_compras.compra_bruta_2030|default:"0"|floatformat:2 }}</td>
                                    <td>R$ {{ transicao_compras.compra_bruta_2031|default:"0"|floatformat:2 }}</td>
                                    <td>R$ {{ transicao_compras.compra_bruta_2032|default:"0"|floatformat:2 }}</td>
                                    <td>R$ {{ transicao_compras.compra_bruta_2033|default:"0"|floatformat:2 }}</td>
                                </tr>
                                <tr>
                                    <td><strong>PIS</strong></td>
                                    <td>R$ {{ transicao_compras.pis_2026|default:"0"|floatformat:2 }}</td>
                                    <td style="letter-spacing: 0.5px;">EXTINTO</td>
                                    <td style="letter-spacing: 0.5px;">EXTINTO</td>
                                    <td style="letter-spacing: 0.5px;">EXTINTO</td>
                                    <td style="letter-spacing: 0.5px;">EXTINTO</td>
                                    <td style="letter-spacing: 0.5px;">EXTINTO</td>
                                    <td style="letter-spacing: 0.5px;">EXTINTO</td>
                                    <td style="letter-spacing: 0.5px;">EXTINTO</td>
                                </tr>
                                <tr>
                                    <td><strong>COFINS</strong></td>
                                    <td>R$ {{ transicao_compras.cofins_2026|default:"0"|floatformat:2 }}</td>
                                    <td style="letter-spacing: 0.5px;">EXTINTO</td>
                                    <td style="letter-spacing: 0.5px;">EXTINTO</td>
                                    <td style="letter-spacing: 0.5px;">EXTINTO</td>
                                    <td style="letter-spacing: 0.5px;">EXTINTO</td>
                                    <td style="letter-spacing: 0.5px;">EXTINTO</td>
                                    <td style="letter-spacing: 0.5px;">EXTINTO</td>
                                    <td style="letter-spacing: 0.5px;">EXTINTO</td>
                                </tr>
                                <tr>
                                    <td><strong>ICMS</strong></td>
                                    <td>R$ {{ transicao_compras.icms_2026|default:"0"|floatformat:2 }}</td>
                                    <td>R$ {{ transicao_compras.icms_2027|default:"0"|floatformat:2 }}</td>
                                    <td>R$ {{ transicao_compras.icms_2028|default:"0"|floatformat:2 }}</td>
                                    <td>R$ {{ transicao_compras.icms_2029|default:"0"|floatformat:2 }}</td>
                                    <td>R$ {{ transicao_compras.icms_2030|default:"0"|floatformat:2 }}</td>
                                    <td>R$ {{ transicao_compras.icms_2031|default:"0"|floatformat:2 }}</td>
                                    <td>R$ {{ transicao_compras.icms_2032|default:"0"|floatformat:2 }}</td>
                                    <td style="letter-spacing: 0.5px;">EXTINTO</td>
                                </tr>
                                <tr class="row-reforma">
                                    <td><strong>IBS</strong></td>
                                    <td>R$ {{ transicao_compras.ibs_2026|default:"0"|floatformat:2 }}</td>
                                    <td>R$ {{ transicao_compras.ibs_2027|default:"0"|floatformat:2 }}</td>
                                    <td>R$ {{ transicao_compras.ibs_2028|default:"0"|floatformat:2 }}</td>
                                    <td>R$ {{ transicao_compras.ibs_2029|default:"0"|floatformat:2 }}</td>
                                    <td>R$ {{ transicao_compras.ibs_2030|default:"0"|floatformat:2 }}</td>
                                    <td>R$ {{ transicao_compras.ibs_2031|default:"0"|floatformat:2 }}</td>
                                    <td>R$ {{ transicao_compras.ibs_2032|default:"0"|floatformat:2 }}</td>
                                    <td>R$ {{ transicao_compras.ibs_2033|default:"0"|floatformat:2 }}</td>
                                </tr>
                                <tr class="row-reforma">
                                    <td><strong>CBS</strong></td>
                                    <td>R$ {{ transicao_compras.cbs_2026|default:"0"|floatformat:2 }}</td>
                                    <td>R$ {{ transicao_compras.cbs_2027|default:"0"|floatformat:2 }}</td>
                                    <td>R$ {{ transicao_compras.cbs_2028|default:"0"|floatformat:2 }}</td>
                                    <td>R$ {{ transicao_compras.cbs_2029|default:"0"|floatformat:2 }}</td>
                                    <td>R$ {{ transicao_compras.cbs_2030|default:"0"|floatformat:2 }}</td>
                                    <td>R$ {{ transicao_compras.cbs_2031|default:"0"|floatformat:2 }}</td>
                                    <td>R$ {{ transicao_compras.cbs_2032|default:"0"|floatformat:2 }}</td>
                                    <td>R$ {{ transicao_compras.cbs_2033|default:"0"|floatformat:2 }}</td>
                                </tr>
                                <tr class="row-total">
                                    <td style="color:#2c3e50"><strong>TOTAL</strong></td>
                                    <td>R$ {{ transicao_compras.total_2026|default:"0"|floatformat:2 }}</td>
                                    <td>R$ {{ transicao_compras.total_2027|default:"0"|floatformat:2 }}</td>
                                    <td>R$ {{ transicao_compras.total_2028|default:"0"|floatformat:2 }}</td>
                                    <td>R$ {{ transicao_compras.total_2029|default:"0"|floatformat:2 }}</td>
                                    <td>R$ {{ transicao_compras.total_2030|default:"0"|floatformat:2 }}</td>
                                    <td>R$ {{ transicao_compras.total_2031|default:"0"|floatformat:2 }}</td>
                                    <td>R$ {{ transicao_compras.total_2032|default:"0"|floatformat:2 }}</td>
                                    <td>R$ {{ transicao_compras.total_2033|default:"0"|floatformat:2 }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="section-title">üì§ Progress√£o da Reforma - Vendas (Sa√≠das)</div>
                <div class="table-container">
                    <h2>üì¶ Simula√ß√£o de Tributos nas Vendas (2026-2033)</h2>
                    <div class="table-scroll-trans">
                        <table class="transicao-table">
                            <thead>
                                <tr>
                                    <th>Tributo</th>
                                    <th>2026</th>
                                    <th>2027</th>
                                    <th>2028</th>
                                    <th>2029</th>
                                    <th>2030</th>
                                    <th>2031</th>
                                    <th>2032</th>
                                    <th>2033</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="row-destaque">
                                    <td><strong>Venda Bruta</strong></td>
                                    <td>R$ {{ transicao_vendas.venda_bruta_2026|default:"0"|floatformat:2 }}</td>
                                    <td>R$ {{ transicao_vendas.venda_bruta_2027|default:"0"|floatformat:2 }}</td>
                                    <td>R$ {{ transicao_vendas.venda_bruta_2028|default:"0"|floatformat:2 }}</td>
                                    <td>R$ {{ transicao_vendas.venda_bruta_2029|default:"0"|floatformat:2 }}</td>
                                    <td>R$ {{ transicao_vendas.venda_bruta_2030|default:"0"|floatformat:2 }}</td>
                                    <td>R$ {{ transicao_vendas.venda_bruta_2031|default:"0"|floatformat:2 }}</td>
                                    <td>R$ {{ transicao_vendas.venda_bruta_2032|default:"0"|floatformat:2 }}</td>
                                    <td>R$ {{ transicao_vendas.venda_bruta_2033|default:"0"|floatformat:2 }}</td>
                                </tr>
                                <tr>
                                    <td><strong>PIS</strong></td>
                                    <td>R$ {{ transicao_vendas.pis_2026|default:"0"|floatformat:2 }}</td>
                                    <td style="letter-spacing: 0.5px;">EXTINTO</td>
                                    <td style="letter-spacing: 0.5px;">EXTINTO</td>
                                    <td style="letter-spacing: 0.5px;">EXTINTO</td>
                                    <td style="letter-spacing: 0.5px;">EXTINTO</td>
                                    <td style="letter-spacing: 0.5px;">EXTINTO</td>
                                    <td style="letter-spacing: 0.5px;">EXTINTO</td>
                                    <td style="letter-spacing: 0.5px;">EXTINTO</td>
                                </tr>
                                <tr>
                                    <td><strong>COFINS</strong></td>
                                    <td>R$ {{ transicao_vendas.cofins_2026|default:"0"|floatformat:2 }}</td>
                                    <td style="letter-spacing: 0.5px;">EXTINTO</td>
                                    <td style="letter-spacing: 0.5px;">EXTINTO</td>
                                    <td style="letter-spacing: 0.5px;">EXTINTO</td>
                                    <td style="letter-spacing: 0.5px;">EXTINTO</td>
                                    <td style="letter-spacing: 0.5px;">EXTINTO</td>
                                    <td style="letter-spacing: 0.5px;">EXTINTO</td>
                                    <td style="letter-spacing: 0.5px;">EXTINTO</td>
                                </tr>
                                <tr>
                                    <td><strong>ICMS</strong></td>
                                    <td>R$ {{ transicao_vendas.icms_2026|default:"0"|floatformat:2 }}</td>
                                    <td>R$ {{ transicao_vendas.icms_2027|default:"0"|floatformat:2 }}</td>
                                    <td>R$ {{ transicao_vendas.icms_2028|default:"0"|floatformat:2 }}</td>
                                    <td>R$ {{ transicao_vendas.icms_2029|default:"0"|floatformat:2 }}</td>
                                    <td>R$ {{ transicao_vendas.icms_2030|default:"0"|floatformat:2 }}</td>
                                    <td>R$ {{ transicao_vendas.icms_2031|default:"0"|floatformat:2 }}</td>
                                    <td>R$ {{ transicao_vendas.icms_2032|default:"0"|floatformat:2 }}</td>
                                    <td style="letter-spacing: 0.5px;">EXTINTO</td>
                                </tr>
                                <tr class="row-reforma">
                                    <td><strong>IBS</strong></td>
                                    <td>R$ {{ transicao_vendas.ibs_2026|default:"0"|floatformat:2 }}</td>
                                    <td>R$ {{ transicao_vendas.ibs_2027|default:"0"|floatformat:2 }}</td>
                                    <td>R$ {{ transicao_vendas.ibs_2028|default:"0"|floatformat:2 }}</td>
                                    <td>R$ {{ transicao_vendas.ibs_2029|default:"0"|floatformat:2 }}</td>
                                    <td>R$ {{ transicao_vendas.ibs_2030|default:"0"|floatformat:2 }}</td>
                                    <td>R$ {{ transicao_vendas.ibs_2031|default:"0"|floatformat:2 }}</td>
                                    <td>R$ {{ transicao_vendas.ibs_2032|default:"0"|floatformat:2 }}</td>
                                    <td>R$ {{ transicao_vendas.ibs_2033|default:"0"|floatformat:2 }}</td>
                                </tr>
                                <tr class="row-reforma">
                                    <td><strong>CBS</strong></td>
                                    <td>R$ {{ transicao_vendas.cbs_2026|default:"0"|floatformat:2 }}</td>
                                    <td>R$ {{ transicao_vendas.cbs_2027|default:"0"|floatformat:2 }}</td>
                                    <td>R$ {{ transicao_vendas.cbs_2028|default:"0"|floatformat:2 }}</td>
                                    <td>R$ {{ transicao_vendas.cbs_2029|default:"0"|floatformat:2 }}</td>
                                    <td>R$ {{ transicao_vendas.cbs_2030|default:"0"|floatformat:2 }}</td>
                                    <td>R$ {{ transicao_vendas.cbs_2031|default:"0"|floatformat:2 }}</td>
                                    <td>R$ {{ transicao_vendas.cbs_2032|default:"0"|floatformat:2 }}</td>
                                    <td>R$ {{ transicao_vendas.cbs_2033|default:"0"|floatformat:2 }}</td>
                                </tr>
                                <tr class="row-total">
                                    <td style="color:#2c3e50"><strong>TOTAL</strong></td>
                                    <td>R$ {{ transicao_vendas.total_2026|default:"0"|floatformat:2 }}</td>
                                    <td>R$ {{ transicao_vendas.total_2027|default:"0"|floatformat:2 }}</td>
                                    <td>R$ {{ transicao_vendas.total_2028|default:"0"|floatformat:2 }}</td>
                                    <td>R$ {{ transicao_vendas.total_2029|default:"0"|floatformat:2 }}</td>
                                    <td>R$ {{ transicao_vendas.total_2030|default:"0"|floatformat:2 }}</td>
                                    <td>R$ {{ transicao_vendas.total_2031|default:"0"|floatformat:2 }}</td>
                                    <td>R$ {{ transicao_vendas.total_2032|default:"0"|floatformat:2 }}</td>
                                    <td>R$ {{ transicao_vendas.total_2033|default:"0"|floatformat:2 }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Progresso da Busca API -->
<div class="modal-progresso-api" id="modalProgressoAPI">
    <div class="modal-progresso-content">
        <button type="button" class="btn-fechar-modal-x" onclick="fecharModalProgresso()" title="Fechar">
            <i class="bi bi-x"></i>
        </button>
        <div class="progresso-header">
            <h3><i class="bi bi-cloud-download me-2"></i>Buscando Produtos via API</h3>
            <p>Aguarde enquanto buscamos os XMLs e extra√≠mos as classifica√ß√µes tribut√°rias...</p>
        </div>
        
        <div class="progresso-stats">
            <div class="stat-box">
                <div class="stat-number" id="statTotal">0</div>
                <div class="stat-label">Total de Notas</div>
            </div>
            <div class="stat-box success">
                <div class="stat-number" id="statSucesso">0</div>
                <div class="stat-label">‚úÖ Encontradas</div>
            </div>
            <div class="stat-box error">
                <div class="stat-number" id="statErro">0</div>
                <div class="stat-label">‚ùå Erros</div>
            </div>
            <div class="stat-box produtos">
                <div class="stat-number" id="statProdutos">0</div>
                <div class="stat-label">üì¶ Produtos</div>
            </div>
        </div>
        
        <div class="progresso-barra-container">
            <div class="progresso-info">
                <span id="progressoStatus">Iniciando...</span>
                <span id="progressoContador">0/0</span>
            </div>
            <div class="progresso-barra">
                <div class="progresso-barra-fill" id="progressoBarraFill"></div>
            </div>
        </div>
        
        <div class="progresso-nota-atual" id="progressoNotaAtual">
            <strong>Preparando busca...</strong>
        </div>
        
        <div class="progresso-acoes">
            <button class="btn-cancelar-busca" id="btnCancelarBusca" onclick="cancelarBuscaAPI()">
                <i class="bi bi-x-circle me-1"></i> Cancelar
            </button>
            <button class="btn-retomar-busca" id="btnRetomar" onclick="retomarBuscaAPI()" style="display:none; background:#10b981; color:#fff; border:none; padding:10px 20px; border-radius:8px; cursor:pointer;">
                <i class="bi bi-play-circle me-1"></i> ‚ñ∂Ô∏è Retomar Busca
            </button>
            <button class="btn-exportar-erros" id="btnExportarErros" onclick="exportarRelatorioErros()" style="display:none; background:#3b82f6; color:#fff; border:none; padding:10px 20px; border-radius:8px; cursor:pointer;">
                <i class="bi bi-file-earmark-excel me-1"></i> üì• Exportar Erros Excel
            </button>
            <button class="btn-fechar-progresso" id="btnFecharProgresso" onclick="fecharModalProgresso()">
                <i class="bi bi-check-circle me-1"></i> Conclu√≠do
            </button>
        </div>
    </div>
</div>

<!-- Modal de Pend√™ncias (NF com erro e NFC-e n√£o pesquisadas) -->
<div class="modal-pendencias" id="modalPendencias">
    <div class="modal-pendencias-content">
        <div class="modal-pendencias-header">
            <h3><i class="bi bi-exclamation-triangle me-2"></i>Pend√™ncias da Busca</h3>
            <button type="button" class="btn-fechar-modal-x" onclick="fecharModalPendencias()" title="Fechar">
                <i class="bi bi-x"></i>
            </button>
        </div>
        <div id="conteudoPendencias">
            <p class="text-center text-muted">Nenhuma pend√™ncia registrada.</p>
        </div>
        <div class="progresso-acoes" style="margin-top: 20px;">
            <button type="button" onclick="exportarRelatorioErros()" style="background:#3b82f6; color:#fff; border:none; padding:10px 20px; border-radius:8px; cursor:pointer;">
                <i class="bi bi-file-earmark-excel me-1"></i> Exportar Excel
            </button>
            <button type="button" onclick="fecharModalPendencias()" style="background:#6b7280; color:#fff; border:none; padding:10px 20px; border-radius:8px; cursor:pointer;">
                Fechar
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
// Fun√ß√£o para exportar Produtos Entradas para Excel (formato refer√™ncia 26 colunas)
    function exportarProdutosEntradas() {
        const tabEntradas = document.getElementById('entradas');
        if (!tabEntradas) { alert('Aba Entradas n√£o encontrada.'); return; }
        const tables = tabEntradas.querySelectorAll('table.table-relatorio');
        let table = null;
        for (let t of tables) {
            const container = t.closest('.table-container');
            if (container && container.querySelector('h2') && container.querySelector('h2').textContent.includes('Produtos Adquiridos')) {
                table = t;
                break;
            }
        }
        if (!table) { alert('Nenhum dado de produto para exportar.'); return; }

        const parseNum = (text) => {
            if (!text) return 0;
            let clean = text.replace('R$', '').replace('%', '').trim();
            clean = clean.replace(/\./g, '').replace(',', '.');
            return parseFloat(clean) || 0;
        };

        const headers = [
            'C√≥digo', 'Descri√ß√£o', 'NCM',
            'Quantidade', '% Redu√ß√£o', 'Al√≠q. IBS/CBS',
            'Valor Bruto Unit.', 'Valor Bruto',
            'Al√≠q. ICMS', 'ICMS',
            'Al√≠q. IPI', 'IPI',
            'Al√≠q. PIS', 'PIS',
            'Al√≠q. COFINS', 'COFINS',
            'Total Tributos', 'Dif. Al√≠quotas',
            'Valor L√≠quido Unit.', 'Valor L√≠quido',
            'IBS/CBS Unit.', 'IBS/CBS',
            'Dif. Total Unit.', 'Dif. Total',
            'Total Reforma Unit.', 'Total Reforma'
        ];

        const data = [headers];
        const rows = table.querySelectorAll('tbody tr');

        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            if (cells.length < 22) return;

            const codigo = cells[0].textContent.trim();
            const descricao = cells[1].textContent.trim();
            const ncm = cells[2].textContent.trim();
            const quantidade = parseNum(cells[3].textContent);
            const percReducao = parseNum(cells[4].textContent);
            const aliqIbsCbs = parseNum(cells[5].textContent);
            const valorBrutoUnit = parseNum(cells[6].textContent);
            const valorBrutoTot = parseNum(cells[7].textContent);
            const icms = parseNum(cells[8].textContent);
            // cells[9] = ICMS ST (n√£o vai para o Excel)
            const ipi = parseNum(cells[10].textContent);
            const pis = parseNum(cells[11].textContent);
            const cofins = parseNum(cells[12].textContent);
            const totalTributos = parseNum(cells[13].textContent);
            const valorLiqUnit = parseNum(cells[14].textContent);
            const valorLiqTot = parseNum(cells[15].textContent);
            const ibsCbsUnit = parseNum(cells[16].textContent);
            const ibsCbsTot = parseNum(cells[17].textContent);
            const totalReformaUnit = parseNum(cells[18].textContent);
            const totalReformaTot = parseNum(cells[19].textContent);
            const difUnit = parseNum(cells[20].textContent);
            const difTotal = parseNum(cells[21].textContent);

            // Calcular al√≠quotas efetivas
            const aliqIcms = valorBrutoTot > 0 ? Math.round(icms / valorBrutoTot * 10000) / 100 : 0;
            const aliqIpi = valorBrutoTot > 0 ? Math.round(ipi / valorBrutoTot * 10000) / 100 : 0;
            const aliqPis = valorBrutoTot > 0 ? Math.round(pis / valorBrutoTot * 10000) / 100 : 0;
            const aliqCofins = valorBrutoTot > 0 ? Math.round(cofins / valorBrutoTot * 10000) / 100 : 0;
            const difAliquotas = Math.round((aliqIbsCbs - (aliqIcms + aliqIpi + aliqPis + aliqCofins)) * 100) / 100;

            data.push([
                codigo, descricao, ncm,
                quantidade, percReducao, aliqIbsCbs,
                valorBrutoUnit, valorBrutoTot,
                aliqIcms, icms,
                aliqIpi, ipi,
                aliqPis, pis,
                aliqCofins, cofins,
                totalTributos, difAliquotas,
                valorLiqUnit, valorLiqTot,
                ibsCbsUnit, ibsCbsTot,
                totalReformaUnit, totalReformaTot,
                difUnit, difTotal
            ]);
        });

        if (data.length <= 1) { alert('Nenhum produto encontrado para exportar.'); return; }

        const ws = XLSX.utils.aoa_to_sheet(data);

        // Ajustar largura das colunas
        ws['!cols'] = [
            {wch:12}, {wch:40}, {wch:12},
            {wch:12}, {wch:10}, {wch:12},
            {wch:16}, {wch:16},
            {wch:10}, {wch:14},
            {wch:10}, {wch:14},
            {wch:10}, {wch:14},
            {wch:10}, {wch:14},
            {wch:14}, {wch:14},
            {wch:16}, {wch:16},
            {wch:14}, {wch:14},
            {wch:16}, {wch:16},
            {wch:16}, {wch:16}
        ];

        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Produtos Entradas');

        // Nome do arquivo com per√≠odo
        const selPeriodoIni = document.querySelector('[name="periodo_inicial"]');
        const selPeriodoFim = document.querySelector('[name="periodo_final"]');
        let nomeArquivo = 'produtos_entradas';
        if (selPeriodoIni && selPeriodoIni.value && selPeriodoFim && selPeriodoFim.value) {
            nomeArquivo += '_' + selPeriodoIni.value + '_a_' + selPeriodoFim.value;
        }
        nomeArquivo += '.xlsx';

        XLSX.writeFile(wb, nomeArquivo);
    }

    // ========================================
    // AJUSTES MANUAIS ICMS - Importar/Excluir
    // ========================================
    const btnImportarAjusteICMS = document.getElementById('btnImportarAjusteManualICMS');
    if (btnImportarAjusteICMS) {
        btnImportarAjusteICMS.addEventListener('click', function() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx,.xls,.csv';
            input.onchange = async function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = async function(evt) {
                    try {
                        const data = new Uint8Array(evt.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const sheet = workbook.Sheets[workbook.SheetNames[0]];
                        const rows = XLSX.utils.sheet_to_json(sheet, {header: 1});
                        
                        if (rows.length < 2) {
                            alert('Planilha vazia ou sem dados.');
                            return;
                        }
                        
                        const ajustes = [];
                        for (let i = 1; i < rows.length; i++) {
                            const row = rows[i];
                            if (!row[0] && !row[1] && !row[2]) continue;
                            ajustes.push({
                                codigo: String(row[0] || '').trim(),
                                descricao: String(row[1] || '').trim(),
                                valor: parseFloat(String(row[2] || '0').replace(',', '.')) || 0
                            });
                        }
                        
                        if (ajustes.length === 0) {
                            alert('Nenhum ajuste encontrado na planilha.');
                            return;
                        }
                        
                        const empresaId = document.querySelector('[name="empresa"]').value;
                        const periodoIni = document.querySelector('[name="periodo_inicial"]').value;
                        const periodoFim = document.querySelector('[name="periodo_final"]').value;
                        
                        const response = await fetch('/dashboards/api/importar-ajustes-manuais-icms/', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                empresa_id: empresaId,
                                periodo_inicial: periodoIni,
                                periodo_final: periodoFim,
                                ajustes: ajustes
                            })
                        });
                        const result = await response.json();
                        
                        if (result.success) {
                            alert(result.message);
                            location.reload();
                        } else {
                            alert('Erro: ' + result.message);
                        }
                    } catch (err) {
                        alert('Erro ao processar planilha: ' + err.message);
                    }
                };
                reader.readAsArrayBuffer(file);
            };
            input.click();
        });
    }

    const btnExcluirTodosAjustesICMS = document.getElementById('btnExcluirTodosAjustesICMS');
    if (btnExcluirTodosAjustesICMS) {
        btnExcluirTodosAjustesICMS.addEventListener('click', async function() {
            if (!confirm('Deseja excluir TODOS os ajustes manuais ICMS deste per√≠odo?')) return;
            
            const empresaId = document.querySelector('[name="empresa"]').value;
            const periodoIni = document.querySelector('[name="periodo_inicial"]').value;
            const periodoFim = document.querySelector('[name="periodo_final"]').value;
            
            const response = await fetch('/dashboards/api/excluir-ajustes-manuais-icms/', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    empresa_id: empresaId,
                    periodo_inicial: periodoIni,
                    periodo_final: periodoFim
                })
            });
            const result = await response.json();
            
            if (result.success) {
                alert(result.message);
                location.reload();
            } else {
                alert('Erro: ' + result.message);
            }
        });
    }

    async function excluirAjusteManualICMS(ajusteId) {
        if (!confirm('Deseja excluir este ajuste manual?')) return;
        
        const response = await fetch(`/dashboards/api/excluir-ajuste-manual-icms/${ajusteId}/`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        const result = await response.json();
        
        if (result.success) {
            location.reload();
        } else {
            alert('Erro: ' + result.message);
        }
    }

    // Fun√ß√£o para abrir tabs
    function openTab(evt, tabName) {
        const tabContents = document.getElementsByClassName('tab-content');
        for (let i = 0; i < tabContents.length; i++) {
            tabContents[i].classList.remove('active');
        }
        
        const tabButtons = document.getElementsByClassName('tab-button');
        for (let i = 0; i < tabButtons.length; i++) {
            tabButtons[i].classList.remove('active');
        }
        
        document.getElementById(tabName).classList.add('active');
        evt.currentTarget.classList.add('active');
    }

    // Fun√ß√£o para carregar per√≠odos via AJAX
    function carregarPeriodos() {
        const empresaId = document.getElementById('empresaSelect').value;
        if (!empresaId) return;
        
        fetch(`/dashboards/api/periodos/?empresa=${empresaId}`)
            .then(response => response.json())
            .then(data => {
                const periodoInicial = document.getElementById('periodoInicialSelect');
                const periodoFinal = document.getElementById('periodoFinalSelect');
                
                periodoInicial.innerHTML = '<option value="">Selecione o in√≠cio</option>';
                periodoFinal.innerHTML = '<option value="">Selecione o fim</option>';
                
                data.periodos.forEach(periodo => {
                    periodoInicial.innerHTML += `<option value="${periodo}">${periodo}</option>`;
                    periodoFinal.innerHTML += `<option value="${periodo}">${periodo}</option>`;
                });
            });
    }

    // Spinner de carregamento
    function mostrarSpinnerCarregamento() {
        const spinnerExistente = document.getElementById('spinnerCarregamento');
        if (spinnerExistente) spinnerExistente.remove();
        
        const overlay = document.createElement('div');
        overlay.id = 'spinnerCarregamento';
        overlay.style.cssText = `
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.75); display: flex;
            justify-content: center; align-items: center; z-index: 999999;
        `;
        
        const spinnerContainer = document.createElement('div');
        spinnerContainer.style.cssText = `
            background: white; padding: 40px 50px; border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4); text-align: center; min-width: 300px;
        `;
        
        const spinner = document.createElement('div');
        spinner.style.cssText = `
            width: 60px; height: 60px; border: 6px solid #f3f4f6;
            border-top-color: #667eea; border-radius: 50%;
            animation: spin 1s linear infinite; margin: 0 auto 20px;
        `;
        
        const texto = document.createElement('div');
        texto.style.cssText = 'font-size: 18px; font-weight: 600; color: #1f2937; margin-bottom: 8px;';
        texto.textContent = 'Processando dados...';
        
        const subtexto = document.createElement('div');
        subtexto.style.cssText = 'font-size: 14px; color: #6b7280;';
        subtexto.textContent = 'Aguarde enquanto carregamos as informa√ß√µes';
        
        spinnerContainer.appendChild(spinner);
        spinnerContainer.appendChild(texto);
        spinnerContainer.appendChild(subtexto);
        overlay.appendChild(spinnerContainer);
        document.body.appendChild(overlay);
        
        if (!document.getElementById('spinnerStyles')) {
            const style = document.createElement('style');
            style.id = 'spinnerStyles';
            style.textContent = `@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }`;
            document.head.appendChild(style);
        }
    }

    // Configura√ß√£o dos gr√°ficos
    Chart.defaults.font.family = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
    Chart.defaults.color = '#495057';
    
    const colors = {
        primary: '#667eea',
        secondary: '#764ba2',
        success: '#10b981',
        warning: '#f59e0b',
        danger: '#ef4444',
        info: '#3b82f6',
        purple: '#8b5cf6',
        pink: '#ec4899'
    };
    
    // Dados dos gr√°ficos (vindos do Django)
    const dadosResumo = {
        cargaAtualCompras: Number({{ carga_atual_compras|default:"0" }}),
        cargaReformaCompras: Number({{ carga_reforma_compras|default:"0" }}),
        cargaAtualVendas: Number({{ carga_atual_vendas|default:"0" }}),
        cargaReformaVendas: Number({{ carga_reforma_vendas|default:"0" }}),
        icmsEntradas: Number({{ icms_entradas|default:"0" }}),
        pisEntradas: Number({{ pis_entradas|default:"0" }}),
        cofinsEntradas: Number({{ cofins_entradas|default:"0" }}),
        ibsCbsEntradas: Number({{ ibs_cbs_entradas|default:"0" }}),
        icmsSaidas: Number({{ icms_saidas|default:"0" }}),
        pisSaidas: Number({{ pis_saidas|default:"0" }}),
        cofinsSaidas: Number({{ cofins_saidas|default:"0" }}),
        ibsCbsSaidas: Number({{ ibs_cbs_saidas|default:"0" }})
    };

    // ============================================
    // BUSCA DE PRODUTOS VIA API MEUDANFE
    // ============================================
    
    let buscaCancelada = false;
    let produtosEncontrados = [];
    
    async function iniciarBuscaProdutosAPI() {
        const empresaId = document.getElementById('empresaSelect').value;
        const periodoInicial = document.getElementById('periodoInicialSelect').value;
        const periodoFinal = document.getElementById('periodoFinalSelect').value;
        
        if (!empresaId || !periodoInicial || !periodoFinal) {
            alert('Selecione a empresa e o per√≠odo antes de buscar os produtos.');
            return;
        }
        
        // Resetar vari√°veis
        buscaCancelada = false;
        produtosEncontrados = [];
        notasComErro = [];
        nfceIgnoradas = [];
        
        // Mostrar modal
        document.getElementById('modalProgressoAPI').classList.add('active');
        document.getElementById('btnCancelarBusca').style.display = 'inline-block';
        document.getElementById('btnFecharProgresso').style.display = 'none';
        const btnBuscar = document.getElementById('btnBuscarAPI');
        if (btnBuscar) btnBuscar.disabled = true;
        
        // Resetar estat√≠sticas
        document.getElementById('statTotal').textContent = '0';
        document.getElementById('statSucesso').textContent = '0';
        document.getElementById('statErro').textContent = '0';
        document.getElementById('statProdutos').textContent = '0';
        document.getElementById('progressoBarraFill').style.width = '0%';
        document.getElementById('progressoStatus').textContent = 'Buscando lista de notas...';
        document.getElementById('progressoContador').textContent = '0/0';
        document.getElementById('progressoNotaAtual').innerHTML = '<strong>Carregando chaves de acesso...</strong>';
        
        try {
            // Passo 1: Buscar lista de chaves
            const urlChaves = `/dashboards/api/listar-chaves-saida/?empresa=${empresaId}&periodo_inicial=${periodoInicial}&periodo_final=${periodoFinal}`;
            const respChaves = await fetch(urlChaves);
            const dataChaves = await respChaves.json();
            
// Guardar NFC-e ignoradas para o relat√≥rio
            if (dataChaves.nfce_ignoradas && dataChaves.nfce_ignoradas.length > 0) {
                nfceIgnoradas = dataChaves.nfce_ignoradas;
                document.getElementById('progressoNotaAtual').innerHTML = `<strong style="color:#f59e0b;">‚ö†Ô∏è ${nfceIgnoradas.length} NFC-e ser√£o ignoradas (n√£o dispon√≠veis via API)</strong>`;
                await new Promise(resolve => setTimeout(resolve, 1500));
            }
            
            if (!dataChaves.success || dataChaves.chaves.length === 0) {
                document.getElementById('progressoNotaAtual').innerHTML = '<strong style="color:#ef4444;">Nenhuma NF-e encontrada com chave de acesso v√°lida.</strong>';
                if (nfceIgnoradas.length > 0) {
                    exibirRelatorioErros();
                }
                finalizarBusca();
                return;
            }
            
            let chaves = dataChaves.chaves;
            
// Passo 1.5: Buscar chaves j√° processadas no banco
            document.getElementById('progressoNotaAtual').innerHTML = '<strong>Verificando chaves j√° processadas...</strong>';
            const urlProcessadas = `/dashboards/api/chaves-processadas/?empresa=${empresaId}&periodo_inicial=${periodoInicial}&periodo_final=${periodoFinal}`;
            const respProcessadas = await fetch(urlProcessadas);
            const dataProcessadas = await respProcessadas.json();
            
            // Filtrar chaves que j√° foram processadas e salvas no banco
            const chavesJaSalvas = new Set(dataProcessadas.chaves_processadas || []);
            
            // Tamb√©m filtrar chaves da sess√£o atual (produtosEncontrados)
            const chavesJaProcessadas = new Set(produtosEncontrados.map(p => p.chave_nfe));
            
            if (chavesJaSalvas.size > 0 || chavesJaProcessadas.size > 0) {
                const totalAntes = chaves.length;
                chaves = chaves.filter(c => !chavesJaSalvas.has(c.chave_nfe) && !chavesJaProcessadas.has(c.chave_nfe));
                const filtradas = totalAntes - chaves.length;
                
                if (filtradas > 0) {
                    console.log(`‚úÖ ${filtradas} chaves j√° processadas foram ignoradas (${chavesJaSalvas.size} no banco + ${chavesJaProcessadas.size} na sess√£o)`);
                    document.getElementById('progressoNotaAtual').innerHTML = `<strong style="color:#10b981;">‚úÖ ${filtradas} notas j√° processadas anteriormente (${chavesJaSalvas.size} salvas + ${chavesJaProcessadas.size} na sess√£o)</strong>`;
                    await new Promise(resolve => setTimeout(resolve, 2000));
                }
            }
            
            const total = chaves.length;
            chavesParaBuscar = chaves; // Salvar para poss√≠vel retomada
            indiceBuscaAtual = 0; // Resetar √≠ndice
            document.getElementById('statTotal').textContent = total;
            document.getElementById('progressoContador').textContent = `0/${total}`;
            document.getElementById('progressoStatus').textContent = 'Buscando XMLs...';
            
            let sucesso = 0;
            let erros = 0;
            let totalProdutos = 0;
            
            // Passo 2: Buscar cada XML
            for (let i = 0; i < chaves.length; i++) {
                if (buscaCancelada) {
                    document.getElementById('progressoNotaAtual').innerHTML = '<strong style="color:#f59e0b;">Busca cancelada pelo usu√°rio.</strong>';
                    break;
                }
                
                const nota = chaves[i];
                const numNota = nota.numero || nota.chave_nfe.substring(25, 34);
                
                document.getElementById('progressoNotaAtual').innerHTML = `<strong>Buscando NF ${numNota}...</strong> (Chave: ${nota.chave_nfe.substring(0, 20)}...)`;
                
// Fun√ß√£o auxiliar para buscar com retry
                async function buscarComRetry(chaveAcesso, maxTentativas = 3) {
                    let ultimoErro = null;
                    for (let tentativa = 1; tentativa <= maxTentativas; tentativa++) {
                        try {
                            const response = await fetch('/dashboards/api/buscar-xml-produto/', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ chave_acesso: chaveAcesso })
                            });
                            if (!response.ok) {
                                throw new Error('HTTP ' + response.status);
                            }
                            return await response.json();
                        } catch (err) {
                            ultimoErro = err;
                            console.log('[RETRY] Tentativa ' + tentativa + '/' + maxTentativas + ' falhou: ' + err.message);
                            if (tentativa < maxTentativas) {
                                await new Promise(r => setTimeout(r, 1000 * tentativa));
                            }
                        }
                    }
                    throw ultimoErro;
                }
                
                try {
                    let data = await buscarComRetry(nota.chave_nfe, 3);
                    
                    // Incrementar contador de consultas no lote
                    consultasNoLoteAtual++;
                    
                    // Verificar se √© erro de saldo insuficiente - pausar e salvar progresso
                    if (!data.success && data.message && data.message.toLowerCase().includes('saldo insuficiente')) {
                        buscaPausadaPorSaldo = true;
                        indiceBuscaAtual = i;
                        // Atualizar tabela com dados j√° coletados
                        if (produtosEncontrados.length > 0) {
                            atualizarTabelaProdutosSaida(produtosEncontrados);
                        }
                        document.getElementById('progressoNotaAtual').innerHTML = `<strong style="color:#f59e0b;">‚ö†Ô∏è Saldo insuficiente na API. Busca pausada em ${i}/${total}. (${consultasNoLoteAtual} consultas neste lote)</strong>`;
                        document.getElementById('progressoStatus').textContent = 'Busca pausada - Aguardando recarga de saldo';
                        document.getElementById('btnRetomar').style.display = 'inline-block';
                        document.getElementById('btnCancelarBusca').style.display = 'none';
                        return;
                    }
                    
                    if (data.success && data.produtos && data.produtos.length > 0) {
                        sucesso++;
                        const qtdProdutos = data.produtos.length;
                        totalProdutos += qtdProdutos;
                        
// Converter formato dos itens - mapeando campos do XML corretamente
                        const chaveAtual = nota.chave_nfe || data.chave || '';
                        data.produtos.forEach(item => {
                            produtosEncontrados.push({
                                chave_nfe: chaveAtual,
                                codigo: item.codigo || item.cod_item || item.cProd || '',
                                descricao: item.descricao || item.xProd || '',
                                ncm: item.ncm || item.NCM || '',
                                cfop: item.cfop || item.CFOP || '',
                                quantidade: parseFloat(item.quantidade || item.qtd || item.qCom || 0),
                                valor_total: parseFloat(item.valor_total || item.vl_item || item.vProd || 0),
                                valor_unitario: parseFloat(item.valor_unitario || item.vl_unit || item.vUnCom || 0),
                                icms_cst: item.icms_cst || item.cst_icms || '',
                                icms_valor: parseFloat(item.icms_valor || item.vl_icms || 0),
                                icms_st_valor: parseFloat(item.icms_st_valor || item.vl_icms_st || 0),
                                ipi_valor: parseFloat(item.ipi_valor || item.vl_ipi || 0),
                                pis_cst: item.pis_cst || item.cst_pis || '',
                                pis_valor: parseFloat(item.pis_valor || item.vl_pis || 0),
                                cofins_cst: item.cofins_cst || item.cst_cofins || '',
                                cofins_valor: parseFloat(item.cofins_valor || item.vl_cofins || 0)
                            });
                        });
                        
                        document.getElementById('statSucesso').textContent = sucesso;
                        document.getElementById('statProdutos').textContent = totalProdutos;
                        
                        // Atualizar tabela em tempo real a cada 5 notas processadas com sucesso
                        if (sucesso % 5 === 0 || sucesso === 1) {
                            atualizarTabelaProdutosSaida(produtosEncontrados);
                        }
                    } else {
                        erros++;
                        notasComErro.push({
                            ...nota,
                            erro: data.message || 'XML n√£o encontrado'
                        });
                        document.getElementById('statErro').textContent = erros;
                    }
                    
                    // Verificar limite de pesquisas por lote (165)
                    if (consultasNoLoteAtual >= LIMITE_PESQUISAS_POR_LOTE) {
                        buscaPausadaPorSaldo = true;
                        indiceBuscaAtual = i + 1; // Pr√≥xima nota
                        // Atualizar tabela com dados coletados
                        if (produtosEncontrados.length > 0) {
                            atualizarTabelaProdutosSaida(produtosEncontrados);
                        }
                        document.getElementById('progressoNotaAtual').innerHTML = `<strong style="color:#3b82f6;">üîÑ Limite de ${LIMITE_PESQUISAS_POR_LOTE} consultas atingido. Busca pausada em ${i + 1}/${total}.</strong>`;
                        document.getElementById('progressoStatus').textContent = `Lote conclu√≠do - ${total - i - 1} notas restantes`;
                        document.getElementById('btnRetomar').style.display = 'inline-block';
                        document.getElementById('btnCancelarBusca').style.display = 'none';
                        consultasNoLoteAtual = 0; // Resetar para pr√≥ximo lote
                        return;
                    }
                    
                } catch (e) {
                    // Verificar se √© erro de saldo insuficiente na exce√ß√£o
                    if (e.message && e.message.toLowerCase().includes('saldo insuficiente')) {
                        buscaPausadaPorSaldo = true;
                        indiceBuscaAtual = i;
                        // Atualizar tabela com dados j√° coletados
                        if (produtosEncontrados.length > 0) {
                            atualizarTabelaProdutosSaida(produtosEncontrados);
                        }
                        document.getElementById('progressoNotaAtual').innerHTML = `<strong style="color:#f59e0b;">‚ö†Ô∏è Saldo insuficiente na API. Busca pausada em ${i}/${total}.</strong>`;
                        document.getElementById('progressoStatus').textContent = 'Busca pausada - Aguardando recarga de saldo';
                        document.getElementById('btnRetomar').style.display = 'inline-block';
                        document.getElementById('btnCancelarBusca').style.display = 'none';
                        return;
                    }
                    erros++;
                    notasComErro.push({
                        ...nota,
                        erro: 'Falha ap√≥s 3 tentativas: ' + e.message
                    });
                    document.getElementById('statErro').textContent = erros;
                }
                
                // Atualizar progresso
                const pct = Math.round(((i + 1) / total) * 100);
                document.getElementById('progressoBarraFill').style.width = pct + '%';
                document.getElementById('progressoContador').textContent = `${i + 1}/${total} (Lote: ${consultasNoLoteAtual}/${LIMITE_PESQUISAS_POR_LOTE})`;
                
                // Delay de 600ms entre requisi√ß√µes
                await new Promise(resolve => setTimeout(resolve, 600));
            }
            
// Finalizar
            if (!buscaCancelada) {
                document.getElementById('progressoStatus').textContent = 'Busca conclu√≠da!';
                document.getElementById('progressoNotaAtual').innerHTML = `<strong style="color:#059669;">‚úÖ Busca finalizada! ${sucesso} notas processadas, ${totalProdutos} produtos encontrados.</strong>`;
                
                // Atualizar tabela de produtos se houver resultados
                if (produtosEncontrados.length > 0) {
                    atualizarTabelaProdutosSaida(produtosEncontrados);
                }
                
                // Exibir relat√≥rio de erros e NFC-e ignoradas
                exibirRelatorioErros();
            }
            
            finalizarBusca();
            
        } catch (e) {
            console.error('Erro na busca:', e);
            document.getElementById('progressoNotaAtual').innerHTML = `<strong style="color:#ef4444;">Erro: ${e.message}</strong>`;
            finalizarBusca();
        }
    }
    
    function cancelarBuscaAPI() {
        buscaCancelada = true;
        document.getElementById('progressoStatus').textContent = 'Cancelando...';
    }
    
    function finalizarBusca() {
        document.getElementById('btnCancelarBusca').style.display = 'none';
        document.getElementById('btnFecharProgresso').style.display = 'inline-block';
        if (notasComErro.length > 0 || nfceIgnoradas.length > 0) {
            document.getElementById('btnExportarErros').style.display = 'inline-block';
        }
        const btnBuscar = document.getElementById('btnBuscarAPI');
        if (btnBuscar) btnBuscar.disabled = false;
        
        // Mostrar bot√£o de buscar faltantes se houver notas pendentes
        const btnFaltantes = document.getElementById('btnBuscarFaltantes');
        if (btnFaltantes && (notasComErro.length > 0 || (indiceBuscaAtual > 0 && indiceBuscaAtual < chavesParaBuscar.length))) {
            btnFaltantes.style.display = 'inline-block';
        }
        
        // Atualizar bot√µes no header da se√ß√£o
        atualizarBotoesHeader();
    }
    
    async function buscarProdutosFaltantes() {
        // Filtrar apenas as notas que deram erro ou n√£o foram processadas
        const chavesFaltantes = [];
        
        // Adicionar notas com erro
        notasComErro.forEach(nota => {
            chavesFaltantes.push({
                chave_nfe: nota.chave_nfe,
                numero: nota.numero,
                data: nota.data,
                valor: nota.valor
            });
        });
        
        // Adicionar notas n√£o processadas (a partir do √≠ndice atual)
        if (indiceBuscaAtual > 0 && indiceBuscaAtual < chavesParaBuscar.length) {
            for (let i = indiceBuscaAtual; i < chavesParaBuscar.length; i++) {
                const nota = chavesParaBuscar[i];
                // Verificar se j√° n√£o est√° na lista de faltantes
                const jaExiste = chavesFaltantes.some(c => c.chave_nfe === nota.chave_nfe);
                if (!jaExiste) {
                    chavesFaltantes.push(nota);
                }
            }
        }
        
        if (chavesFaltantes.length === 0) {
            alert('N√£o h√° produtos faltantes para buscar.');
            return;
        }
        
        // Resetar vari√°veis para nova busca
        buscaCancelada = false;
        notasComErro = [];
        indiceBuscaAtual = 0;
        chavesParaBuscar = chavesFaltantes;
        consultasNoLoteAtual = 0;
        buscaPausadaPorSaldo = false;
        
        // Mostrar modal
        document.getElementById('modalProgressoAPI').classList.add('active');
        document.getElementById('btnCancelarBusca').style.display = 'inline-block';
        document.getElementById('btnFecharProgresso').style.display = 'none';
        document.getElementById('btnRetomar').style.display = 'none';
        
        const btnBuscar = document.getElementById('btnBuscarAPI');
        if (btnBuscar) btnBuscar.disabled = true;
        
        const btnFaltantes = document.getElementById('btnBuscarFaltantes');
        if (btnFaltantes) btnFaltantes.style.display = 'none';
        
        // Atualizar estat√≠sticas
        const total = chavesFaltantes.length;
        document.getElementById('statTotal').textContent = total;
        document.getElementById('statSucesso').textContent = '0';
        document.getElementById('statErro').textContent = '0';
        document.getElementById('progressoBarraFill').style.width = '0%';
        document.getElementById('progressoStatus').textContent = 'Buscando notas faltantes...';
        document.getElementById('progressoContador').textContent = `0/${total}`;
        
        let sucesso = 0;
        let erros = 0;
        let totalProdutos = parseInt(document.getElementById('statProdutos').textContent) || 0;
        
        for (let i = 0; i < chavesFaltantes.length; i++) {
            if (buscaCancelada) {
                document.getElementById('progressoNotaAtual').innerHTML = '<strong style="color:#f59e0b;">Busca cancelada pelo usu√°rio.</strong>';
                break;
            }
            
            const nota = chavesFaltantes[i];
            const numNota = nota.numero || nota.chave_nfe.substring(25, 34);
            
            document.getElementById('progressoNotaAtual').innerHTML = `<strong>Buscando NF ${numNota}...</strong> (Faltante ${i + 1}/${total})`;
            
            try {
                const response = await fetch('/dashboards/api/buscar-xml-produto/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ chave_acesso: nota.chave_nfe })
                });
                const data = await response.json();
                
                consultasNoLoteAtual++;
                
                if (!data.success && data.message && data.message.toLowerCase().includes('saldo insuficiente')) {
                    buscaPausadaPorSaldo = true;
                    indiceBuscaAtual = i;
                    chavesParaBuscar = chavesFaltantes;
                    if (produtosEncontrados.length > 0) {
                        atualizarTabelaProdutosSaida(produtosEncontrados);
                    }
                    document.getElementById('progressoNotaAtual').innerHTML = `<strong style="color:#f59e0b;">‚ö†Ô∏è Saldo insuficiente. Busca pausada em ${i}/${total}.</strong>`;
                    document.getElementById('progressoStatus').textContent = 'Busca pausada - Aguardando recarga de saldo';
                    document.getElementById('btnRetomar').style.display = 'inline-block';
                    document.getElementById('btnCancelarBusca').style.display = 'none';
                    return;
                }
                
                if (data.success && data.produtos && data.produtos.length > 0) {
                    sucesso++;
                    totalProdutos += data.produtos.length;
                    
                    data.produtos.forEach(item => {
                        produtosEncontrados.push({
                            codigo: item.codigo || item.cod_item || item.cProd || '',
                            descricao: item.descricao || item.xProd || '',
                            ncm: item.ncm || item.NCM || '',
                            cfop: item.cfop || item.CFOP || '',
                            quantidade: parseFloat(item.quantidade || item.qtd || item.qCom || 0),
                            valor_total: parseFloat(item.valor_total || item.vl_item || item.vProd || 0),
                            valor_unitario: parseFloat(item.valor_unitario || item.vl_unit || item.vUnCom || 0),
                            icms_cst: item.icms_cst || item.cst_icms || '',
                            icms_valor: parseFloat(item.icms_valor || item.vl_icms || 0),
                            icms_st_valor: parseFloat(item.icms_st_valor || item.vl_icms_st || 0),
                            ipi_valor: parseFloat(item.ipi_valor || item.vl_ipi || 0),
                            pis_cst: item.pis_cst || item.cst_pis || '',
                            pis_valor: parseFloat(item.pis_valor || item.vl_pis || 0),
                            cofins_cst: item.cofins_cst || item.cst_cofins || '',
                            cofins_valor: parseFloat(item.cofins_valor || item.vl_cofins || 0)
                        });
                    });
                    
                    document.getElementById('statSucesso').textContent = sucesso;
                    document.getElementById('statProdutos').textContent = totalProdutos;
                    
                    if (sucesso % 5 === 0 || sucesso === 1) {
                        atualizarTabelaProdutosSaida(produtosEncontrados);
                    }
                } else {
                    erros++;
                    notasComErro.push({
                        ...nota,
                        erro: data.message || 'XML n√£o encontrado'
                    });
                    document.getElementById('statErro').textContent = erros;
                }
                
                if (consultasNoLoteAtual >= LIMITE_PESQUISAS_POR_LOTE) {
                    buscaPausadaPorSaldo = true;
                    indiceBuscaAtual = i + 1;
                    chavesParaBuscar = chavesFaltantes;
                    if (produtosEncontrados.length > 0) {
                        atualizarTabelaProdutosSaida(produtosEncontrados);
                    }
                    document.getElementById('progressoNotaAtual').innerHTML = `<strong style="color:#3b82f6;">üîÑ Limite de ${LIMITE_PESQUISAS_POR_LOTE} consultas atingido. Busca pausada em ${i + 1}/${total}.</strong>`;
                    document.getElementById('progressoStatus').textContent = `Lote conclu√≠do - ${total - i - 1} notas restantes`;
                    document.getElementById('btnRetomar').style.display = 'inline-block';
                    document.getElementById('btnCancelarBusca').style.display = 'none';
                    consultasNoLoteAtual = 0;
                    return;
                }
                
            } catch (e) {
                erros++;
                notasComErro.push({
                    ...nota,
                    erro: 'Falha: ' + e.message
                });
                document.getElementById('statErro').textContent = erros;
            }
            
            const pct = Math.round(((i + 1) / total) * 100);
            document.getElementById('progressoBarraFill').style.width = pct + '%';
            document.getElementById('progressoContador').textContent = `${i + 1}/${total} (Lote: ${consultasNoLoteAtual}/${LIMITE_PESQUISAS_POR_LOTE})`;
            
            await new Promise(resolve => setTimeout(resolve, 600));
        }
        
        if (!buscaCancelada && !buscaPausadaPorSaldo) {
            document.getElementById('progressoStatus').textContent = 'Busca de faltantes conclu√≠da!';
            document.getElementById('progressoNotaAtual').innerHTML = `<strong style="color:#059669;">‚úÖ Busca finalizada! ${sucesso} notas processadas, ${totalProdutos} produtos encontrados.</strong>`;
            
            if (produtosEncontrados.length > 0) {
                atualizarTabelaProdutosSaida(produtosEncontrados);
            }
            
            exibirRelatorioErros();
        }
        
        finalizarBusca();
    }
    
    function fecharModalProgresso() {
        document.getElementById('modalProgressoAPI').classList.remove('active');
        // Atualizar visibilidade dos bot√µes no header
        atualizarBotoesHeader();
    }
    
    function atualizarBotoesHeader() {
        const btnRetomar = document.getElementById('btnRetomarHeader');
        const btnPendencias = document.getElementById('btnVerPendencias');
        const btnFaltantesHeader = document.getElementById('btnBuscarFaltantesHeader');
        const btnFaltantes = document.getElementById('btnBuscarFaltantes');
        
        // Mostrar bot√£o Retomar se h√° busca pausada
        if (buscaPausadaPorSaldo && chavesParaBuscar.length > 0 && indiceBuscaAtual < chavesParaBuscar.length) {
            btnRetomar.classList.add('visible');
        } else {
            btnRetomar.classList.remove('visible');
        }
        
        // Mostrar bot√£o Ver Pend√™ncias se h√° erros ou NFC-e
        if (notasComErro.length > 0 || nfceIgnoradas.length > 0) {
            btnPendencias.classList.add('visible');
        } else {
            btnPendencias.classList.remove('visible');
        }
        
        // Mostrar bot√£o Buscar Faltantes se h√° notas com erro (para rebuscar)
        const temFaltantes = notasComErro.length > 0;
        if (btnFaltantesHeader) {
            if (temFaltantes) {
                btnFaltantesHeader.classList.add('visible');
            } else {
                btnFaltantesHeader.classList.remove('visible');
            }
        }
        if (btnFaltantes) {
            btnFaltantes.style.display = temFaltantes ? 'inline-block' : 'none';
        }
    }
    
    function abrirModalRetomar() {
        document.getElementById('modalProgressoAPI').classList.add('active');
        document.getElementById('btnFecharProgresso').style.display = 'none';
        document.getElementById('btnRetomar').style.display = 'inline-block';
        document.getElementById('btnCancelarBusca').style.display = 'none';
    }
    
    function abrirModalPendencias() {
        renderizarPendencias();
        document.getElementById('modalPendencias').classList.add('active');
    }
    
    function fecharModalPendencias() {
        document.getElementById('modalPendencias').classList.remove('active');
    }
    
    function renderizarPendencias() {
        const container = document.getElementById('conteudoPendencias');
        
        if (notasComErro.length === 0 && nfceIgnoradas.length === 0) {
            container.innerHTML = '<p class="text-center text-muted">Nenhuma pend√™ncia registrada.</p>';
            return;
        }
        
        let html = '';
        
        // NF-e com Erro
        if (notasComErro.length > 0) {
            html += `
                <div class="secao-pendencias">
                    <h4>
                        <i class="bi bi-x-circle" style="color:#dc2626;"></i>
                        NF-e com Erro na Busca
                        <span class="contador-pendencias">${notasComErro.length}</span>
                    </h4>
                    <table class="tabela-pendencias">
                        <thead>
                            <tr>
                                <th style="width:80px;">N√∫mero</th>
                                <th style="width:90px;">Data</th>
                                <th style="width:100px;">Valor</th>
                                <th>Chave de Acesso</th>
                                <th style="width:150px;">Erro</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            notasComErro.forEach(nota => {
                html += `
                    <tr>
                        <td><strong>${nota.numero || '-'}</strong></td>
                        <td>${nota.data || '-'}</td>
                        <td>R$ ${(nota.valor || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                        <td class="chave-acesso">${nota.chave_nfe || '-'}</td>
                        <td><span class="badge-erro">${nota.erro || 'Erro desconhecido'}</span></td>
                    </tr>
                `;
            });
            html += '</tbody></table></div>';
        }
        
        // NFC-e N√£o Pesquisadas
        if (nfceIgnoradas.length > 0) {
            html += `
                <div class="secao-pendencias">
                    <h4>
                        <i class="bi bi-receipt" style="color:#d97706;"></i>
                        NFC-e N√£o Pesquisadas (modelo 65)
                        <span class="contador-nfce">${nfceIgnoradas.length}</span>
                    </h4>
                    <p style="font-size:12px; color:#6b7280; margin-bottom:10px;">NFC-e (modelo 65) n√£o s√£o consultadas via API externa.</p>
                    <table class="tabela-pendencias">
                        <thead>
                            <tr>
                                <th style="width:80px;">N√∫mero</th>
                                <th style="width:90px;">Data</th>
                                <th style="width:100px;">Valor</th>
                                <th>Chave de Acesso</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            nfceIgnoradas.forEach(nota => {
                html += `
                    <tr>
                        <td><strong>${nota.numero || '-'}</strong></td>
                        <td>${nota.data || '-'}</td>
                        <td>R$ ${(nota.valor || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                        <td class="chave-acesso">${nota.chave_nfe || '-'}</td>
                    </tr>
                `;
            });
            html += '</tbody></table></div>';
        }
        
        container.innerHTML = html;
    }
    
    async function retomarBuscaAPI() {
        if (!buscaPausadaPorSaldo || chavesParaBuscar.length === 0) {
            alert('N√£o h√° busca para retomar.');
            return;
        }
        
        document.getElementById('btnRetomar').style.display = 'none';
        document.getElementById('btnCancelarBusca').style.display = 'inline-block';
        document.getElementById('progressoStatus').textContent = 'Retomando busca...';
        buscaPausadaPorSaldo = false;
        consultasNoLoteAtual = 0; // Resetar contador do lote
        
        const total = chavesParaBuscar.length;
        let sucesso = parseInt(document.getElementById('statSucesso').textContent) || 0;
        let erros = parseInt(document.getElementById('statErro').textContent) || 0;
        let totalProdutos = parseInt(document.getElementById('statProdutos').textContent) || 0;
        
        for (let i = indiceBuscaAtual; i < chavesParaBuscar.length; i++) {
            if (buscaCancelada) {
                document.getElementById('progressoNotaAtual').innerHTML = '<strong style="color:#f59e0b;">Busca cancelada pelo usu√°rio.</strong>';
                break;
            }
            
            const nota = chavesParaBuscar[i];
            const numNota = nota.numero || nota.chave_nfe.substring(25, 34);
            
            document.getElementById('progressoNotaAtual').innerHTML = `<strong>Buscando NF ${numNota}...</strong> (Chave: ${nota.chave_nfe.substring(0, 20)}...)`;
            
            try {
                const response = await fetch('/dashboards/api/buscar-xml-produto/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ chave_acesso: nota.chave_nfe })
                });
                const data = await response.json();
                
                // Verificar se √© erro de saldo insuficiente - pausar novamente
                if (!data.success && data.message && data.message.toLowerCase().includes('saldo insuficiente')) {
                    buscaPausadaPorSaldo = true;
                    indiceBuscaAtual = i;
                    document.getElementById('progressoNotaAtual').innerHTML = `<strong style="color:#f59e0b;">‚ö†Ô∏è Saldo insuficiente na API. Busca pausada em ${i}/${total}.</strong>`;
                    document.getElementById('progressoStatus').textContent = 'Busca pausada - Aguardando recarga de saldo';
                    document.getElementById('btnRetomar').style.display = 'inline-block';
                    document.getElementById('btnCancelarBusca').style.display = 'none';
                    return;
                }
                
                if (data.success && data.produtos && data.produtos.length > 0) {
                    sucesso++;
                    const qtdProdutos = data.produtos.length;
                    totalProdutos += qtdProdutos;
                    
                    data.produtos.forEach(item => {
                        produtosEncontrados.push({
                            codigo: item.codigo || item.cod_item || item.cProd || '',
                            descricao: item.descricao || item.xProd || '',
                            ncm: item.ncm || item.NCM || '',
                            cfop: item.cfop || item.CFOP || '',
                            quantidade: parseFloat(item.quantidade || item.qtd || item.qCom || 0),
                            valor_total: parseFloat(item.valor_total || item.vl_item || item.vProd || 0),
                            valor_unitario: parseFloat(item.valor_unitario || item.vl_unit || item.vUnCom || 0),
                            icms_cst: item.icms_cst || item.cst_icms || '',
                            icms_valor: parseFloat(item.icms_valor || item.vl_icms || 0),
                            icms_st_valor: parseFloat(item.icms_st_valor || item.vl_icms_st || 0),
                            ipi_valor: parseFloat(item.ipi_valor || item.vl_ipi || 0),
                            pis_cst: item.pis_cst || item.cst_pis || '',
                            pis_valor: parseFloat(item.pis_valor || item.vl_pis || 0),
                            cofins_cst: item.cofins_cst || item.cst_cofins || '',
                            cofins_valor: parseFloat(item.cofins_valor || item.vl_cofins || 0)
                        });
                    });
                    
                    document.getElementById('statSucesso').textContent = sucesso;
                    document.getElementById('statProdutos').textContent = totalProdutos;
                    
                    // Atualizar tabela em tempo real a cada 5 notas
                    if (sucesso % 5 === 0) {
                        atualizarTabelaProdutosSaida(produtosEncontrados);
                    }
                } else {
                    erros++;
                    notasComErro.push({
                        ...nota,
                        erro: data.message || 'XML n√£o encontrado'
                    });
                    document.getElementById('statErro').textContent = erros;
                }
            } catch (e) {
                if (e.message && e.message.toLowerCase().includes('saldo insuficiente')) {
                    buscaPausadaPorSaldo = true;
                    indiceBuscaAtual = i;
                    document.getElementById('progressoNotaAtual').innerHTML = `<strong style="color:#f59e0b;">‚ö†Ô∏è Saldo insuficiente na API. Busca pausada em ${i}/${total}.</strong>`;
                    document.getElementById('progressoStatus').textContent = 'Busca pausada - Aguardando recarga de saldo';
                    document.getElementById('btnRetomar').style.display = 'inline-block';
                    document.getElementById('btnCancelarBusca').style.display = 'none';
                    return;
                }
                erros++;
                notasComErro.push({
                    ...nota,
                    erro: 'Falha: ' + e.message
                });
                document.getElementById('statErro').textContent = erros;
            }
            
            // Incrementar e verificar limite de pesquisas por lote
            consultasNoLoteAtual++;
            if (consultasNoLoteAtual >= LIMITE_PESQUISAS_POR_LOTE) {
                buscaPausadaPorSaldo = true;
                indiceBuscaAtual = i + 1;
                if (produtosEncontrados.length > 0) {
                    atualizarTabelaProdutosSaida(produtosEncontrados);
                }
                document.getElementById('progressoNotaAtual').innerHTML = `<strong style="color:#3b82f6;">üîÑ Limite de ${LIMITE_PESQUISAS_POR_LOTE} consultas atingido. Busca pausada em ${i + 1}/${total}.</strong>`;
                document.getElementById('progressoStatus').textContent = `Lote conclu√≠do - ${total - i - 1} notas restantes`;
                document.getElementById('btnRetomar').style.display = 'inline-block';
                document.getElementById('btnCancelarBusca').style.display = 'none';
                consultasNoLoteAtual = 0;
                return;
            }
            
            const pct = Math.round(((i + 1) / total) * 100);
            document.getElementById('progressoBarraFill').style.width = pct + '%';
            document.getElementById('progressoContador').textContent = `${i + 1}/${total} (Lote: ${consultasNoLoteAtual}/${LIMITE_PESQUISAS_POR_LOTE})`;
            
            await new Promise(resolve => setTimeout(resolve, 600));
        }
        
        // Finalizar
        if (!buscaCancelada && !buscaPausadaPorSaldo) {
            document.getElementById('progressoStatus').textContent = 'Busca conclu√≠da!';
            document.getElementById('progressoNotaAtual').innerHTML = `<strong style="color:#059669;">‚úÖ Busca finalizada! ${sucesso} notas processadas, ${totalProdutos} produtos encontrados.</strong>`;
            
            if (produtosEncontrados.length > 0) {
                atualizarTabelaProdutosSaida(produtosEncontrados);
            }
            
            exibirRelatorioErros();
        }
        
        finalizarBusca();
    }
    
    function exportarRelatorioErros() {
        const dadosExport = {
            nfe_erros: notasComErro.map(n => ({
                numero: n.numero || '',
                chave_nfe: n.chave_nfe || '',
                data: n.data || '',
                valor: n.valor || 0,
                erro: n.erro || ''
            })),
            nfce_ignoradas: nfceIgnoradas.map(n => ({
                numero: n.numero || '',
                chave_nfe: n.chave_nfe || '',
                data: n.data || '',
                valor: n.valor || 0,
                motivo: 'NFC-e n√£o dispon√≠vel via API'
            }))
        };
        
        fetch('/dashboards/api/exportar-relatorio-erros/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(dadosExport)
        })
        .then(response => {
            if (!response.ok) throw new Error('Erro ao gerar Excel');
            return response.blob();
        })
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'relatorio_erros_nfe_' + new Date().toISOString().slice(0,10) + '.xlsx';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            a.remove();
        })
        .catch(error => {
            alert('Erro ao exportar: ' + error.message);
        });
    }
    
// Vari√°veis globais para relat√≥rio de erros
    let notasComErro = [];
    let nfceIgnoradas = [];
    
    // Vari√°veis para controle de retomada da busca
    let indiceBuscaAtual = 0;
    let chavesParaBuscar = [];
    let buscaPausadaPorSaldo = false;
    
    // Limite de pesquisas por lote (para evitar esgotar saldo)
    const LIMITE_PESQUISAS_POR_LOTE = 165;
    let consultasNoLoteAtual = 0;
    
    function atualizarTabelaProdutosSaida(produtos) {
        // N√ÉO agrupar - manter cada produto individual com sua chave
        const produtosProcessados = produtos.map(prod => ({
            chave_nfe: prod.chave_nfe || '',
            codigo: prod.codigo || '',
            ncm: prod.ncm || '',
            descricao: prod.descricao || '',
            quantidade: prod.quantidade || 0,
            valor_bruto: prod.valor_total || 0,
            icms: prod.icms_valor || 0,
            icms_st: prod.icms_st_valor || 0,
            ipi: prod.ipi_valor || 0,
            pis: prod.pis_valor || 0,
            cofins: prod.cofins_valor || 0
        }));
        
        // Ordenar por valor
        const produtosAgrupados = produtosProcessados.sort((a, b) => b.valor_bruto - a.valor_bruto);
        
        // Ocultar empty-state
        const emptyState = document.getElementById('emptyStateSaidas');
        if (emptyState) {
            emptyState.style.display = 'none';
        }
        
        // Al√≠quota IBS/CBS (27%)
        const aliqIbsCbs = 0.27;
        const pctReducao = 0; // % Redu√ß√£o (pode ser parametrizado)
        
// Construir HTML da tabela
        let html = `
            <table class="table-relatorio">
                <thead>
                    <tr>
                        <th>Chave NF-e</th>
                        <th>C√≥digo</th>
                        <th>Descri√ß√£o</th>
                        <th>NCM</th>
                        <th>Quant.</th>
                        <th>% Red.</th>
                        <th>Aliq. IBS/CBS</th>
                        <th>Valor Bruto Unit.</th>
                        <th>Valor Bruto Tot.</th>
                        <th>ICMS</th>
                        <th>ICMS ST</th>
                        <th>IPI</th>
                        <th>PIS</th>
                        <th>COFINS</th>
                        <th>Total Tributos</th>
                        <th class="reforma">Valor L√≠q. Unit.</th>
                        <th class="reforma">Valor L√≠q. Tot.</th>
                        <th class="reforma">IBS/CBS Unit.</th>
                        <th class="reforma">IBS/CBS Tot.</th>
                        <th class="reforma">Total Reforma Unit.</th>
                        <th class="reforma">Total Reforma</th>
                        <th class="reforma">Dif. Unit.</th>
                        <th class="reforma">Dif. Total</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        let totais = {
            quantidade: 0,
            valor_bruto: 0,
            icms: 0,
            icms_st: 0,
            ipi: 0,
            pis: 0,
            cofins: 0,
            total_tributos: 0,
            valor_liq: 0,
            ibs_cbs: 0,
            total_reforma: 0,
            diferenca: 0
        };
        
        produtosAgrupados.forEach(prod => {
            const totalTributos = prod.icms + prod.icms_st + prod.ipi + prod.pis + prod.cofins;
            const valorLiqTot = prod.valor_bruto - totalTributos;
            const valorLiqUnit = prod.quantidade > 0 ? valorLiqTot / prod.quantidade : 0;
            const valorBrutoUnit = prod.quantidade > 0 ? prod.valor_bruto / prod.quantidade : 0;
            
            const aliqEfetiva = aliqIbsCbs * (1 - pctReducao / 100);
            const ibsCbsTot = valorLiqTot * aliqEfetiva;
            const ibsCbsUnit = prod.quantidade > 0 ? ibsCbsTot / prod.quantidade : 0;
            
            const totalReformaTot = valorLiqTot + ibsCbsTot;
            const totalReformaUnit = prod.quantidade > 0 ? totalReformaTot / prod.quantidade : 0;
            
            const difTotal = totalReformaTot - prod.valor_bruto;
            const difUnit = prod.quantidade > 0 ? difTotal / prod.quantidade : 0;
            
            // Acumular totais
            totais.quantidade += prod.quantidade;
            totais.valor_bruto += prod.valor_bruto;
            totais.icms += prod.icms;
            totais.icms_st += prod.icms_st;
            totais.ipi += prod.ipi;
            totais.pis += prod.pis;
            totais.cofins += prod.cofins;
            totais.total_tributos += totalTributos;
            totais.valor_liq += valorLiqTot;
            totais.ibs_cbs += ibsCbsTot;
            totais.total_reforma += totalReformaTot;
            totais.diferenca += difTotal;
            
            html += `
                <tr>
                    <td><small title="${prod.chave_nfe}">${prod.chave_nfe ? prod.chave_nfe.substring(0, 15) + '...' : '-'}</small></td>
                    <td>${prod.codigo}</td>
                    <td>${prod.descricao.substring(0, 35)}</td>
                    <td>${prod.ncm}</td>
                    <td>${prod.quantidade.toFixed(2)}</td>
                    <td>${pctReducao.toFixed(2)}%</td>
                    <td>${(aliqEfetiva * 100).toFixed(2)}%</td>
                    <td>R$ ${valorBrutoUnit.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                    <td>R$ ${prod.valor_bruto.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                    <td>R$ ${prod.icms.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                    <td>R$ ${prod.icms_st.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                    <td>R$ ${prod.ipi.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                    <td>R$ ${prod.pis.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                    <td>R$ ${prod.cofins.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                    <td>R$ ${totalTributos.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                    <td class="reforma">R$ ${valorLiqUnit.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                    <td class="reforma">R$ ${valorLiqTot.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                    <td class="reforma">R$ ${ibsCbsUnit.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                    <td class="reforma">R$ ${ibsCbsTot.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                    <td class="reforma">R$ ${totalReformaUnit.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                    <td class="reforma">R$ ${totalReformaTot.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                    <td class="reforma ${difUnit >= 0 ? 'text-danger' : 'text-success'}">R$ ${difUnit.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                    <td class="reforma ${difTotal >= 0 ? 'text-danger' : 'text-success'}">R$ ${difTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                </tr>
            `;
        });
        
        html += `
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="4"><strong>TOTAL (${produtosAgrupados.length} produtos)</strong></td>
                        <td><strong>${totais.quantidade.toFixed(2)}</strong></td>
                        <td>-</td>
                        <td>-</td>
                        <td>-</td>
                        <td><strong>R$ ${totais.valor_bruto.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</strong></td>
                        <td><strong>R$ ${totais.icms.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</strong></td>
                        <td><strong>R$ ${totais.icms_st.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</strong></td>
                        <td><strong>R$ ${totais.ipi.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</strong></td>
                        <td><strong>R$ ${totais.pis.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</strong></td>
                        <td><strong>R$ ${totais.cofins.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</strong></td>
                        <td><strong>R$ ${totais.total_tributos.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</strong></td>
                        <td class="reforma">-</td>
                        <td class="reforma"><strong>R$ ${totais.valor_liq.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</strong></td>
                        <td class="reforma">-</td>
                        <td class="reforma"><strong>R$ ${totais.ibs_cbs.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</strong></td>
                        <td class="reforma">-</td>
                        <td class="reforma"><strong>R$ ${totais.total_reforma.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</strong></td>
                        <td class="reforma">-</td>
                        <td class="reforma ${totais.diferenca >= 0 ? 'text-danger' : 'text-success'}"><strong>R$ ${totais.diferenca.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</strong></td>
                    </tr>
                </tfoot>
            </table>
        `;
        
// Inserir tabela no container
        const container = document.querySelector('#saidas .table-container.full-width .table-scroll');
        if (container) {
            container.innerHTML = html;
        }
        
        // Atualizar cards de m√©tricas
        atualizarMetricasSaidas(totais);
        
        // Salvar produtos no banco de dados automaticamente
        salvarProdutosNoBanco(produtos);
    }
    
    function atualizarMetricasSaidas(totais) {
        // Atualizar cards do Sistema Tribut√°rio Atual
        const vendaBruta = totais.valor_bruto;
        const debitos = totais.total_tributos;
        const vendaLiquida = totais.valor_liq;
        const cargaTributaria = vendaBruta > 0 ? (debitos / vendaBruta * 100) : 0;
        
        // Atualizar cards da Reforma
        const vendaLiquidaReforma = totais.valor_liq;
        const debitosIbsCbs = totais.ibs_cbs;
        const vendaTotalReforma = totais.total_reforma;
        const cargaReforma = vendaLiquidaReforma > 0 ? (debitosIbsCbs / vendaLiquidaReforma * 100) : 0;
        
        // Encontrar e atualizar os cards na se√ß√£o de Sa√≠das
        const saidasTab = document.getElementById('saidas');
        if (saidasTab) {
            const metricCards = saidasTab.querySelectorAll('.metrics-section');
            
            // Primeira se√ß√£o - Sistema Atual
            if (metricCards[0]) {
                const values = metricCards[0].querySelectorAll('.value');
                if (values[0]) values[0].textContent = `R$ ${vendaBruta.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                if (values[1]) values[1].textContent = `R$ ${debitos.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                if (values[2]) values[2].textContent = `R$ ${vendaLiquida.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                if (values[3]) values[3].textContent = `${cargaTributaria.toFixed(2).replace('.', ',')}%`;
            }
            
            // Segunda se√ß√£o - Reforma
            if (metricCards[1]) {
                const values = metricCards[1].querySelectorAll('.value');
                if (values[0]) values[0].textContent = `R$ ${vendaLiquidaReforma.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                if (values[1]) values[1].textContent = `R$ ${debitosIbsCbs.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                if (values[2]) values[2].textContent = `R$ ${vendaTotalReforma.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                if (values[3]) values[3].textContent = `${cargaReforma.toFixed(2).replace('.', ',')}%`;
            }
        }
    }
    async function salvarProdutosNoBanco(produtos) {
        const empresaId = document.getElementById('empresaSelect').value;
        const periodoInicial = document.getElementById('periodoInicialSelect').value;
        const periodoFinal = document.getElementById('periodoFinalSelect').value;
        
        if (!empresaId || !periodoInicial || !periodoFinal || produtos.length === 0) {
            return;
        }
        
        try {
            const response = await fetch('/dashboards/api/salvar-produtos-api/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    empresa_id: empresaId,
                    periodo_inicial: periodoInicial,
                    periodo_final: periodoFinal,
                    produtos: produtos
                })
            });
            
            const data = await response.json();
            if (data.success) {
                console.log(`‚úÖ ${data.qtd_salvos} produtos salvos no banco de dados`);
            } else {
                console.error('Erro ao salvar produtos:', data.message);
            }
        } catch (e) {
            console.error('Erro ao salvar produtos no banco:', e);
        }
    }    
    function exibirRelatorioErros() {
        if (notasComErro.length === 0 && nfceIgnoradas.length === 0) {
            return;
        }
        
        let html = `
            <div class="table-container full-width mt-4">
                <div class="table-header-container">
                    <h2>‚ö†Ô∏è Relat√≥rio de Pend√™ncias</h2>
                </div>
                <div class="table-scroll">
        `;
        
        // NFC-e Ignoradas
        if (nfceIgnoradas.length > 0) {
            html += `
                <h5 class="mt-3 mb-2">üìã NFC-e N√£o Pesquisadas (${nfceIgnoradas.length})</h5>
                <p class="text-muted small">NFC-e (modelo 65) n√£o s√£o consultadas via API externa.</p>
                <table class="table-relatorio">
                    <thead>
                        <tr>
                            <th>N√∫mero</th>
                            <th>Data</th>
                            <th>Valor</th>
                            <th>Chave de Acesso</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            nfceIgnoradas.forEach(nota => {
                html += `
                    <tr>
                        <td>${nota.numero}</td>
                        <td>${nota.data}</td>
                        <td>R$ ${nota.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                        <td><small>${nota.chave_nfe}</small></td>
                    </tr>
                `;
            });
            html += `</tbody></table>`;
        }
        
        // Notas com Erro
        if (notasComErro.length > 0) {
            html += `
                <h5 class="mt-4 mb-2">‚ùå NF-e com Erro na Busca (${notasComErro.length})</h5>
                <table class="table-relatorio">
                    <thead>
                        <tr>
                            <th>N√∫mero</th>
                            <th>Data</th>
                            <th>Valor</th>
                            <th>Erro</th>
                            <th>Chave de Acesso</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            notasComErro.forEach(nota => {
                html += `
                    <tr>
                        <td>${nota.numero}</td>
                        <td>${nota.data}</td>
                        <td>R$ ${nota.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                        <td><span class="badge bg-danger">${nota.erro}</span></td>
                        <td><small>${nota.chave_nfe}</small></td>
                    </tr>
                `;
            });
            html += `</tbody></table>`;
        }
        
        html += `</div></div>`;
        
        // Inserir ap√≥s a tabela de produtos
        const tablesSection = document.querySelector('#saidas .tables-section');
        if (tablesSection) {
            // Remover relat√≥rio anterior se existir
            const relatorioAnterior = document.getElementById('relatorioErrosAPI');
            if (relatorioAnterior) relatorioAnterior.remove();
            
            const div = document.createElement('div');
            div.id = 'relatorioErrosAPI';
            div.innerHTML = html;
            tablesSection.appendChild(div);
        }
    }
    
    // Gr√°fico Carga Tribut√°ria - Compras
    const ctxCargaCompras = document.getElementById('chartCargaCompras');
    if (ctxCargaCompras) {
        new Chart(ctxCargaCompras, {
            type: 'bar',
            data: {
                labels: ['Atual', 'Reforma'],
                datasets: [{
                    label: 'Carga Tribut√°ria (%)',
                    data: [dadosResumo.cargaAtualCompras, dadosResumo.cargaReformaCompras],
                    backgroundColor: [colors.primary, colors.warning],
                    borderRadius: 8,
                    barThickness: 60
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true, ticks: { callback: (value) => value + '%' } } }
            }
        });
    }
    
    // Gr√°fico Carga Tribut√°ria - Vendas
    const ctxCargaVendas = document.getElementById('chartCargaVendas');
    if (ctxCargaVendas) {
        new Chart(ctxCargaVendas, {
            type: 'bar',
            data: {
                labels: ['Atual', 'Reforma'],
                datasets: [{
                    label: 'Carga Tribut√°ria (%)',
                    data: [dadosResumo.cargaAtualVendas, dadosResumo.cargaReformaVendas],
                    backgroundColor: [colors.primary, colors.warning],
                    borderRadius: 8,
                    barThickness: 60
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true, ticks: { callback: (value) => value + '%' } } }
            }
        });
    }
    
    // Gr√°fico Tributos Entradas (Pizza)
    const ctxTributosEntradas = document.getElementById('chartTributosEntradas');
    if (ctxTributosEntradas) {
        new Chart(ctxTributosEntradas, {
            type: 'doughnut',
            data: {
                labels: ['ICMS', 'PIS', 'COFINS', 'IBS/CBS'],
                datasets: [{
                    data: [dadosResumo.icmsEntradas, dadosResumo.pisEntradas, dadosResumo.cofinsEntradas, dadosResumo.ibsCbsEntradas],
                    backgroundColor: [colors.primary, colors.success, colors.warning, colors.pink]
                }]
            },
            options: { responsive: true, maintainAspectRatio: true }
        });
    }
    
    // Gr√°fico Tributos Sa√≠das (Pizza)
    const ctxTributosSaidas = document.getElementById('chartTributosSaidas');
    if (ctxTributosSaidas) {
        new Chart(ctxTributosSaidas, {
            type: 'doughnut',
            data: {
                labels: ['ICMS', 'PIS', 'COFINS', 'IBS/CBS'],
                datasets: [{
                    data: [dadosResumo.icmsSaidas, dadosResumo.pisSaidas, dadosResumo.cofinsSaidas, dadosResumo.ibsCbsSaidas],
                    backgroundColor: [colors.primary, colors.success, colors.warning, colors.pink]
                }]
            },
            options: { responsive: true, maintainAspectRatio: true }
        });
    }
    
    // Gr√°fico Comparativo Entradas
    const ctxComparativoEntradas = document.getElementById('chartComparativoEntradas');
    if (ctxComparativoEntradas) {
        new Chart(ctxComparativoEntradas, {
            type: 'bar',
            data: {
                labels: ['ICMS', 'PIS', 'COFINS', 'IBS/CBS'],
                datasets: [
                    { label: 'Atual', data: [dadosResumo.icmsEntradas, dadosResumo.pisEntradas, dadosResumo.cofinsEntradas, 0], backgroundColor: colors.primary },
                    { label: 'Reforma', data: [0, 0, 0, dadosResumo.ibsCbsEntradas], backgroundColor: colors.warning }
                ]
            },
            options: { responsive: true, maintainAspectRatio: true, plugins: { legend: { position: 'top' } } }
        });
    }
    
    // Gr√°fico Comparativo Sa√≠das
    const ctxComparativoSaidas = document.getElementById('chartComparativoSaidas');
    if (ctxComparativoSaidas) {
        new Chart(ctxComparativoSaidas, {
            type: 'bar',
            data: {
                labels: ['ICMS', 'PIS', 'COFINS', 'IBS/CBS'],
                datasets: [
                    { label: 'Atual', data: [dadosResumo.icmsSaidas, dadosResumo.pisSaidas, dadosResumo.cofinsSaidas, 0], backgroundColor: colors.primary },
                    { label: 'Reforma', data: [0, 0, 0, dadosResumo.ibsCbsSaidas], backgroundColor: colors.warning }
                ]
            },
            options: { responsive: true, maintainAspectRatio: true, plugins: { legend: { position: 'top' } } }
        });
    }
</script>
{% endblock %}